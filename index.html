<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
        }
        /* Custom scrollbar para melhor visualização */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Estilos dos botões de filtro ATIVO */
        .view-filter-active,
        .date-filter-active {
            background-color: #06b6d4 !important; /* cyan-500 */
            color: #ffffff !important;
        }
        /* Estilo da Categoria Ativa (Geral) */
        .category-active {
            background-color: #0891b2 !important; /* cyan-600 */
            color: #ffffff !important;
            font-weight: 600;
        }
        /* Estilo de Destaque da Busca */
        .highlight {
            background-color: #fde047;
            color: #1e293b;
            padding: 0 2px;
            border-radius: 2px;
        }
        /* Estilo para a Categoria Ativa no Dropdown de Mídia */
        .media-dropdown-active {
            background-color: #06b6d4; /* cyan-500 */
            color: #ffffff;
            font-weight: 600;
        }
        /* Animação para o Dropdown */
        .dropdown-menu {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        .dropdown-menu.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        /* Transições */
        #toast {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        #backToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div id="info-banner" role="alert" class="hidden fixed top-5 right-5 w-80 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-50 p-4">
        <button id="close-info-banner" type="button" aria-label="Fechar dicas" class="absolute top-2 right-2 text-slate-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <h3 class="font-bold text-cyan-400 mb-2 text-base">Dicas Rápidas do Radar</h3>
        <ul class="space-y-2 text-sm text-slate-300 list-inside">
            <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <span><b>Busca Inteligente:</b> Basta digitar no campo de busca e os resultados aparecem.</span>
            </li>
            <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                <span><b>Feed 'Para Si':</b> Siga suas editorias favoritas para criar um feed personalizado.</span>
            </li>
        </ul>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-6 relative">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="6" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v10l-4 4"></path>
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-400 mt-2">As últimas notícias sobre os principais assuntos do Brasil.</p>
             <p class="text-sm text-slate-500 mt-1">
                Ferramenta desenvolvida por Estratégia de Dados - 
                <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2 flex justify-center items-center gap-2"></div>
        </header>

        <div class="sticky top-4 bg-slate-800/80 backdrop-blur-sm z-10 p-4 rounded-xl border border-slate-700 shadow-lg mb-8">
            <div id="searchBarWrapper" class="flex flex-wrap items-center justify-center gap-4">
                <div class="flex-grow flex items-center bg-slate-900 rounded-lg p-1 border border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder="Busque enquanto digita..." class="w-full bg-transparent text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    <button id="clearSearchBtn" aria-label="Limpar busca" class="text-slate-500 hover:text-slate-300 transition-colors duration-200 p-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-600 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span id="buttonText">Buscar</span>
                    </button>
                </div>
            </div>

            <div class="flex justify-center items-center mt-4 flex-wrap gap-x-4 gap-y-2">
                <div class="flex items-center gap-2 p-1 rounded-lg">
                    <button id="viewFilterRadar" class="view-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" aria-pressed="true">Últimas Notícias</button>
                    <button id="viewFilterForYou" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700 flex items-center gap-1.5" aria-pressed="false">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118l-2.8-2.034c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" /></svg>
                        Para Si
                    </button>
                    <button id="viewFilterAggregate" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" aria-pressed="false">Conteúdo Agregado</button>
                </div>
                <div id="dateFilterContainer" class="flex items-center gap-2 p-1 rounded-lg">
                    <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" data-date-key="hoje" aria-pressed="true">Hoje</button>
                    <button id="dateFilterLastWeek" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" data-date-key="ultima_semana" aria-pressed="false">Última Semana</button>
                </div>
                
                <div id="mediaFilterDropdown" class="relative">
                    <button id="mediaFilterButton" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2" aria-expanded="false" aria-controls="mediaDropdownMenu">
                        <span id="currentMediaLabel">Mídia: Todos</span>
                        <svg id="mediaDropdownIcon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="mediaDropdownMenu" class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-20 origin-top-right">
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg media-dropdown-active" data-media-key="todos">Todos</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="texto">Notícias 📝</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="video">Vídeo ▶️</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="podcast">Podcast 🎙️</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="refreshButton" aria-label="Atualizar notícias" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-500"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        <span>Atualizar</span>
                    </button>
                    <button id="readingListBtn" aria-label="Abrir lista de leitura" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 012 2z"></path></svg>
                        <span id="savedNewsCountBadge" class="absolute -top-2 -right-2 bg-cyan-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                    </button>
                </div>
            </div>
            <p id="apiError" class="text-center text-red-400 text-sm mt-3 h-4"></p>
        </div>
        
        <div id="radarContainer">
            <div class="lg:grid lg:grid-cols-10 lg:gap-8">
                <div class="lg:col-span-7">
                    <div id="contentCounter" class="text-sm text-slate-400 mb-4 h-5"></div>
                    <div class="mb-8">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-cyan-400">Navegue por Editorial</h2>
                                <button id="clearFollowedBtn" class="hidden text-xs text-red-400 hover:text-red-300 font-semibold transition-colors duration-200">Limpar</button>
                            </div>
                            <div id="categoriesContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6"></main>
                    <div id="messageState" class="hidden text-center py-16">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        <h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3>
                        <p id="messageText" class="text-slate-500">Tente um termo diferente.</p>
                    </div>
                </div>
                <aside class="lg:col-span-3 mt-8 lg:mt-0">
                    <div class="sticky top-28 flex flex-col gap-8 overflow-y-auto max-h-[calc(100vh-8rem)] pr-2">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-cyan-400">Lista de Leitura (<span id="savedNewsCountSidebar">0</span>)</h2>
                                <div><button id="copyListBtn" class="text-xs text-cyan-400 hover:underline">Copiar Lista</button></div>
                            </div>
                            <div id="savedNewsPreviewContainer" class="space-y-2"></div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
        
        <div id="aggregateContainer" class="hidden">
            <h2 class="text-2xl font-bold text-cyan-400 mb-6 text-center">Análise de Cobertura Competitiva</h2>
            <div id="gapAnalysisContainer" class="mb-8 bg-slate-800/50 border border-slate-700 rounded-xl p-6">
                <h3 class="text-xl font-semibold text-amber-400 mb-4">Assuntos em Destaque na Concorrência</h3>
                <div id="gapResults"><p class="text-slate-400 text-center py-4">Funcionalidade Agregada não implementada nesta versão demo.</p></div>
            </div>
        </div>
    </div>
    
    <div id="readingListModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h2 class="text-lg font-bold text-cyan-400">Lista de Leitura</h2>
                <button id="closeReadingListBtn" aria-label="Fechar lista de leitura"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </header>
            <div id="savedNewsContainer" class="flex-grow p-4 overflow-y-auto space-y-2"></div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-transform duration-300">
        <p id="toastMessage"></p>
    </div>
    
    <button id="backToTopBtn" aria-label="Voltar ao topo" class="hidden fixed bottom-5 right-5 bg-cyan-500 hover:bg-cyan-600 text-white p-3 rounded-full shadow-lg opacity-0 transform translate-y-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
    </button>
    
    <script>
    // =================================================================================
    // CÓDIGO FINAL UNIFICADO - RADAR DE NOTÍCIAS (COM SCROLL INFINITO E FILTRO DE MÍDIA REFORÇADO)
    // =================================================================================

    // --- DOM ELEMENTS (Inicialização de Variáveis) ---
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearSearchBtn = document.getElementById('clearSearchBtn'); 
    const buttonText = document.getElementById('buttonText');
    const lastUpdatedElement = document.getElementById('lastUpdated');
    const refreshButton = document.getElementById('refreshButton');
    const backToTopBtn = document.getElementById('backToTopBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const searchBarWrapper = document.getElementById('searchBarWrapper');
    const radarContainer = document.getElementById('radarContainer');
    const aggregateContainer = document.getElementById('aggregateContainer');
    const viewFilterRadar = document.getElementById('viewFilterRadar');
    const viewFilterForYou = document.getElementById('viewFilterForYou');
    const viewFilterAggregate = document.getElementById('viewFilterAggregate');
    const dateFilterContainer = document.getElementById('dateFilterContainer');
    const dateFilterToday = document.getElementById('dateFilterToday');
    const dateFilterLastWeek = document.getElementById('dateFilterLastWeek');
    const mediaFilterDropdown = document.getElementById('mediaFilterDropdown');
    const mediaFilterButton = document.getElementById('mediaFilterButton');
    const mediaDropdownMenu = document.getElementById('mediaDropdownMenu');
    const currentMediaLabel = document.getElementById('currentMediaLabel');
    const mediaDropdownIcon = document.getElementById('mediaDropdownIcon');
    const resultsContainer = document.getElementById('resultsContainer');
    const messageState = document.getElementById('messageState');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const contentCounter = document.getElementById('contentCounter');
    const readingListModal = document.getElementById('readingListModal');
    const closeReadingListBtn = document.getElementById('closeReadingListBtn');
    const savedNewsContainer = document.getElementById('savedNewsContainer');
    const savedNewsCountBadge = document.getElementById('savedNewsCountBadge');
    const savedNewsPreviewContainer = document.getElementById('savedNewsPreviewContainer');
    const copyListBtn = document.getElementById('copyListBtn');
    const savedNewsCountSidebar = document.getElementById('savedNewsCountSidebar');
    const clearFollowedBtn = document.getElementById('clearFollowedBtn');

    // --- APP STATE (Estado Global) ---
    let currentAppView = 'radar';
    let currentRadarView = 'geral';
    let currentDateFilter = 'hoje'; 
    let currentMediaFilter = 'todos'; 
    let masterNewsCache = [];
    let savedNews = [];
    let followedTopics = [];
    let currentPage = 1;
    const itemsPerPage = 20; // Itens carregados por página/scroll
    let isLoadingMore = false;
    let currentCategorySearch = null;

    // --- CONSTANTS & CONFIGS ---
    const mainCategories = ['Todas', 'Política', 'Economia', 'Esportes', 'Cultura', 'Saúde', 'Mundo', 'Horóscopo', 'Entretenimento', 'Ciência', 'Educação', 'Viagem', 'Gastronomia', 'Carros', 'Imóveis', 'Música', 'Cinema', 'Moda', 'Meio Ambiente'];
    
    const MEDIA_FORMATS = {
        'todos': { label: 'Todos', emoji: '' },
        'texto': { label: 'Notícias', emoji: '📝' },
        'video': { label: 'Vídeo', emoji: '▶️' },
        'podcast': { label: 'Podcast', emoji: '🎙️' }
    };
    
    const categoryColorMap = {
        'Todas': 'border-slate-400', 'Política': 'border-blue-500', 'Economia': 'border-emerald-500', 'Esportes': 'border-red-500', 'Cultura': 'border-yellow-500', 'Saúde': 'border-pink-500', 'Mundo': 'border-sky-500', 'Horóscopo': 'border-orange-500', 'Entretenimento': 'border-teal-500', 'Ciência': 'border-lime-500', 'Educação': 'border-rose-500', 'Viagem': 'border-indigo-500', 'Gastronomia': 'border-amber-500', 'Carros': 'border-slate-500', 'Imóveis': 'border-gray-500', 'Música': 'border-pink-400', 'Cinema': 'border-yellow-400', 'Moda': 'border-rose-400', 'Meio Ambiente': 'border-green-500'
    };
    
    const categoryButtonColors = [
        'bg-blue-600 hover:bg-blue-500', 'bg-emerald-600 hover:bg-emerald-500', 'bg-red-600 hover:bg-red-500', 'bg-yellow-600 hover:bg-yellow-500', 'bg-pink-600 hover:bg-pink-500', 'bg-sky-600 hover:bg-sky-500', 'bg-orange-600 hover:bg-orange-500', 'bg-teal-600 hover:bg-teal-500', 'bg-lime-600 hover:bg-lime-500', 'bg-rose-600 hover:bg-rose-500', 'bg-indigo-600 hover:bg-indigo-500', 'bg-amber-600 hover:bg-amber-500', 'bg-slate-600 hover:bg-slate-500', 'bg-pink-400 hover:bg-pink-300', 'bg-yellow-400 hover:bg-yellow-300', 'bg-rose-400 hover:bg-rose-300', 'bg-green-600 hover:bg-green-500' 
    ];
    const lightBgClasses = ['bg-lime-600', 'bg-pink-400', 'bg-yellow-400']; 
    
    // --- LÓGICA DE CLASSIFICAÇÃO DE MÍDIA ---
    
    /**
     * Tenta determinar o tipo de mídia (texto, vídeo, podcast) baseado no título e URL.
     */
    function determineMediaType(title, url) {
        const titleLower = title.toLowerCase();
        const urlLower = url.toLowerCase();

        // 1. Palavras-chave no título (indicadores fortes)
        if (titleLower.includes('vídeo') || titleLower.includes('assista') || titleLower.includes('galeria') || titleLower.includes('imagens') || titleLower.includes('live') || titleLower.includes('ao vivo') || titleLower.includes('tv')) {
            return 'video';
        }
        if (titleLower.includes('podcast') || titleLower.includes('áudio') || titleLower.includes('ouça') || titleLower.includes('spotify') || titleLower.includes('cast')) {
            return 'podcast';
        }
        
        // 2. Domínios e padrões de URL (reforço para vídeos e áudio)
        if (urlLower.includes('youtube.com') || urlLower.includes('vimeo.com') || urlLower.includes('/videos/') || urlLower.includes('/video/') || urlLower.includes('/tv/') || urlLower.includes('globo.com/videos/') || urlLower.includes('recordtv.r7.com') || urlLower.includes('band.com.br/videos')) {
            return 'video';
        }
        if (urlLower.includes('soundcloud.com') || urlLower.includes('/podcasts/') || urlLower.includes('g1.globo.com/podcast') || urlLower.includes('anchor.fm')) {
            return 'podcast';
        }

        return 'texto';
    }

    // --- FUNÇÕES DE FETCH E MAPEAMENTO DE DADOS ---

    function mapGoogleNewsData(item, categoryTag = null) {
        const getSourceName = (sourceString) => { 
            if (!sourceString) return 'Fonte Desconhecida'; 
            const tempDiv = document.createElement('div'); 
            tempDiv.innerHTML = sourceString; 
            const text = tempDiv.textContent || tempDiv.innerText || ""; 
            const parts = text.split(' - '); 
            return parts[parts.length - 1].trim(); 
        };
        let sourceDomain = 'news.google.com';
        try { 
            if (item.sourceUrl && typeof item.sourceUrl === 'string') { 
                sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', ''); 
            } 
        } catch (e) { 
            // Ignora erros de URL, usa valor padrão
        }
        
        const bestCategory = categoryTag && categoryTag !== 'Todas' ? categoryTag : 'Geral'; 
        const mediaType = determineMediaType(item.title, item.link); 
        
        return { 
            source: 'googlenews', 
            title: item.title, 
            timestamp: new Date(item.pubDate).getTime(), 
            url: item.link, 
            description: item.content, 
            sourceName: getSourceName(item.title), 
            sourceDomain: sourceDomain, 
            category: bestCategory, 
            mediaType: mediaType 
        };
    }

    /**
     * Busca notícias do Google News via RSS com reforço para conteúdos de vídeo.
     */
    async function fetchFromGoogleNewsAPI(query = null) {
        const fetchAndParse = async (searchUrl, categoryTag) => {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) { console.warn(`Falha ao buscar notícias de: ${searchUrl}`); return []; }
                const textData = await response.text(); 
                if (!textData) return [];
                
                const parser = new DOMParser(); 
                const xmlDoc = parser.parseFromString(textData, "application/xml");
                const items = xmlDoc.querySelectorAll("item"); 
                const newsResults = [];
                
                items.forEach(item => { 
                    const sourceElement = item.querySelector("source"); 
                    newsResults.push({ 
                        title: item.querySelector("title").textContent, 
                        link: item.querySelector("link").textContent, 
                        sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent, 
                        pubDate: item.querySelector("pubDate").textContent, 
                        description: item.querySelector("description")?.textContent 
                    }); 
                });
                return newsResults.map(item => mapGoogleNewsData(item, categoryTag));
            } catch (error) { 
                console.error(`Erro no fetch para ${searchUrl}:`, error); 
                return []; 
            }
        };

        let combinedNews = [];

        if (query) {
            const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
            combinedNews = await fetchAndParse(searchUrl, query);
        } else { 
            const categories = ['Brasil', 'Mundo', 'Política', 'Economia', 'Esportes', 'Ciência', 'Cultura', 'Entretenimento', 'Saúde', 'Tecnologia']; 
            
            const categoryPromises = categories.map(cat => {
                const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(cat)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                return fetchAndParse(searchUrl, cat);
            });
            
            // BUSCA REFORÇADA PARA VÍDEOS E PODCASTS DE TODOS OS PORTAIS
            const mediaQueries = [
                'site:youtube.com "ao vivo" OR site:youtube.com "live"',
                'vídeo de notícia Brasil OR site:g1.globo.com/videos OR site:r7.com/videos OR site:band.com.br/videos OR site:uol.com.br/videos',
                'podcast OR audio OR "programa de rádio"'
            ];

            const mediaPromises = mediaQueries.map(mq => {
                const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(mq)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                return fetchAndParse(searchUrl, 'Mídia Digital');
            });


            const allResults = await Promise.all([...categoryPromises, ...mediaPromises]);
            combinedNews = allResults.flat();
        }

        const uniqueNews = new Map();
        combinedNews.forEach(news => { 
            if (!uniqueNews.has(news.url)) { 
                uniqueNews.set(news.url, news); 
            } 
        }); 
        return Array.from(uniqueNews.values()).sort((a, b) => b.timestamp - a.timestamp);
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO E FILTRO ---

    function getMediaIconAndColor(mediaType) {
        return MEDIA_FORMATS[mediaType] || MEDIA_FORMATS['texto'];
    }

    function updateMediaDropdown(filterKey) {
        const mediaInfo = getMediaIconAndColor(filterKey);
        currentMediaLabel.textContent = `Mídia: ${mediaInfo.label} ${mediaInfo.emoji}`;

        mediaDropdownMenu.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('media-dropdown-active');
        });
        const activeBtn = mediaDropdownMenu.querySelector(`[data-media-key="${filterKey}"]`);
        if(activeBtn) activeBtn.classList.add('media-dropdown-active');
    }

    const applyMediaFilter = (items, filterKey) => {
        if (filterKey === 'todos') {
            return items;
        }
        return items.filter(item => item.mediaType === filterKey);
    };

    /**
     * Renderiza os cards de notícia na tela, aplicando todos os filtros e a paginação/scroll infinito.
     */
    function renderRadarResults(append = false) {
        if (!append) { 
            resultsContainer.innerHTML = ''; 
            currentPage = 1;
        }
        
        let filteredNews = applyDateFilter(masterNewsCache, currentDateFilter);
        filteredNews = applyMediaFilter(filteredNews, currentMediaFilter); 

        if (currentRadarView === 'paraSi') {
            if (followedTopics.length === 0) {
                 messageState.classList.remove('hidden'); messageTitle.textContent = 'Comece a seguir tópicos!'; messageText.textContent = 'Clique nas editorias para personalizar o seu feed.';
                 contentCounter.textContent = ''; resultsContainer.innerHTML = ''; return;
            }
            filteredNews = filteredNews.filter(news => { 
                const titleLower = news.title.toLowerCase(); 
                const categoryLower = news.category ? news.category.toLowerCase() : ''; 
                return followedTopics.some(topic => { 
                    const topicLower = topic.toLowerCase(); 
                    return titleLower.includes(topicLower) || categoryLower.includes(topicLower); 
                }); 
            });
        }
        
        const totalItems = filteredNews.length; 
        const startIndex = (currentPage - 1) * itemsPerPage; 
        const endIndex = startIndex + itemsPerPage; 
        const paginatedItems = filteredNews.slice(startIndex, endIndex);
        
        if (paginatedItems.length === 0 && currentPage === 1) {
            messageState.classList.remove('hidden'); 
            messageTitle.textContent = 'Nenhuma notícia encontrada.'; 
            messageText.textContent = currentRadarView === 'paraSi' ? 'Não há resultados para seus tópicos seguidos e filtros atuais.' : 'Tente um termo diferente ou ajuste os filtros.';
            contentCounter.textContent = ''; 
            return;
        }
        
        messageState.classList.add('hidden');
        paginatedItems.forEach(item => { resultsContainer.appendChild(createGoogleNewsCard(item)); });
        contentCounter.textContent = `Exibindo ${resultsContainer.children.length} de ${totalItems} notícias.`;
        isLoadingMore = false; 
    }
    
    /**
     * Cria o elemento HTML (card) de uma notícia. (mantido como está)
     */
    function createGoogleNewsCard(news) {
        const newsElement = document.createElement('div');
        
        const primaryCategory = news.category === 'Geral' ? 'Todas' : news.category.split(' > ')[0];
        const borderColorClass = categoryColorMap[primaryCategory] || 'border-cyan-500';
        const categoryIndex = mainCategories.indexOf(primaryCategory); 
        let categoryColorClass = 'bg-slate-700'; 
        let categoryTextColorClass = 'text-white';
        
        if (categoryIndex > 0) { 
            const colorClass = categoryButtonColors[(categoryIndex - 1) % categoryButtonColors.length];
            categoryColorClass = colorClass.split(' ')[0]; 
            const isLightBg = lightBgClasses.some(lightClass => colorClass.includes(lightClass)); 
            categoryTextColorClass = isLightBg ? 'text-slate-900' : 'text-white'; 
        } else if (primaryCategory === 'Todas') {
            categoryColorClass = 'bg-slate-700'; 
        }
        
        const newsDateTime = new Date(news.timestamp);
        const newsDate = newsDateTime.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const newsTime = newsDateTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const fullDateTime = `${newsDate} às ${newsTime}`;
        const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
        const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
        const isSaved = savedNews.some(saved => saved.url === news.url);
        const saveButtonIcon = isSaved 
            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>` 
            : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
        const searchTerm = searchInput.value.trim();
        let finalTitle = news.title;
        
        if (searchTerm) { 
            const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); 
            finalTitle = finalTitle.replace(regex, `<span class="highlight">$1</span>`); 
        }
        
        const categoryHTML = `<span class="text-xs font-medium ${categoryColorClass} ${categoryTextColorClass} px-2 py-1 rounded-full">${primaryCategory}</span>`;
        const mediaInfo = getMediaIconAndColor(news.mediaType);
        const mediaTag = `<span class="text-lg text-slate-300 ml-1" title="${mediaInfo.label}">${mediaInfo.emoji}</span>`; 
        
        newsElement.className = `bg-slate-800 border-l-4 ${borderColorClass} rounded-r-lg p-5 shadow-lg flex flex-col gap-4 transform hover:scale-[1.01] transition-transform duration-300`; 
        
        newsElement.innerHTML = `
            <div class="flex justify-between items-start">
                <a href="${news.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 overflow-hidden">
                    <img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`">
                    <div class="truncate">
                        <p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p>
                    </div>
                </a>
                <div class="flex items-center gap-2">
                    <button class="save-btn" data-url="${news.url}" aria-label="Salvar notícia">${saveButtonIcon}</button>
                </div>
            </div>
            <div>
                <a href="${news.url}" target="_blank" rel="noopener noreferrer">
                    <p class="text-slate-300 font-semibold leading-relaxed mb-2">${finalTitle} ${mediaTag}</p>
                </a>
            </div>
            <div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50">
                <div class="flex flex-wrap gap-2">
                    ${categoryHTML}
                </div>
                <span class="text-xs text-slate-500">${fullDateTime}</span>
            </div>
        `;
        newsElement.querySelector('.save-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); handleSaveNews(news, e.currentTarget); });
        return newsElement;
    }
    
    // --- FUNÇÕES DE LÓGICA DE INTERFACE (mantido como está) ---
    
    function handleDateFilterChange(filterKey, buttonElement) {
        currentDateFilter = filterKey;
        dateFilterContainer.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('date-filter-active');
            btn.setAttribute('aria-pressed', 'false');
            btn.classList.add('text-slate-300', 'hover:bg-slate-700');
        });
        buttonElement.classList.add('date-filter-active');
        buttonElement.classList.remove('text-slate-300', 'hover:bg-slate-700');
        buttonElement.setAttribute('aria-pressed', 'true');
        renderRadarResults();
    }
    
    const applyDateFilter = (items, filterKey) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        const filterFn = {
            'hoje': (item) => new Date(item.timestamp) >= today,
            'ultima_semana': (item) => {
                const weekAgoStart = new Date(today);
                weekAgoStart.setDate(weekAgoStart.getDate() - 7); 
                const itemDate = new Date(item.timestamp);
                return itemDate >= weekAgoStart && itemDate < today;
            }
        };
        return filterFn[filterKey] ? items.filter(filterFn[filterKey]) : items;
    };
    
    function renderSavedNews() {
        savedNewsContainer.innerHTML = ''; 
        savedNewsCountSidebar.textContent = savedNews.length; savedNewsCountBadge.textContent = savedNews.length; savedNewsPreviewContainer.innerHTML = '';
        if (savedNews.length === 0) { const emptyMsg = `<p class="text-sm text-center text-slate-400 p-4">Nenhuma notícia salva.</p>`; savedNewsContainer.innerHTML = emptyMsg; savedNewsPreviewContainer.innerHTML = emptyMsg; return; }
        
        // Renderiza lista completa no modal
        savedNews.forEach(news => { 
            const savedItem = document.createElement('div'); 
            savedItem.className = 'flex items-center justify-between gap-2 p-2 rounded-lg hover:bg-slate-700'; 
            savedItem.innerHTML = `<a href="${news.url}" target="_blank" class="text-sm text-slate-300 truncate" title="${news.title}">${news.title}</a><button class="remove-saved-btn flex-shrink-0" data-url="${news.url}" aria-label="Remover notícia"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; 
            savedNewsContainer.appendChild(savedItem); 
        });
        
        // Renderiza pré-visualização na sidebar
        savedNews.slice(0, 15).forEach(news => { 
            const savedItem = document.createElement('div'); 
            savedItem.className = 'flex items-center justify-between gap-2 p-1 rounded-lg hover:bg-slate-700'; 
            savedItem.innerHTML = `<a href="${news.url}" target="_blank" class="text-sm text-slate-300 truncate" title="${news.title}">${news.title}</a><button class="remove-saved-btn flex-shrink-0" data-url="${news.url}" aria-label="Remover notícia"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; 
            savedNewsPreviewContainer.appendChild(savedItem); 
        });
        
        document.querySelectorAll('.remove-saved-btn').forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); handleRemoveNews(button.dataset.url); }); });
    }
    
    function renderCategories() {
        categoriesContainer.innerHTML = '';
        clearFollowedBtn.classList.add('hidden'); 
        mainCategories.forEach((category, index) => {
            if (currentRadarView === 'paraSi' && category === 'Todas') { return; }
            
            const categoryButton = document.createElement('button');
            const isFollowed = followedTopics.includes(category);
            let buttonClass;
            
            if (currentRadarView === 'geral') {
                if (index === 0) { buttonClass = 'bg-slate-700/50 hover:bg-slate-700 text-slate-300 hover:text-white'; } 
                else {
                    const colorIndex = index - 1;
                    const colorClass = categoryButtonColors[colorIndex % categoryButtonColors.length];
                    const isLightBg = lightBgClasses.some(lightClass => colorClass.includes(lightClass));
                    const textColorClass = isLightBg ? 'text-black' : 'text-white';
                    buttonClass = `${colorClass} ${textColorClass}`;
                }
            } else { 
                const colorIndex = index > 0 ? index - 1 : 0; 
                if (isFollowed) { buttonClass = 'category-followed'; } 
                else {
                    const colorClass = categoryButtonColors[colorIndex % categoryButtonColors.length];
                    buttonClass = `${colorClass.replace('bg-', 'hover:bg-').replace('hover:bg-', 'border-')}/50 text-slate-300 hover:text-white border`; 
                }
            }
            
            categoryButton.className = `${buttonClass} text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`;
            categoryButton.textContent = category;
            
            if (currentRadarView === 'geral' && (currentCategorySearch === category || (!currentCategorySearch && category === 'Todas'))) {
                categoryButton.classList.add('category-active');
            }
            
            categoryButton.onclick = () => {
                if (currentRadarView === 'paraSi') {
                    // Lógica de seguir/deixar de seguir
                    const topicIndex = followedTopics.indexOf(category);
                    if (topicIndex > -1) {
                        followedTopics.splice(topicIndex, 1);
                        showToast(`Deixou de seguir "${category}"`);
                    } else {
                        followedTopics.push(category);
                        showToast(`Agora segue "${category}"`);
                    }
                    localStorage.setItem('followedTopics', JSON.stringify(followedTopics));
                    renderCategories();
                    if (currentRadarView === 'paraSi') { renderRadarResults(); }
                } else if (currentRadarView === 'geral') {
                    // Lógica de filtro por categoria
                    handleSearch(searchInput.value, category === 'Todas' ? null : category);
                    document.querySelectorAll('#categoriesContainer button').forEach(btn => btn.classList.remove('category-active'));
                    categoryButton.classList.add('category-active');
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            categoriesContainer.appendChild(categoryButton);
        });
        if (currentRadarView === 'paraSi' && followedTopics.length > 0) {
            clearFollowedBtn.classList.remove('hidden');
        }
    }

    function showToast(message) {
        toastMessage.textContent = message;
        toast.classList.remove('opacity-0', 'translate-y-20');
        toast.classList.add('opacity-100', 'translate-y-0');
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-20');
            toast.classList.remove('opacity-100', 'translate-y-0');
        }, 3000);
    }
    
    function setLoading(isLoading, isInitialLoad = true) {
        if(isLoading) {
            searchButton.disabled = true; 
            buttonText.textContent = "Buscando..."; 
            if (isInitialLoad) {
                messageState.classList.add('hidden'); 
                resultsContainer.innerHTML = '';
                // Simulação de Cards de Loading
                for(let i = 0; i < 6; i++) { resultsContainer.innerHTML += `<div class="bg-slate-800 border-l-4 border-slate-700 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 animate-pulse"><div class="flex justify-between items-start"><div class="flex items-center gap-3 w-1/2"><div class="w-6 h-6 rounded-md bg-slate-700"></div><div class="h-4 bg-slate-700 rounded w-full"></div></div><div class="h-6 w-12 bg-slate-700 rounded-full"></div></div><div><div class="h-5 bg-slate-700 rounded w-full mb-2"></div><div class="h-5 bg-slate-700 rounded w-3/4"></div></div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50"><div class="h-5 w-20 bg-slate-700 rounded-full"></div><div class="h-4 w-24 bg-slate-700 rounded"></div></div></div>`; }
            }
        } else {
            searchButton.disabled = false; 
            buttonText.textContent = "Buscar";
        }
    }
    
    // --- LÓGICA DE APLICAÇÃO (LOAD E EVENTOS) ---
    
    async function loadInitialContent(isAutoRefresh = false) {
        if (!isAutoRefresh) { setLoading(true, true); }
        masterNewsCache = await fetchFromGoogleNewsAPI();
        if (!isAutoRefresh) { setLoading(false, true); }
        renderRadarResults();
        updateTimestamp();
    }
    
    async function handleSearch(queryValue, category = null) {
        setLoading(true);
        currentCategorySearch = category;
        const query = category !== null ? category : queryValue;
        
        masterNewsCache = await fetchFromGoogleNewsAPI(query.trim() === '' ? null : query);
        
        setLoading(false);
        renderRadarResults();
        renderCategories(); 
    }

    function handleMediaFilterChange(filterKey) {
        currentMediaFilter = filterKey;
        updateMediaDropdown(filterKey);
        mediaDropdownMenu.classList.add('hidden');
        mediaFilterButton.setAttribute('aria-expanded', 'false');
        mediaDropdownIcon.classList.remove('rotate-180');
        renderRadarResults();
    }
    
    function updateTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        lastUpdatedElement.innerHTML = `<span>Atualizado às ${timeString}</span> <span class="text-slate-500/70">(auto-refresh a cada 20 min)</span>`;
    }

    function handleSaveNews(newsItem, buttonElement) {
        const isAlreadySaved = savedNews.some(item => item.url === newsItem.url);
        if (isAlreadySaved) {
            savedNews = savedNews.filter(item => item.url !== newsItem.url);
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
            showToast('Notícia removida da lista!');
        } else {
            savedNews.push(newsItem);
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>`;
            showToast('Notícia salva!');
        }
        localStorage.setItem('savedNews', JSON.stringify(savedNews));
        renderSavedNews();
    }
    
    function updateClearSearchButton() {
        if (searchInput.value.trim().length > 0) {
            clearSearchBtn.classList.remove('hidden');
        } else {
            clearSearchBtn.classList.add('hidden');
        }
    }
    
    // --- SCROLL INFINITO REATIVADO ---
    function handleScroll() {
        // Lógica de Paginação (Carregar Mais)
        if (currentAppView === 'radar' && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isLoadingMore) {
            const totalItems = applyMediaFilter(applyDateFilter(masterNewsCache, currentDateFilter), currentMediaFilter).length;
            if (currentPage * itemsPerPage < totalItems) {
                isLoadingMore = true;
                currentPage++;
                renderRadarResults(true); 
            }
        }
        // Lógica do botão Voltar ao Topo
        if (window.scrollY > 300) {
            backToTopBtn.classList.remove('hidden', 'opacity-0', 'translate-y-20');
            backToTopBtn.classList.add('opacity-100', 'translate-y-0');
        } else {
            backToTopBtn.classList.add('opacity-0', 'translate-y-20');
            setTimeout(() => backToTopBtn.classList.add('hidden'), 300);
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        // Carrega estado salvo do LocalStorage
        const storedNews = localStorage.getItem('savedNews');
        if (storedNews) { savedNews = JSON.parse(storedNews); }
        const storedTopics = localStorage.getItem('followedTopics');
        if (storedTopics) { followedTopics = JSON.parse(storedTopics); }
        
        // Inicializa a UI
        updateMediaDropdown(currentMediaFilter);
        renderSavedNews();
        renderCategories();
        
        // Inicia o carregamento de conteúdo
        loadInitialContent();
        
        // Auto-Refresh a cada 20 minutos
        setInterval(() => {
            loadInitialContent(true);
            showToast('Notícias atualizadas automaticamente!');
        }, 20 * 60 * 1000); 

        // --- EVENT LISTENERS GERAIS ---
        
        // Eventos do Dropdown de Mídia
        mediaFilterButton.addEventListener('click', (e) => {
            e.stopPropagation(); 
            const isExpanded = mediaFilterButton.getAttribute('aria-expanded') === 'true';
            mediaFilterButton.setAttribute('aria-expanded', !isExpanded);
            mediaDropdownMenu.classList.toggle('hidden', isExpanded);
            mediaDropdownIcon.classList.toggle('rotate-180', !isExpanded);
        });

        mediaDropdownMenu.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', (e) => {
                const filterKey = e.currentTarget.getAttribute('data-media-key');
                handleMediaFilterChange(filterKey);
            });
        });

        // Fecha o dropdown se clicar fora
        document.addEventListener('click', (e) => {
            if (mediaFilterDropdown && !mediaFilterDropdown.contains(e.target)) {
                mediaDropdownMenu.classList.add('hidden');
                mediaFilterButton.setAttribute('aria-expanded', 'false');
                mediaDropdownIcon.classList.remove('rotate-180');
            }
        });

        // Eventos de Visão e Busca
        viewFilterRadar.addEventListener('click', () => { currentRadarView = 'geral'; setView('radar'); handleSearch(searchInput.value, null); });
        viewFilterForYou.addEventListener('click', () => { currentRadarView = 'paraSi'; setView('radar'); renderRadarResults(); });
        viewFilterAggregate.addEventListener('click', () => { setView('aggregate'); }); 

        searchButton.addEventListener('click', () => handleSearch(searchInput.value, null));
        
        // Debounce para a busca em tempo real
        searchInput.addEventListener('input', () => { 
            updateClearSearchButton(); 
            const debounce = (func, delay = 500) => {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            };
            debounce(() => handleSearch(searchInput.value, null), 500)();
        });
        clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; updateClearSearchButton(); handleSearch('', null); });
        
        // Eventos de Data e Ação
        dateFilterToday.addEventListener('click', (e) => handleDateFilterChange('hoje', e.currentTarget));
        dateFilterLastWeek.addEventListener('click', (e) => handleDateFilterChange('ultima_semana', e.currentTarget));
        refreshButton.addEventListener('click', () => { searchInput.value = ''; loadInitialContent(); });
        readingListBtn.addEventListener('click', () => readingListModal.classList.remove('hidden'));
        closeReadingListBtn.addEventListener('click', () => readingListModal.classList.add('hidden'));
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        
        // Outros Listeners
        document.getElementById('clearFollowedBtn').addEventListener('click', () => { followedTopics = []; localStorage.removeItem('followedTopics'); renderCategories(); renderRadarResults(); showToast('Tópicos seguidos limpos.'); });
        document.getElementById('copyListBtn').addEventListener('click', () => {
            const listText = savedNews.map((n, i) => `${i + 1}. [${n.title}](${n.url}) - ${n.sourceName}`).join('\n');
            navigator.clipboard.writeText(listText).then(() => showToast('Lista copiada para a área de transferência!'));
        });
        
        // Evento de Scroll para paginação e botão "Voltar ao Topo"
        window.addEventListener('scroll', handleScroll);
    });
    </script>
</body>
</html>
