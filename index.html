<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; } /* slate-800 */
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; } /* slate-600 */
        ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* slate-500 */
        .loader {
            border-top-color: #06b6d4;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .date-filter-active {
            background-color: #06b6d4;
            color: #ffffff;
        }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-6">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.465 14.535a6.002 6.002 0 018.07 0M5.93 12.005a10.002 10.002 0 0112.14 0" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01" />
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-400 mt-2">As últimas notícias sobre os principais assuntos do Brasil.</p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2"></div>
        </header>

        <!-- Control Panel Menu -->
        <div class="sticky top-4 bg-slate-800/80 backdrop-blur-sm z-10 p-4 rounded-xl border border-slate-700 shadow-lg mb-8">
            <div class="flex flex-wrap items-center justify-center gap-4">
                
                <div class="flex-grow flex items-center gap-4 bg-slate-900 rounded-lg p-1 border border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder="Busque por um assunto..." class="w-full bg-transparent text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    
                    <select id="portalFilter" class="bg-slate-800 border border-slate-700 text-slate-300 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5">
                        <option selected value="">Todos os Portais</option>
                        <option value="g1.globo.com">G1</option>
                        <option value="uol.com.br">UOL</option>
                        <option value="folha.uol.com.br">Folha de S.Paulo</option>
                        <option value="estadao.com.br">Estadão</option>
                        <option value="r7.com">R7</option>
                        <option value="cnnbrasil.com.br">CNN Brasil</option>
                        <option value="terra.com.br">Terra</option>
                        <option value="valor.globo.com">Valor Econômico</option>
                        <option value="metropoles.com">Metrópoles</option>
                    </select>

                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-600 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span id="buttonText">Buscar</span>
                    </button>
                </div>

            </div>

            <!-- Date Filter -->
            <div class="flex justify-center items-center gap-2 mt-4">
                <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200 bg-cyan-600">Hoje</button>
                <button id="dateFilterYesterday" class="text-slate-300 text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700">Ontem</button>
                <button id="dateFilterWeek" class="text-slate-300 text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700">Última Semana</button>
            </div>
            
            <p id="apiError" class="text-center text-red-400 text-sm mt-3 h-4"></p>
        </div>
        
        <!-- Main Content Area -->
        <div class="lg:grid lg:grid-cols-12 lg:gap-8">
            <div class="lg:col-span-8 xl:col-span-9">
                <div id="loadingState" class="hidden text-center py-16">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-700 h-12 w-12 mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-slate-300">Buscando notícias...</h3>
                </div>

                <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
                    <!-- News will be dynamically inserted here -->
                </main>

                <!-- Pagination Controls -->
                <div id="paginationControls" class="hidden flex justify-center items-center gap-4 mt-8">
                    <button id="prevPageBtn" class="bg-slate-700/50 hover:bg-slate-700 text-slate-200 font-semibold px-4 py-2 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Voltar</button>
                    <span id="pageIndicator" class="text-slate-400 text-sm font-medium"></span>
                    <button id="nextPageBtn" class="bg-slate-700/50 hover:bg-slate-700 text-slate-200 font-semibold px-4 py-2 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Avançar</button>
                </div>
                
                <div id="messageState" class="hidden text-center py-16">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    <h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3>
                    <p id="messageText" class="text-slate-500">Tente um termo diferente.</p>
                </div>
            </div>

            <!-- Sidebar Sections -->
            <aside class="lg:col-span-4 xl:col-span-3 mt-8 lg:mt-0">
                <div class="sticky top-28 flex flex-col gap-8">
                    <!-- Trending Topics Section -->
                    <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                        <h2 class="text-lg font-bold text-cyan-400 mb-4">Principais Assuntos Hoje</h2>
                        <div id="trendingTopicsContainer" class="flex flex-col">
                            <div class="text-center text-slate-400 p-4">Carregando tópicos...</div>
                        </div>
                    </div>

                    <!-- Categories Section -->
                    <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                        <h2 class="text-lg font-bold text-cyan-400 mb-4">Navegue por Editoria</h2>
                        <div id="categoriesContainer" class="flex flex-wrap gap-2">
                            <!-- Category buttons will be inserted here -->
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <footer class="text-center py-4 mt-8 border-t border-slate-700">
            <p class="text-sm text-slate-500">
                Ferramenta desenvolvida por Estratégia de Dados - 
                <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const resultsContainer = document.getElementById('resultsContainer');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const portalFilter = document.getElementById('portalFilter');
        const buttonText = document.getElementById('buttonText');
        const messageState = document.getElementById('messageState');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const loadingState = document.getElementById('loadingState');
        const apiError = document.getElementById('apiError');
        const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
        const categoriesContainer = document.getElementById('categoriesContainer');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const dateFilterToday = document.getElementById('dateFilterToday');
        const dateFilterYesterday = document.getElementById('dateFilterYesterday');
        const dateFilterWeek = document.getElementById('dateFilterWeek');
        const paginationControls = document.getElementById('paginationControls');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageIndicator = document.getElementById('pageIndicator');

        // App State
        let currentDateFilter = 'hoje'; // 'hoje', 'ontem', 'semana'
        let allNewsCache = []; // Cache news to avoid re-fetching
        let currentPage = 1;
        const itemsPerPage = 20;

        // --- MAPPING HELPERS ---
        function mapGoogleNewsData(item) {
            const getSourceName = (sourceString) => {
                if (!sourceString) return 'Fonte Desconhecida';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = sourceString;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                const parts = text.split(' - ');
                return parts[parts.length - 1].trim();
            };

            let sourceDomain = 'news.google.com'; // A safe default
            try {
                if (item.sourceUrl && typeof item.sourceUrl === 'string') {
                    sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', '');
                }
            } catch (e) {
                console.error("Could not parse source URL:", item.sourceUrl, e);
            }

            return {
                source: 'googlenews',
                title: item.title,
                timestamp: new Date(item.pubDate).getTime(),
                url: item.link,
                description: item.content,
                sourceName: getSourceName(item.title),
                sourceDomain: sourceDomain
            };
        }
        
        // --- API FETCHER ---
        async function fetchFromGoogleNewsAPI(query = null) {
             const searchUrl = query 
                ? `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`
                : `https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419`;

             const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
             const response = await fetch(proxyUrl);
             if (!response.ok) throw new Error('Falha ao buscar notícias do Google.');
             
             const data = await response.json();
             if(!data.contents) throw new Error('Proxy não retornou conteúdo válido.');
             
             const parser = new DOMParser();
             const xmlDoc = parser.parseFromString(data.contents, "application/xml");
             const items = xmlDoc.querySelectorAll("item");
             
             const newsResults = [];
             items.forEach(item => {
                const sourceElement = item.querySelector("source");
                newsResults.push({
                    title: item.querySelector("title").textContent,
                    link: item.querySelector("link").textContent,
                    sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent,
                    pubDate: item.querySelector("pubDate").textContent,
                    content: item.querySelector("description").textContent
                });
             });
             return newsResults.map(mapGoogleNewsData);
        }

        async function fetchTrendingTopics() {
            try {
                const news = await fetchFromGoogleNewsAPI();
                
                const topics = news.slice(0, 10).map(item => {
                    const fullTitle = item.title.split(' - ')[0];
                    const words = fullTitle.split(/\s+/);
                    const truncatedTitle = words.slice(0, 4).join(' ');
                    
                    return {
                        full: fullTitle,
                        truncated: words.length > 4 ? truncatedTitle + '...' : truncatedTitle
                    };
                });
                
                renderTrendingTopics(topics);

            } catch (error) {
                console.error("Trending Topics Error:", error);
                trendingTopicsContainer.innerHTML = `<p class="text-sm text-red-400">Não foi possível carregar os tópicos.</p>`;
            }
        }

        async function loadInitialContent() {
            setLoading(true);
            try {
                const news = await fetchFromGoogleNewsAPI();
                allNewsCache = news;
                renderResults();
                updateTimestamp();
            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }

        // --- RENDERERS & FILTERS ---
        function applyDateFilter(items, filter) {
            const todayStart = new Date(new Date().setHours(0, 0, 0, 0));

            switch (filter) {
                case 'hoje':
                    return items.filter(item => new Date(item.timestamp) >= todayStart);
                case 'ontem':
                    const yesterdayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
                    return items.filter(item => {
                        const itemDate = new Date(item.timestamp);
                        return itemDate >= yesterdayStart && itemDate < todayStart;
                    });
                case 'semana':
                    const weekStart = new Date(todayStart.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return items.filter(item => new Date(item.timestamp) >= weekStart);
                default:
                    return items;
            }
        }

        function renderTrendingTopics(topics) {
            trendingTopicsContainer.innerHTML = '';
            topics.forEach(topic => {
                const topicElement = document.createElement('button');
                topicElement.className = 'text-left text-sm text-slate-300 p-3 hover:bg-slate-700 transition-colors duration-200 cursor-pointer w-full flex items-center gap-3 border-b border-slate-700 last:border-b-0';
                
                topicElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span class="truncate">${topic.truncated}</span>
                `;
                
                topicElement.title = topic.full;
                topicElement.onclick = () => {
                    searchInput.value = topic.full;
                    handleSearch();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                trendingTopicsContainer.appendChild(topicElement);
            });
        }

        function renderCategories() {
            const categories = ['Política', 'Economia', 'Esportes', 'Tecnologia', 'Cultura', 'Saúde', 'Mundo', 'Horóscopo', 'Entretenimento', 'A Fazenda 2025', 'Ciência', 'Educação', 'Viagem', 'Gastronomia', 'Carros', 'Imóveis'];
            
            categoriesContainer.innerHTML = '';
            categories.forEach((category) => {
                const categoryButton = document.createElement('button');
                categoryButton.className = `bg-slate-700/50 hover:bg-slate-700 text-slate-300 hover:text-white text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`;
                categoryButton.textContent = category;
                categoryButton.onclick = () => {
                    searchInput.value = category;
                    portalFilter.value = ""; // Reset portal filter
                    handleSearch();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                categoriesContainer.appendChild(categoryButton);
            });
        }

        function renderResults() {
            const filteredByDate = applyDateFilter(allNewsCache, currentDateFilter);
            
            // Pagination logic
            const totalItems = filteredByDate.length;
            const totalPages = Math.min(3, Math.ceil(totalItems / itemsPerPage)); // Max 3 pages
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedItems = filteredByDate.slice(startIndex, startIndex + itemsPerPage);

            resultsContainer.innerHTML = '';

            if (paginatedItems.length === 0) {
                messageState.classList.remove('hidden');
                paginationControls.classList.add('hidden');
                messageTitle.textContent = 'Nenhum resultado para este período';
                messageText.textContent = 'Tente um termo diferente ou altere o filtro de data.';
                return;
            }

            messageState.classList.add('hidden');
            paginatedItems.forEach(item => {
                resultsContainer.appendChild(createGoogleNewsCard(item));
            });

            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            pageIndicator.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }
        
        function createGoogleNewsCard(news) {
            const newsElement = document.createElement('a');
            newsElement.href = news.url;
            newsElement.target = '_blank';
            newsElement.rel = 'noopener noreferrer';
            newsElement.className = 'bg-slate-800 border-l-4 border-cyan-500 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 transform hover:scale-105 transition-transform duration-300';
            const newsDate = new Date(news.timestamp).toLocaleDateString('pt-BR');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = news.description;
            const snippet = tempDiv.textContent || tempDiv.innerText || "";

            const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
            const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
            
            newsElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-3 overflow-hidden">
                         <img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`">
                         <div class="truncate">
                            <p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p>
                        </div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6"></path></svg>
                </div>
                 <div>
                    <p class="text-slate-300 font-semibold leading-relaxed mb-2">${news.title}</p>
                    <p class="text-sm text-slate-400 leading-relaxed max-h-24 overflow-hidden">${snippet}</p>
                </div>
                <div class="flex items-center justify-end text-sm mt-auto pt-4 border-t border-slate-700/50">
                    <span class="text-xs text-slate-500">${newsDate}</span>
                </div>`;
            return newsElement;
        }
        
        // --- UI & EVENT HANDLERS ---
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            lastUpdatedElement.textContent = `Atualizado às ${timeString}`;
        }

        function setLoading(isLoading) {
             if(isLoading) {
                searchButton.disabled = true;
                buttonText.textContent = "Buscando...";
                messageState.classList.add('hidden');
                loadingState.classList.remove('hidden');
                apiError.textContent = '';
             } else {
                searchButton.disabled = false;
                buttonText.textContent = "Buscar";
                loadingState.classList.add('hidden');
             }
        }
        
        function handleApiError(error) {
            console.error(error);
            apiError.textContent = error.message;
            resultsContainer.innerHTML = '';
            messageState.classList.remove('hidden');
            messageTitle.textContent = 'Erro na busca';
            messageText.textContent = 'Não foi possível se conectar à API. Tente novamente mais tarde.';
        }

        async function handleSearch(event) {
            let searchTerm = searchInput.value.trim();
            const portal = portalFilter.value;

            // If it's an auto-refresh and the user has a specific search active, do nothing.
            if ((searchTerm || portal) && event?.type === 'auto-refresh') {
                return;
            }
            
            // If it's a manual search with no terms, or an auto-refresh, load the main feed.
            if ((!searchTerm && !portal) || event?.type === 'auto-refresh') {
                loadInitialContent();
                return;
            }
            
            setLoading(true);
            currentPage = 1; // Reset to first page on new search
            
            let finalQuery = searchTerm;
            if (portal) {
                finalQuery = `${searchTerm} site:${portal}`.trim();
            }

            try {
                const newsResults = await fetchFromGoogleNewsAPI(finalQuery || null);
                allNewsCache = newsResults;
                renderResults();
                updateTimestamp();

            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }
        
        function setDateFilter(filter) {
            currentDateFilter = filter;
            currentPage = 1; // Reset to first page on date change

            // Update button styles
            [dateFilterToday, dateFilterYesterday, dateFilterWeek].forEach(btn => {
                btn.classList.remove('date-filter-active', 'bg-cyan-600', 'text-white');
                btn.classList.add('bg-slate-700/50', 'hover:bg-slate-700', 'text-slate-300');
            });

            const activeBtn = {
                'hoje': dateFilterToday,
                'ontem': dateFilterYesterday,
                'semana': dateFilterWeek
            }[filter];

            if(activeBtn) {
                activeBtn.classList.add('date-filter-active', 'bg-cyan-600', 'text-white');
                activeBtn.classList.remove('bg-slate-700/50', 'hover:bg-slate-700', 'text-slate-300');
            }
            
            renderResults();
        }
        
        // --- INITIAL LOAD & EVENT LISTENERS ---
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') handleSearch();
        });
        portalFilter.addEventListener('change', handleSearch);
        
        dateFilterToday.addEventListener('click', () => setDateFilter('hoje'));
        dateFilterYesterday.addEventListener('click', () => setDateFilter('ontem'));
        dateFilterWeek.addEventListener('click', () => setDateFilter('semana'));

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderResults();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.min(3, Math.ceil(applyDateFilter(allNewsCache, currentDateFilter).length / itemsPerPage));
            if (currentPage < totalPages) {
                currentPage++;
                renderResults();
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialContent();
            fetchTrendingTopics();
            renderCategories();

            // Auto-refresh every 20 minutes
            setInterval(() => handleSearch({type: 'auto-refresh'}), 20 * 60 * 1000);
        });

    </script>
</body>
</html>

