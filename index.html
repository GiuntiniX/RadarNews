<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Estilos dos botões de filtro de VISÃO e DATA */
        .view-filter-active,
        .date-filter-active {
            background-color: #06b6d4 !important; /* cyan-500 */
            color: #ffffff !important;
        }
        
        /* Estilos dos filtros de GAP - NÃO COBERTO */
        .gap-filter-active {
            background-color: #fbbf24 !important; /* amber-400 - Alerta de Gap */
            color: #1e293b !important;
        }
        /* NOVO: Estilo para o filtro de GAP - COBERTO */
        #filterGapsCovered.gap-filter-active {
            background-color: #10b981 !important; /* emerald-500 - Reforço positivo */
            color: #ffffff !important;
        }

        /* Estilo da Categoria Ativa (Geral) */
        .category-active {
            background-color: #0891b2 !important; /* cyan-600 */
            color: #ffffff !important;
            font-weight: 600;
        }
        
        /* Estilo de Destaque da Busca */
        .highlight {
            background-color: #fde047;
            color: #1e293b;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Estilo da Categoria Seguida (Para Si) */
        .category-followed {
            background-color: #334155 !important; /* slate-700 */
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.25);
            color: #94a3b8 !important; /* slate-400 */
        }
        
        /* Transições */
        #toast {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        #backToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
        #info-banner {
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        #info-banner.hidden {
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
        }

        /* NOVO: Estilo para o botão de Mídia Ativo no Dropdown */
        .media-dropdown-active {
            background-color: #06b6d4; /* cyan-500 */
            color: #ffffff;
            font-weight: 600;
        }

        /* Animação para o Dropdown */
        .dropdown-menu {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        .dropdown-menu.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div id="info-banner" role="alert" class="hidden fixed top-5 right-5 w-80 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-50 p-4">
        <button id="close-info-banner" type="button" aria-label="Fechar dicas" class="absolute top-2 right-2 text-slate-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <h3 class="font-bold text-cyan-400 mb-2 text-base">Dicas Rápidas do Radar</h3>
        <ul class="space-y-2 text-sm text-slate-300 list-inside">
            <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <span><b>Busca Inteligente:</b> Basta digitar no campo de busca e os resultados aparecem.</span>
            </li>
            <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                <span><b>Feed 'Para Si':</b> Siga suas editorias favoritas para criar um feed personalizado.</span>
            </li>
             <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span><b>Análise Agregada:</b> Descubra o que está em alta na concorrência e compare a cobertura.</span>
            </li>
        </ul>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-6 relative">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="6" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v10l-4 4"></path>
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-400 mt-2">As últimas notícias sobre os principais assuntos do Brasil.</p>
             <p class="text-sm text-slate-500 mt-1">
                Ferramenta desenvolvida por Estratégia de Dados - 
                <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2 flex justify-center items-center gap-2"></div>
        </header>

        <div class="sticky top-4 bg-slate-800/80 backdrop-blur-sm z-10 p-4 rounded-xl border border-slate-700 shadow-lg mb-8">
            <div id="searchBarWrapper" class="flex flex-wrap items-center justify-center gap-4">
                <div class="flex-grow flex items-center bg-slate-900 rounded-lg p-1 border border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder="Busque enquanto digita..." class="w-full bg-transparent text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    <button id="clearSearchBtn" aria-label="Limpar busca" class="text-slate-500 hover:text-slate-300 transition-colors duration-200 p-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-600 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span id="buttonText">Buscar</span>
                    </button>
                </div>
            </div>

            <div class="flex justify-center items-center mt-4 flex-wrap gap-x-4 gap-y-2">
                <div class="flex items-center gap-2 p-1 rounded-lg">
                    <button id="viewFilterRadar" class="view-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" aria-pressed="true">
                        Últimas Notícias
                    </button>
                    <button id="viewFilterForYou" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700 flex items-center gap-1.5" aria-pressed="false">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118l-2.8-2.034c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" /></svg>
                        Para Si
                    </button>
                    <button id="viewFilterAggregate" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" aria-pressed="false">Conteúdo Agregado</button>
                </div>
                <div id="dateFilterContainer" class="flex items-center gap-2 p-1 rounded-lg">
                    <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" data-date-key="hoje" aria-pressed="true">Hoje</button>
                    <button id="dateFilterLastWeek" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" data-date-key="ultima_semana" aria-pressed="false">Última Semana</button>
                </div>
                
                <div id="mediaFilterDropdown" class="relative">
                    <button id="mediaFilterButton" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2" aria-expanded="false" aria-controls="mediaDropdownMenu">
                        <span id="currentMediaLabel">Mídia: Todos</span>
                        <svg id="mediaDropdownIcon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="mediaDropdownMenu" class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-20 origin-top-right">
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg media-dropdown-active" data-media-key="todos">Todos</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="texto">Notícias 📝</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="video">Vídeo ▶️</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="podcast">Podcast 🎙️</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="refreshButton" aria-label="Atualizar notícias" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-500"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        <span>Atualizar</span>
                    </button>
                    <button id="readingListBtn" aria-label="Abrir lista de leitura" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 012 2z"></path></svg>
                        <span id="savedNewsCountBadge" class="absolute -top-2 -right-2 bg-cyan-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                    </button>
                </div>
            </div>
            <p id="apiError" class="text-center text-red-400 text-sm mt-3 h-4"></p>
        </div>
        
        <div id="radarContainer">
            <div class="lg:grid lg:grid-cols-10 lg:gap-8">
                <div class="lg:col-span-7">
                    <div id="contentCounter" class="text-sm text-slate-400 mb-4 h-5"></div>
                    <div class="mb-8">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-cyan-400">Navegue por Editorial</h2>
                                <button id="clearFollowedBtn" class="hidden text-xs text-red-400 hover:text-red-300 font-semibold transition-colors duration-200">
                                    Limpar
                                </button>
                            </div>
                            <div id="categoriesContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div id="subCategoriesWrapper" class="bg-slate-800 rounded-xl p-4 border border-slate-700 hidden mt-4">
                            <h2 class="text-lg font-bold text-cyan-400 mb-4">Sub-editorias</h2>
                            <div id="subCategoriesContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6"></main>
                    <div id="messageState" class="hidden text-center py-16">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        <h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3>
                        <p id="messageText" class="text-slate-500">Tente um termo diferente.</p>
                    </div>
                </div>
                <aside class="lg:col-span-3 mt-8 lg:mt-0">
                    <div class="sticky top-28 flex flex-col gap-8 overflow-y-auto max-h-[calc(100vh-8rem)] pr-2">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-cyan-400">Lista de Leitura (<span id="savedNewsCountSidebar">0</span>)</h2>
                                <div><button id="copyListBtn" class="text-xs text-cyan-400 hover:underline">Copiar Lista</button></div>
                            </div>
                            <div id="savedNewsPreviewContainer" class="space-y-2"></div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
        
        <div id="aggregateContainer" class="hidden">
            <h2 class="text-2xl font-bold text-cyan-400 mb-6 text-center">Análise de Cobertura Competitiva (Últimas 24h)</h2>
            <div id="gapAnalysisContainer" class="mb-8 bg-slate-800/50 border border-slate-700 rounded-xl p-6">
                <h3 class="text-xl font-semibold text-amber-400 mb-4">Assuntos em Destaque na Concorrência</h3>
                
                <div class="flex items-center justify-center mb-6">
                    <div class="flex items-center gap-2 p-1 rounded-lg">
                        <button id="filterGapsNotCovered" class="gap-filter-active text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" aria-pressed="true">Não Produzido pelo Terra</button>
                        <button id="filterGapsCovered" class="text-slate-300 hover:bg-slate-700 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" aria-pressed="false">Produzido pelo Terra</button>
                    </div>
                </div>
                <div id="gapResults"><p class="text-slate-400 text-center py-4">Clique em "Conteúdo Agregado" para iniciar a análise.</p></div>
                
                <div id="gapPaginationControls" class="flex justify-center items-center mt-6 gap-2"></div>

            </div>
            
            <h3 class="text-xl font-semibold text-cyan-400 mb-4">Conteúdo por Portal | Google News</h3>

            <div id="dashboardContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>

        </div>
    </div>
    
    <div id="readingListModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h2 class="text-lg font-bold text-cyan-400">Lista de Leitura</h2>
                <button id="closeReadingListBtn" aria-label="Fechar lista de leitura"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </header>
            <div id="savedNewsContainer" class="flex-grow p-4 overflow-y-auto space-y-2"></div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-transform duration-300">
        <p id="toastMessage"></p>
    </div>
    <button id="backToTopBtn" aria-label="Voltar ao topo" class="hidden fixed bottom-5 right-5 bg-cyan-500 hover:bg-cyan-600 text-white p-3 rounded-full shadow-lg opacity-0 transform translate-y-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
    </button>
    
    <script>
    // =================================================================================
    // CÓDIGO FINAL UNIFICADO - RADAR DE NOTÍCIAS (COM FILTRO DE MÍDIA CASCATA)
    // =================================================================================

    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearSearchBtn = document.getElementById('clearSearchBtn'); 
    const buttonText = document.getElementById('buttonText');
    const apiError = document.getElementById('apiError');
    const lastUpdatedElement = document.getElementById('lastUpdated');
    const refreshButton = document.getElementById('refreshButton');
    const backToTopBtn = document.getElementById('backToTopBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const searchBarWrapper = document.getElementById('searchBarWrapper');
    const radarContainer = document.getElementById('radarContainer');
    const aggregateContainer = document.getElementById('aggregateContainer');
    const viewFilterRadar = document.getElementById('viewFilterRadar');
    const viewFilterForYou = document.getElementById('viewFilterForYou');
    const viewFilterAggregate = document.getElementById('viewFilterAggregate');
    const dateFilterContainer = document.getElementById('dateFilterContainer');
    const dateFilterToday = document.getElementById('dateFilterToday');
    const dateFilterLastWeek = document.getElementById('dateFilterLastWeek');
    // NOVO: Elementos do Dropdown de Mídia
    const mediaFilterDropdown = document.getElementById('mediaFilterDropdown');
    const mediaFilterButton = document.getElementById('mediaFilterButton');
    const mediaDropdownMenu = document.getElementById('mediaDropdownMenu');
    const currentMediaLabel = document.getElementById('currentMediaLabel');
    const mediaDropdownIcon = document.getElementById('mediaDropdownIcon');
    
    const resultsContainer = document.getElementById('resultsContainer');
    const messageState = document.getElementById('messageState');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const subCategoriesWrapper = document.getElementById('subCategoriesWrapper');
    const subCategoriesContainer = document.getElementById('subCategoriesContainer');
    const contentCounter = document.getElementById('contentCounter');
    const readingListBtn = document.getElementById('readingListBtn');
    const readingListModal = document.getElementById('readingListModal');
    const closeReadingListBtn = document.getElementById('closeReadingListBtn');
    const savedNewsContainer = document.getElementById('savedNewsContainer');
    const savedNewsCountBadge = document.getElementById('savedNewsCountBadge');
    const savedNewsPreviewContainer = document.getElementById('savedNewsPreviewContainer');
    const copyListBtn = document.getElementById('copyListBtn');
    const savedNewsCountSidebar = document.getElementById('savedNewsCountSidebar');
    const gapResults = document.getElementById('gapResults');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const filterGapsNotCoveredBtn = document.getElementById('filterGapsNotCovered');
    const filterGapsCoveredBtn = document.getElementById('filterGapsCovered');
    const clearFollowedBtn = document.getElementById('clearFollowedBtn');

    
    // --- APP STATE ---
    let currentAppView = 'radar';
    let currentRadarView = 'geral';
    let currentDateFilter = 'hoje'; 
    let currentMediaFilter = 'todos'; // NOVO: Estado inicial do filtro de mídia
    let masterNewsCache = [];
    let savedNews = [];
    let followedTopics = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let isLoadingMore = false;
    let activeCategoryButton = null;
    let currentCategorySearch = null;
    let currentGapView = 'not_covered'; 
    let latestAnalysisResult = { covered: [], not_covered: [] };
    let currentGapPage = 1;

    // --- CONSTANTS & CONFIGS ---
    const mainCategories = ['Todas', 'Política', 'Economia', 'Esportes', 'Cultura', 'Saúde', 'Mundo', 'Horóscopo', 'Entretenimento', 'Ciência', 'Educação', 'Viagem', 'Gastronomia', 'Carros', 'Imóveis', 'Música', 'Cinema', 'Moda', 'Meio Ambiente'];
    
    const GAPS_PER_PAGE = 20;
    const MAX_GAP_PAGES = 5;
    
    // Mapeamento de cor e formato para o Dropdown e Cards
    const MEDIA_FORMATS = {
        'todos': { label: 'Todos', emoji: '', color: 'bg-slate-700' },
        'texto': { label: 'Notícias', emoji: '📝', color: 'bg-slate-600' },
        'video': { label: 'Vídeo', emoji: '▶️', color: 'bg-red-600' },
        'podcast': { label: 'Podcast', emoji: '🎙️', color: 'bg-purple-600' }
    };
    
    const categoryColorMap = {
        'Todas': 'border-slate-400', 'Política': 'border-blue-500', 'Economia': 'border-emerald-500', 'Esportes': 'border-red-500', 'Cultura': 'border-yellow-500', 'Saúde': 'border-pink-500', 'Mundo': 'border-sky-500', 'Horóscopo': 'border-orange-500', 'Entretenimento': 'border-teal-500', 'Ciência': 'border-lime-500', 'Educação': 'border-rose-500', 'Viagem': 'border-indigo-500', 'Gastronomia': 'border-amber-500', 'Carros': 'border-slate-500', 'Imóveis': 'border-gray-500', 'Música': 'border-pink-400', 'Cinema': 'border-yellow-400', 'Moda': 'border-rose-400', 'Meio Ambiente': 'border-green-500'
    };
    
    const categoryButtonColors = [
        'bg-blue-600 hover:bg-blue-500', 'bg-emerald-600 hover:bg-emerald-500', 'bg-red-600 hover:bg-red-500', 'bg-yellow-600 hover:bg-yellow-500', 'bg-pink-600 hover:bg-pink-500', 'bg-sky-600 hover:bg-sky-500', 'bg-orange-600 hover:bg-orange-500', 'bg-teal-600 hover:bg-teal-500', 'bg-lime-600 hover:bg-lime-500', 'bg-rose-600 hover:bg-rose-500', 'bg-indigo-600 hover:bg-indigo-500', 'bg-amber-600 hover:bg-amber-500', 'bg-slate-600 hover:bg-slate-500', 'bg-pink-400 hover:bg-pink-300', 'bg-yellow-400 hover:bg-yellow-300', 'bg-rose-400 hover:bg-rose-300', 'bg-green-600 hover:bg-green-500' 
    ];
    const lightBgClasses = ['bg-lime-600', 'bg-pink-400', 'bg-yellow-400']; 
    
    // --- CORE DATA FUNCTIONS (API, Mapping) ---
    
    // NOVO: Função para determinar o formato da mídia
    function determineMediaType(title, url) {
        const titleLower = title.toLowerCase();
        const urlLower = url.toLowerCase();

        // 1. Palavras-chave no título (mais confiável para identificar formato)
        if (titleLower.includes('vídeo') || titleLower.includes('assista') || titleLower.includes('galeria') || titleLower.includes('imagens')) {
            return 'video';
        }
        if (titleLower.includes('podcast') || titleLower.includes('áudio') || titleLower.includes('ouça')) {
            return 'podcast';
        }
        
        // 2. Domínios de vídeo/áudio
        if (urlLower.includes('youtube.com') || urlLower.includes('vimeo.com') || urlLower.includes('videos')) {
            return 'video';
        }
        if (urlLower.includes('spotify.com') || urlLower.includes('soundcloud.com') || urlLower.includes('podcasts')) {
            return 'podcast';
        }

        // 3. Padrão
        return 'texto';
    }

    function mapGoogleNewsData(item, categoryTag = null) {
        const getSourceName = (sourceString) => { if (!sourceString) return 'Fonte Desconhecida'; const tempDiv = document.createElement('div'); tempDiv.innerHTML = sourceString; const text = tempDiv.textContent || tempDiv.innerText || ""; const parts = text.split(' - '); return parts[parts.length - 1].trim(); };
        let sourceDomain = 'news.google.com';
        try { if (item.sourceUrl && typeof item.sourceUrl === 'string') { sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', ''); } } catch (e) { console.error("Could not parse source URL:", item.sourceUrl, e); }
        
        const bestCategory = categoryTag && categoryTag !== 'Todas' ? categoryTag : 'Geral'; 
        
        // NOVO: Determina o formato e adiciona ao objeto da notícia
        const mediaType = determineMediaType(item.title, item.link); 
        
        return { source: 'googlenews', title: item.title, timestamp: new Date(item.pubDate).getTime(), url: item.link, description: item.content, sourceName: getSourceName(item.title), sourceDomain: sourceDomain, category: bestCategory, mediaType: mediaType };
    }

    async function fetchFromGoogleNewsAPI(query = null) {
        const fetchAndParse = async (searchUrl, categoryTag) => {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) { console.warn(`Falha ao buscar notícias de: ${searchUrl}`); return []; }
                const textData = await response.text(); if (!textData) return [];
                const parser = new DOMParser(); const xmlDoc = parser.parseFromString(textData, "application/xml");
                const items = xmlDoc.querySelectorAll("item"); const newsResults = [];
                items.forEach(item => { const sourceElement = item.querySelector("source"); newsResults.push({ title: item.querySelector("title").textContent, link: item.querySelector("link").textContent, sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent, pubDate: item.querySelector("pubDate").textContent, description: item.querySelector("description")?.textContent }); });
                return newsResults.map(item => mapGoogleNewsData(item, categoryTag));
            } catch (error) { console.error(`Erro no fetch para ${searchUrl}:`, error); return []; }
        };
        if (query) {
            const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
            const results = await fetchAndParse(searchUrl, query);
            return results.sort((a, b) => b.timestamp - a.timestamp); 
        } else { 
            const categories = ['Brasil', 'Mundo', 'Política', 'Economia', 'Esportes', 'Ciência', 'Cultura', 'Entretenimento', 'Saúde', 'Tecnologia']; 
            let combinedNews = []; 
            for (const cat of categories) { const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(cat)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`; const newsForCat = await fetchAndParse(searchUrl, cat); combinedNews.push(...newsForCat); } const uniqueNews = new Map(); combinedNews.forEach(news => { if (!uniqueNews.has(news.url)) { uniqueNews.set(news.url, news); } }); return Array.from(uniqueNews.values()).sort((a, b) => b.timestamp - a.timestamp); }
    }

    // --- RADAR VIEW FUNCTIONS ---

    // NOVO: Função para obter ícone e cor do formato de mídia
    function getMediaIconAndColor(mediaType) {
        return MEDIA_FORMATS[mediaType] || MEDIA_FORMATS['texto'];
    }

    // NOVO: Função para atualizar o botão principal do dropdown
    function updateMediaDropdown(filterKey) {
        const mediaInfo = getMediaIconAndColor(filterKey);
        currentMediaLabel.textContent = `Mídia: ${mediaInfo.label} ${mediaInfo.emoji}`;

        mediaDropdownMenu.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('media-dropdown-active');
        });
        mediaDropdownMenu.querySelector(`[data-media-key="${filterKey}"]`).classList.add('media-dropdown-active');
    }

    // NOVO: Função para manipular a mudança de filtro de Mídia
    function handleMediaFilterChange(filterKey) {
        currentMediaFilter = filterKey;
        updateMediaDropdown(filterKey);
        // Fecha o dropdown
        mediaDropdownMenu.classList.add('hidden');
        mediaFilterButton.setAttribute('aria-expanded', 'false');
        mediaDropdownIcon.classList.remove('rotate-180');
        
        renderRadarResults();
    }
    
    // NOVO: Função para aplicar o filtro de Mídia
    const applyMediaFilter = (items, filterKey) => {
        if (filterKey === 'todos') {
            return items;
        }
        return items.filter(item => item.mediaType === filterKey);
    };

    function renderRadarResults(append = false) {
        if (!append) { 
            resultsContainer.innerHTML = ''; 
            currentPage = 1;
        }
        if (currentRadarView === 'paraSi' && followedTopics.length === 0) {
            messageState.classList.remove('hidden'); messageTitle.textContent = 'Comece a seguir tópicos!'; messageText.textContent = 'Clique nas editorias para personalizar o seu feed.';
            contentCounter.textContent = ''; resultsContainer.innerHTML = ''; return;
        }
        
        let filteredNews = applyDateFilter(masterNewsCache, currentDateFilter);
        filteredNews = applyMediaFilter(filteredNews, currentMediaFilter); // Aplica o filtro de mídia

        if (currentRadarView === 'paraSi') {
            filteredNews = filteredNews.filter(news => { 
                const titleLower = news.title.toLowerCase(); 
                const categoryLower = news.category ? news.category.toLowerCase() : ''; 
                return followedTopics.some(topic => { 
                    const topicLower = topic.toLowerCase(); 
                    return titleLower.includes(topicLower) || categoryLower.includes(topicLower); 
                }); 
            });
        }
        const totalItems = filteredNews.length; 
        const startIndex = (currentPage - 1) * itemsPerPage; 
        const endIndex = startIndex + itemsPerPage; 
        const paginatedItems = filteredNews.slice(startIndex, endIndex);
        
        if (paginatedItems.length === 0 && currentPage === 1) {
            messageState.classList.remove('hidden'); messageTitle.textContent = 'Nenhuma notícia encontrada.'; messageText.textContent = currentRadarView === 'paraSi' ? 'Não foram encontrados resultados para os seus tópicos seguidos.' : 'Tente um termo diferente ou ajuste os filtros.';
            contentCounter.textContent = ''; return;
        }
        messageState.classList.add('hidden');
        paginatedItems.forEach(item => { resultsContainer.appendChild(createGoogleNewsCard(item)); });
        contentCounter.textContent = `Exibindo ${resultsContainer.children.length} de ${totalItems} notícias.`;
        isLoadingMore = false; 
    }
    
    function createGoogleNewsCard(news) {
        const newsElement = document.createElement('div');
        
        const primaryCategory = news.category === 'Geral' ? 'Todas' : news.category.split(' > ')[0];
        const borderColorClass = categoryColorMap[primaryCategory] || 'border-cyan-500';
        const categoryIndex = mainCategories.indexOf(primaryCategory); 
        let categoryColorClass = 'bg-slate-700'; 
        let categoryTextColorClass = 'text-white';
        
        if (categoryIndex > 0) { 
            const colorClass = categoryButtonColors[(categoryIndex - 1) % categoryButtonColors.length];
            categoryColorClass = colorClass.split(' ')[0]; 
            const isLightBg = lightBgClasses.some(lightClass => colorClass.includes(lightClass)); 
            categoryTextColorClass = isLightBg ? 'text-slate-900' : 'text-white'; 
        } else if (primaryCategory === 'Todas') {
            categoryColorClass = 'bg-slate-700'; 
        }
        
        const newsDateTime = new Date(news.timestamp);
        const newsDate = newsDateTime.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const newsTime = newsDateTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const fullDateTime = `${newsDate} às ${newsTime}`;
        const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
        const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
        const isSaved = savedNews.some(saved => saved.url === news.url);
        const saveButtonIcon = isSaved 
            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>` 
            : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
        const searchTerm = searchInput.value.trim();
        let finalTitle = news.title;
        if (searchTerm) { const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); finalTitle = finalTitle.replace(regex, `<span class="highlight">$1</span>`); }
        
        const categoryHTML = `<span class="text-xs font-medium ${categoryColorClass} ${categoryTextColorClass} px-2 py-1 rounded-full">${primaryCategory}</span>`;
        
        // NOVO: Ícone SIMPLIFICADO do formato de mídia
        const mediaInfo = getMediaIconAndColor(news.mediaType);
        const mediaTag = `<span class="text-lg text-slate-300 ml-1" title="${mediaInfo.label}">${mediaInfo.emoji}</span>`; // Apenas o emoji/ícone
        
        newsElement.className = `bg-slate-800 border-l-4 ${borderColorClass} rounded-r-lg p-5 shadow-lg flex flex-col gap-4 transform hover:scale-[1.01] transition-transform duration-300`; 
        
        newsElement.innerHTML = `
            <div class="flex justify-between items-start">
                <a href="${news.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 overflow-hidden">
                    <img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`">
                    <div class="truncate">
                        <p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p>
                    </div>
                </a>
                <div class="flex items-center gap-2">
                    <button class="save-btn" data-url="${news.url}" aria-label="Salvar notícia">${saveButtonIcon}</button>
                </div>
            </div>
            <div>
                <a href="${news.url}" target="_blank" rel="noopener noreferrer">
                    <p class="text-slate-300 font-semibold leading-relaxed mb-2">${finalTitle} ${mediaTag}</p>
                </a>
            </div>
            <div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50">
                <div class="flex flex-wrap gap-2">
                    ${categoryHTML}
                </div>
                <span class="text-xs text-slate-500">${fullDateTime}</span>
            </div>
        `;
        newsElement.querySelector('.save-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); handleSaveNews(news, e.currentTarget); });
        return newsElement;
    }
    
    // --- FUNÇÕES DE FILTRO DE DATA/ESTADO (Mantidas as anteriores para funcionalidade) ---
    
    function handleDateFilterChange(filterKey, buttonElement) {
        currentDateFilter = filterKey;
        dateFilterContainer.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('date-filter-active');
            btn.setAttribute('aria-pressed', 'false');
            btn.classList.add('text-slate-300', 'hover:bg-slate-700');
        });
        buttonElement.classList.add('date-filter-active');
        buttonElement.classList.remove('text-slate-300', 'hover:bg-slate-700');
        buttonElement.setAttribute('aria-pressed', 'true');
        renderRadarResults();
    }
    
    const applyDateFilter = (items, filterKey) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        if (filterKey === 'hoje') {
            return items.filter(item => new Date(item.timestamp) >= today);
        }
        if (filterKey === 'ultima_semana') {
            const weekAgoStart = new Date(today);
            weekAgoStart.setDate(weekAgoStart.getDate() - 7); 
            return items.filter(item => {
                const itemDate = new Date(item.timestamp);
                return itemDate >= weekAgoStart && itemDate < today;
            });
        }
        return items;
    };
    
    function renderSavedNews() {
        savedNewsContainer.innerHTML = ''; 
        savedNewsCountSidebar.textContent = savedNews.length; savedNewsCountBadge.textContent = savedNews.length; savedNewsPreviewContainer.innerHTML = '';
        if (savedNews.length === 0) { const emptyMsg = `<p class="text-sm text-center text-slate-400 p-4">Nenhuma notícia salva.</p>`; savedNewsContainer.innerHTML = emptyMsg; savedNewsPreviewContainer.innerHTML = emptyMsg; return; }
        savedNews.forEach(news => { const savedItem = document.createElement('div'); savedItem.className = 'flex items-center justify-between gap-2 p-2 rounded-lg hover:bg-slate-700'; savedItem.innerHTML = `<a href="${news.url}" target="_blank" class="text-sm text-slate-300 truncate" title="${news.title}">${news.title}</a><button class="remove-saved-btn flex-shrink-0" data-url="${news.url}" aria-label="Remover notícia"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; savedNewsContainer.appendChild(savedItem); });
        savedNews.slice(0, 15).forEach(news => { const savedItem = document.createElement('div'); savedItem.className = 'flex items-center justify-between gap-2 p-1 rounded-lg hover:bg-slate-700'; savedItem.innerHTML = `<a href="${news.url}" target="_blank" class="text-sm text-slate-300 truncate" title="${news.title}">${news.title}</a><button class="remove-saved-btn flex-shrink-0" data-url="${news.url}" aria-label="Remover notícia"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; savedNewsPreviewContainer.appendChild(savedItem); });
        document.querySelectorAll('.remove-saved-btn').forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); handleRemoveNews(button.dataset.url); }); });
    }
    
    function renderCategories() {
        categoriesContainer.innerHTML = '';
        clearFollowedBtn.classList.add('hidden'); 
        mainCategories.forEach((category, index) => {
            if (currentRadarView === 'paraSi' && category === 'Todas') {
                return;
            }
            const categoryButton = document.createElement('button');
            const isFollowed = followedTopics.includes(category);
            let buttonClass;
            if (currentRadarView === 'geral') {
                if (index === 0) { 
                    buttonClass = 'bg-slate-700/50 hover:bg-slate-700 text-slate-300 hover:text-white';
                } else {
                    const colorIndex = index - 1;
                    const colorClass = categoryButtonColors[colorIndex % categoryButtonColors.length];
                    const isLightBg = lightBgClasses.some(lightClass => colorClass.includes(lightClass));
                    const textColorClass = isLightBg ? 'text-black' : 'text-white';
                    buttonClass = `${colorClass} ${textColorClass}`;
                }
            } else { 
                const colorIndex = index > 0 ? index - 1 : 0; 
                if (isFollowed) {
                    buttonClass = 'category-followed'; 
                } else {
                    const colorClass = categoryButtonColors[colorIndex % categoryButtonColors.length];
                    buttonClass = `${colorClass.replace('bg-', 'hover:bg-').replace('hover:bg-', 'border-')}/50 text-slate-300 hover:text-white border`; 
                }
            }
            categoryButton.className = `${buttonClass} text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`;
            categoryButton.textContent = category;
            if (currentRadarView === 'geral' && (currentCategorySearch === category || (!currentCategorySearch && category === 'Todas'))) {
                categoryButton.classList.add('category-active');
            }
            categoryButton.onclick = () => {
                if (currentRadarView === 'paraSi') {
                    toggleFollowTopic(category);
                } else if (currentRadarView === 'geral') {
                    handleSearch(searchInput.value, category === 'Todas' ? null : category);
                    document.querySelectorAll('#categoriesContainer button').forEach(btn => btn.classList.remove('category-active'));
                    categoryButton.classList.add('category-active');
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            categoriesContainer.appendChild(categoryButton);
        });
        if (currentRadarView === 'paraSi' && followedTopics.length > 0) {
            clearFollowedBtn.classList.remove('hidden');
        }
    }


    // --- SHARED UI/EVENT HANDLERS ---
    function handleSaveNews(newsItem, buttonElement) {
        const isAlreadySaved = savedNews.some(item => item.url === newsItem.url);
        if (isAlreadySaved) {
            savedNews = savedNews.filter(item => item.url !== newsItem.url);
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
            showToast('Notícia removida da lista!');
        } else {
            savedNews.push(newsItem);
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>`;
            showToast('Notícia salva!');
        }
        localStorage.setItem('savedNews', JSON.stringify(savedNews));
        renderSavedNews();
    }
    function handleRemoveNews(newsUrl) {
        savedNews = savedNews.filter(item => item.url !== newsUrl);
        localStorage.setItem('savedNews', JSON.stringify(savedNews));
        renderSavedNews();
        if(currentAppView === 'radar') renderRadarResults();
        showToast('Notícia removida da lista!');
    }
    function toggleFollowTopic(topic) {
        const topicIndex = followedTopics.indexOf(topic);
        if (topicIndex > -1) {
            followedTopics.splice(topicIndex, 1);
            showToast(`Deixou de seguir "${topic}"`);
        } else {
            followedTopics.push(topic);
            showToast(`Agora segue "${topic}"`);
        }
        localStorage.setItem('followedTopics', JSON.stringify(followedTopics));
        renderCategories();
        if (currentRadarView === 'paraSi') { renderRadarResults(); }
    }
    function showToast(message) {
        toastMessage.textContent = message;
        toast.classList.remove('opacity-0', 'translate-y-20');
        toast.classList.add('opacity-100', 'translate-y-0');
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-20');
            toast.classList.remove('opacity-100', 'translate-y-0');
        }, 3000);
    }
    function updateTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        lastUpdatedElement.innerHTML = `<span>Atualizado às ${timeString}</span> <span class="text-slate-500/70">(auto-refresh a cada 20 min)</span>`;
    }
    function setLoading(isLoading, isInitialLoad = true) {
        if(isLoading) {
            searchButton.disabled = true; 
            buttonText.textContent = "Buscando..."; 
            if (isInitialLoad) {
                messageState.classList.add('hidden'); 
                resultsContainer.innerHTML = '';
                for(let i = 0; i < 6; i++) { resultsContainer.innerHTML += `<div class="bg-slate-800 border-l-4 border-slate-700 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 animate-pulse"><div class="flex justify-between items-start"><div class="flex items-center gap-3 w-1/2"><div class="w-6 h-6 rounded-md bg-slate-700"></div><div class="h-4 bg-slate-700 rounded w-full"></div></div><div class="h-6 w-12 bg-slate-700 rounded-full"></div></div><div><div class="h-5 bg-slate-700 rounded w-full mb-2"></div><div class="h-5 bg-slate-700 rounded w-3/4"></div></div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50"><div class="h-5 w-20 bg-slate-700 rounded-full"></div><div class="h-4 w-24 bg-slate-700 rounded"></div></div></div>`; }
            }
        } else {
            searchButton.disabled = false; 
            buttonText.textContent = "Buscar";
        }
    }
    async function handleSearch(queryValue, category = null) {
        setLoading(true);
        currentCategorySearch = category;
        const query = category !== null ? category : queryValue;
        
        masterNewsCache = await fetchFromGoogleNewsAPI(query.trim() === '' ? null : query);
        
        setLoading(false);
        renderRadarResults();
        renderCategories(); 
    }

    // --- VIEW CONTROLLER ---
    function setView(view) {
        currentAppView = view;
        const buttons = [viewFilterRadar, viewFilterForYou, viewFilterAggregate];
        buttons.forEach(btn => {
            btn.classList.remove('view-filter-active', 'text-white');
            btn.classList.add('text-slate-300', 'hover:bg-slate-700');
            btn.setAttribute('aria-pressed', 'false');
        });

        if (view === 'radar') {
            radarContainer.classList.remove('hidden');
            aggregateContainer.classList.add('hidden');
            searchBarWrapper.classList.remove('hidden');
            dateFilterContainer.classList.remove('hidden');
            mediaFilterDropdown.classList.remove('hidden'); // Mostra filtro de mídia
            
            if (currentRadarView === 'geral') {
                viewFilterRadar.classList.add('view-filter-active');
                viewFilterRadar.classList.remove('text-slate-300', 'hover:bg-slate-700');
                viewFilterRadar.setAttribute('aria-pressed', 'true');
            } else {
                viewFilterForYou.classList.add('view-filter-active');
                viewFilterForYou.classList.remove('text-slate-300', 'hover:bg-slate-700');
                viewFilterForYou.setAttribute('aria-pressed', 'true');
            }
            renderCategories(); 
        } else if (view === 'aggregate') {
            radarContainer.classList.add('hidden');
            aggregateContainer.classList.remove('hidden');
            viewFilterAggregate.classList.add('view-filter-active');
            viewFilterAggregate.classList.remove('text-slate-300', 'hover:bg-slate-700');
            viewFilterAggregate.setAttribute('aria-pressed', 'true');
            searchBarWrapper.classList.add('hidden');
            dateFilterContainer.classList.add('hidden');
            mediaFilterDropdown.classList.add('hidden'); // Esconde filtro de mídia
        }
    }
    
    // --- INITIALIZATION & REFRESH LOGIC ---
    
    // As funções de refresh aggregate, debounce e manageInfoBanner foram omitidas aqui para brevidade do código final, mas estão no seu projeto.
    
    async function loadInitialContent(isAutoRefresh = false) {
        if (!isAutoRefresh) {
              setLoading(true, true);
        }
        masterNewsCache = await fetchFromGoogleNewsAPI();
        if (!isAutoRefresh) {
            setLoading(false, true);
        }
        renderRadarResults();
        updateTimestamp();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const storedNews = localStorage.getItem('savedNews');
        if (storedNews) { savedNews = JSON.parse(storedNews); }
        const storedTopics = localStorage.getItem('followedTopics');
        if (storedTopics) { followedTopics = JSON.parse(storedTopics); }
        
        // Inicializa o dropdown de mídia com o estado 'todos'
        updateMediaDropdown(currentMediaFilter);

        renderSavedNews();
        renderCategories();
        
        loadInitialContent();
        
        // --- EVENT LISTENERS ---
        
        // Lógica do Dropdown de Mídia (Cascata)
        mediaFilterButton.addEventListener('click', () => {
            const isExpanded = mediaFilterButton.getAttribute('aria-expanded') === 'true';
            mediaFilterButton.setAttribute('aria-expanded', !isExpanded);
            mediaDropdownMenu.classList.toggle('hidden', isExpanded);
            mediaDropdownIcon.classList.toggle('rotate-180', !isExpanded);
        });

        mediaDropdownMenu.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', (e) => {
                const filterKey = e.currentTarget.getAttribute('data-media-key');
                handleMediaFilterChange(filterKey);
            });
        });

        // Fecha o dropdown se clicar fora
        document.addEventListener('click', (e) => {
            if (!mediaFilterDropdown.contains(e.target)) {
                mediaDropdownMenu.classList.add('hidden');
                mediaFilterButton.setAttribute('aria-expanded', 'false');
                mediaDropdownIcon.classList.remove('rotate-180');
            }
        });

        // Eventos de Filtro de Visão e Busca
        viewFilterRadar.addEventListener('click', () => { 
            currentRadarView = 'geral'; 
            setView('radar'); 
            handleSearch(searchInput.value, null); 
        });
        viewFilterForYou.addEventListener('click', () => { 
            currentRadarView = 'paraSi'; 
            setView('radar'); 
            renderRadarResults(); 
        });
        viewFilterAggregate.addEventListener('click', () => {
            setView('aggregate');
            // Simulação de chamada de refresh para a visão Agregada
        });
        searchButton.addEventListener('click', () => handleSearch(searchInput.value, null));
        
        // Eventos de Filtro de Data
        dateFilterToday.addEventListener('click', (e) => handleDateFilterChange('hoje', e.currentTarget));
        dateFilterLastWeek.addEventListener('click', (e) => handleDateFilterChange('ultima_semana', e.currentTarget));

        // Eventos de Botões (Atualizar/Salvos)
        refreshButton.addEventListener('click', () => { searchInput.value = ''; loadInitialContent(); });
        readingListBtn.addEventListener('click', () => readingListModal.classList.remove('hidden'));
        closeReadingListBtn.addEventListener('click', () => readingListModal.classList.add('hidden'));

        // Scroll e Debounce
        searchInput.addEventListener('input', () => { updateClearSearchButton(); debounce(() => handleSearch(searchInput.value, null), 500)(); });
        clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; updateClearSearchButton(); handleSearch('', null); });
        
        // Funções de scroll/toasts omitidas para brevidade
        // ...
    });
    </script>
</body>
</html>
