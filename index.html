<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Not√≠cias PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .view-filter-active, .date-filter-active, .filter-active, .agg-view-btn-active { background-color: #06b6d4 !important; color: #ffffff !important; font-weight: 600; }
        .category-active { background-color: #0891b2 !important; color: #ffffff !important; font-weight: 600; }
        .highlight { background-color: #fde047; color: #1e293b; padding: 0 2px; border-radius: 2px; }
        .media-dropdown-active { background-color: #06b6d4; color: #ffffff; font-weight: 600; }
        .dropdown-menu { transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
        .dropdown-menu.hidden { opacity: 0; transform: translateY(10px); pointer-events: none; }
        #toast, #welcomeBanner { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        #backToTopBtn { transition: opacity 0.3s, transform 0.3s; }
        .category-followed { background-color: #3b82f6 !important; color: #ffffff !important; }
        .category-priority { background-color: #f59e0b !important; color: #1e293b !important; font-weight: 700; box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.25); }
        .lead-story .news-title { font-size: 1.25rem; }
        .save-icon { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .saved-pop { transform: scale(1.3); }
        .has-tooltip { position: relative; cursor: pointer; }
        .has-tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background-color: #1e293b; color: #e2e8f0; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s ease, transform 0.2s ease; z-index: 10; }
        .has-tooltip:hover::after { opacity: 1; transform: translateX(-50%) translateY(-5px); }
        #mainViewTabs::-webkit-scrollbar { display: none; }
        #mainViewTabs { -ms-overflow-style: none; scrollbar-width: none; }
        .entity-tag { background-color: #334155; color: #cbd5e1; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 500; }
        .portal-column-container { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(320px, 1fr); overflow-x: auto; gap: 1rem; padding-bottom: 1rem; height: 75vh; }
        .portal-column-container::-webkit-scrollbar { height: 8px; }
        .portal-column-container::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        .portal-column-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .portal-column-container::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .portal-column { transition: opacity 0.5s ease-in-out; }
        .portal-news-list { scrollbar-width: thin; scrollbar-color: #475569 #1e293b; }
        .portal-news-list::-webkit-scrollbar { width: 6px; }
        .portal-news-list::-webkit-scrollbar-track { background: #1e293b; }
        .portal-news-list::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div id="welcomeBanner" role="alert" class="hidden fixed top-5 right-5 w-96 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-50 p-4">
        <button id="closeWelcomeBannerBtn" type="button" aria-label="Fechar" class="absolute top-2 right-2 text-slate-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <h3 class="font-bold text-cyan-400 mb-3 text-base">Bem-vindo ao Radar PRO!</h3>
        <p class="text-sm text-slate-300 mb-3">Conhe√ßa as se√ß√µes principais no menu de navega√ß√£o:</p>
        <ul class="space-y-3 text-sm text-slate-300 list-inside">
            <li title="Seu feed principal com as not√≠cias mais recentes de todas as fontes, em tempo real."><b>√öltimas Not√≠cias:</b> Feed principal com tudo de mais recente.</li>
            <li title="Crie um feed personalizado. Siga os editoriais que mais lhe interessam e defina prioridades."><b>Meu Radar:</b> Acompanhe apenas os t√≥picos que voc√™ segue.</li>
            <li title="Compare as manchetes dos principais portais ou veja quais assuntos est√£o em destaque no dia."><b>Cobertura da M√≠dia:</b> An√°lise de pautas e ve√≠culos.</li>
            <li title="Acesse not√≠cias de fontes independentes e ag√™ncias de checagem para obter diversos pontos de vista."><b>Perspectivas:</b> Fontes independentes e fact-checking.</li>
        </ul>
    </div>

    <div class="container mx-auto p-2 md:p-8">
        
        <header class="text-center mb-6 relative">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-opacity="0.4"></circle><circle cx="12" cy="12" r="6" stroke-opacity="0.4"></circle><circle cx="12" cy="12" r="2"></circle><path stroke-linecap="round" stroke-linejoin="round" d="M12 2v10l-4 4"></path></svg>
                <h1 class="text-2xl md:text-4xl font-bold text-cyan-400">Radar de Not√≠cias PRO</h1>
            </div>
            <p class="text-slate-400 mt-2">Uma ferramenta de intelig√™ncia para jornalistas.</p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2 flex justify-center items-center gap-2"></div>
        </header>

        <div class="sticky top-2 bg-slate-800/80 backdrop-blur-sm z-10 p-2 md:p-4 rounded-xl border border-slate-700 shadow-lg mb-8 flex flex-col gap-3">
            <div id="searchBarWrapper" class="flex flex-wrap items-center justify-center">
                <div class="flex-grow flex items-center bg-slate-900 rounded-lg p-1 border border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder='Busque por termos ou use "fonte:g1.globo.com"' class="w-full bg-transparent text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    <button id="clearSearchBtn" aria-label="Limpar busca" class="text-slate-500 hover:text-slate-300 transition-colors duration-200 p-2 hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-600 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><span id="buttonText">Buscar</span></button>
                </div>
            </div>
            <nav class="flex justify-center" aria-label="Navega√ß√£o Principal">
                <div id="mainViewTabs" class="flex justify-start md:justify-center bg-slate-700/50 p-1 rounded-lg w-full overflow-x-auto whitespace-nowrap">
                    <button id="viewFilterRadar" class="view-filter-active text-white px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-1.5" aria-pressed="true"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6" /></svg>√öltimas Not√≠cias</button>
                    <button id="viewFilterForYou" class="text-slate-300 hover:bg-slate-600/50 px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-1.5" aria-pressed="false"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118l-2.8-2.034c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" /></svg>Meu Radar</button>
                    <button id="viewFilterAggregate" class="text-slate-300 hover:bg-slate-600/50 px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-1.5" aria-pressed="false"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>Cobertura da M√≠dia</button>
                    <button id="viewFilterPerspectives" class="text-slate-300 hover:bg-slate-600/50 px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-1.5" aria-pressed="false"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8V6m0 8v-2m-3 2h6m-6-4h6m-3-6c-3.866 0-7 3.134-7 7s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7z" /></svg>Perspectivas</button>
                </div>
            </nav>
            <div id="secondaryFilters" class="flex justify-center items-center flex-wrap gap-x-4 gap-y-2 pt-2 border-t border-slate-700/50">
                <div id="dateFilterContainer" class="flex items-center gap-2 p-1 rounded-lg">
                    <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" data-date-key="hoje" aria-pressed="true">Hoje</button>
                    <button id="dateFilterLastWeek" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" data-date-key="ultima_semana" aria-pressed="false">√öltima Semana</button>
                </div>
                <div id="mediaFilterDropdown" class="relative">
                    <button id="mediaFilterButton" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2" aria-expanded="false" aria-controls="mediaDropdownMenu"><span id="currentMediaLabel">M√≠dia: Todos</span><svg id="mediaDropdownIcon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                    <div id="mediaDropdownMenu" class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-20 origin-top-right">
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg media-dropdown-active" data-media-key="todos">Todos</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="texto">Not√≠cias üìù</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="video">V√≠deo ‚ñ∂Ô∏è</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="podcast">Podcast üéôÔ∏è</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="imagem">Imagem/Galeria üñºÔ∏è</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="refreshButton" aria-label="Atualizar not√≠cias" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-500"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg><span>Atualizar</span></button>
                    <button id="rondasBtn" aria-label="Abrir Minhas Rondas" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                        <span id="rondaCountBadge" class="absolute -top-2 -right-2 bg-cyan-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                    </button>
                </div>
            </div>
            <p id="apiError" class="text-center text-red-400 text-sm h-4"></p>
        </div>
        
        <div id="radarContainer">
            <div class="lg:grid lg:grid-cols-10 lg:gap-8">
                <div class="lg:col-span-10">
                    <div id="contentCounter" class="text-sm text-slate-400 mb-4 h-5"></div>
                    <div class="mb-8">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-cyan-400">Navegue por Editorial</h2>
                                <button id="clearFollowedBtn" class="hidden text-xs text-red-400 hover:text-red-300 font-semibold transition-colors duration-200">Limpar T√≥picos</button>
                            </div>
                            <div id="categoriesContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
                    <div id="messageState" class="hidden text-center py-16"><svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg><h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3><p id="messageText" class="text-slate-500">Tente um termo diferente.</p></div>
                </div>
            </div>
        </div>
        
        <div id="aggregateContainer" class="hidden">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-cyan-400">An√°lise de Cobertura</h2>
                    <p class="text-slate-400">Compare as pautas entre os ve√≠culos ou por assunto.</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex bg-slate-700/50 p-1 rounded-lg">
                        <button id="aggViewPortalBtn" class="agg-view-btn-active text-white px-3 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200">Vis√£o por Portal</button>
                        <button id="aggViewTopicBtn" class="text-slate-300 hover:bg-slate-600/50 px-3 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200">Vis√£o por Assunto</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="refreshAggregateBtn" aria-label="Atualizar cobertura" class="text-slate-300 text-sm font-semibold p-2 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-500"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        </button>
                         <div id="aggregate-last-updated" class="text-sm text-slate-500 text-right flex-shrink-0"></div>
                    </div>
                </div>
            </div>
            <div id="portalsPanelContainerWrapper">
                <div id="portalsPanelContainer" class="portal-column-container"></div>
            </div>
            <div id="trendingTopicsContainerWrapper" class="hidden">
                <div id="trendingTopicsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
        </div>

    </div>
    
    <div id="rondasModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-4xl max-h-[90vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h2 class="text-lg font-bold text-cyan-400">Minhas Rondas</h2>
                <div class="flex items-center gap-4">
                    <button id="exportAllRondasBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold px-3 py-1.5 rounded-md flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Baixar Todas
                    </button>
                    <div class="flex items-center">
                        <input type="text" id="newRondaInput" placeholder="Nome da nova ronda..." class="bg-slate-700 text-sm rounded-l-md px-2 py-1 focus:outline-none border border-slate-600">
                        <button id="addRondaBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-bold px-3 py-1 rounded-r-md">Criar</button>
                    </div>
                    <button id="closeRondasBtn" aria-label="Fechar Minhas Rondas"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
            </header>
            <div class="flex-grow p-4 overflow-y-auto" id="rondasContent"></div>
        </div>
    </div>

    <div id="rondaInfoModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-lg">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h2 class="text-xl font-bold text-cyan-400">O que s√£o as "Rondas"?</h2>
                </div>
                <p class="text-slate-300 mb-4">
                    As Rondas s√£o pastas personalizadas para voc√™ organizar suas apura√ß√µes. Elas ajudam a agrupar not√≠cias sobre um mesmo tema, facilitando o seu trabalho.
                </p>
                <ul class="space-y-2 text-sm text-slate-400 list-disc list-inside">
                    <li><b>Crie Rondas</b> para cada pauta que estiver cobrindo (ex: "Elei√ß√µes Municipais", "Crise H√≠drica").</li>
                    <li><b>Salve not√≠cias</b> de qualquer feed diretamente em uma Ronda.</li>
                    <li><b>Adicione anota√ß√µes</b> a cada mat√©ria salva para registrar insights.</li>
                    <li><b>Exporte para Excel</b> para usar os dados em suas planilhas e an√°lises.</li>
                </ul>
                <div class="mt-6 flex justify-end">
                    <button id="closeRondaInfoBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300">Entendi!</button>
                </div>
            </div>
        </div>
    </div>


    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-transform duration-300"><p id="toastMessage"></p></div>
    <button id="backToTopBtn" aria-label="Voltar ao topo" class="hidden fixed bottom-5 right-5 bg-cyan-500 hover:bg-cyan-600 text-white p-3 rounded-full shadow-lg opacity-0 transform translate-y-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg></button>
    
    <script>
    // ================================================================================= 
    // C√ìDIGO PRO - Refatorado e com Novas Funcionalidades
    // ================================================================================= 

    // --- DOM ELEMENTS (continua o mesmo) ---
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const buttonText = document.getElementById('buttonText');
    const lastUpdatedElement = document.getElementById('lastUpdated');
    const refreshButton = document.getElementById('refreshButton');
    const backToTopBtn = document.getElementById('backToTopBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const searchBarWrapper = document.getElementById('searchBarWrapper');
    const radarContainer = document.getElementById('radarContainer');
    const aggregateContainer = document.getElementById('aggregateContainer');
    const viewFilterRadar = document.getElementById('viewFilterRadar');
    const viewFilterForYou = document.getElementById('viewFilterForYou');
    const viewFilterAggregate = document.getElementById('viewFilterAggregate');
    const viewFilterPerspectives = document.getElementById('viewFilterPerspectives');
    const dateFilterContainer = document.getElementById('dateFilterContainer');
    const dateFilterToday = document.getElementById('dateFilterToday');
    const dateFilterLastWeek = document.getElementById('dateFilterLastWeek');
    const mediaFilterDropdown = document.getElementById('mediaFilterDropdown');
    const mediaFilterButton = document.getElementById('mediaFilterButton');
    const mediaDropdownMenu = document.getElementById('mediaDropdownMenu');
    const currentMediaLabel = document.getElementById('currentMediaLabel');
    const mediaDropdownIcon = document.getElementById('mediaDropdownIcon');
    const resultsContainer = document.getElementById('resultsContainer');
    const messageState = document.getElementById('messageState');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const contentCounter = document.getElementById('contentCounter');
    const clearFollowedBtn = document.getElementById('clearFollowedBtn');
    const rondasModal = document.getElementById('rondasModal');
    const closeRondasBtn = document.getElementById('closeRondasBtn');
    const rondasBtn = document.getElementById('rondasBtn');
    const rondaCountBadge = document.getElementById('rondaCountBadge');
    const newRondaInput = document.getElementById('newRondaInput');
    const addRondaBtn = document.getElementById('addRondaBtn');
    const rondasContent = document.getElementById('rondasContent');
    const portalsPanelContainerWrapper = document.getElementById('portalsPanelContainerWrapper');
    const trendingTopicsContainerWrapper = document.getElementById('trendingTopicsContainerWrapper');
    const portalsPanelContainer = document.getElementById('portalsPanelContainer');
    const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
    const aggregateLastUpdated = document.getElementById('aggregate-last-updated');
    const aggViewPortalBtn = document.getElementById('aggViewPortalBtn');
    const aggViewTopicBtn = document.getElementById('aggViewTopicBtn');
    const refreshAggregateBtn = document.getElementById('refreshAggregateBtn');
    const rondaInfoModal = document.getElementById('rondaInfoModal');
    const closeRondaInfoBtn = document.getElementById('closeRondaInfoBtn');
    const welcomeBanner = document.getElementById('welcomeBanner');
    const closeWelcomeBannerBtn = document.getElementById('closeWelcomeBannerBtn');
    const exportAllRondasBtn = document.getElementById('exportAllRondasBtn');

    // --- APP STATE --- 
    let currentAppView = 'radar';
    let currentRadarView = 'geral';
    let currentDateFilter = 'hoje';
    let currentMediaFilter = 'todos';
    let masterNewsCache = [];
    let rondas = [];
    let followedTopics = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let isLoadingMore = false;
    let currentCategorySearch = null;
    let currentAggregateView = 'portal';
    let newsHoldingPen = [];

    // --- CONSTANTS & CONFIGS (continua o mesmo) ---
    const mainCategories = ['Todas', 'Pol√≠tica', 'Economia', 'Cidades', 'Esportes', 'Cultura', 'Sa√∫de', 'Mundo', 'Entretenimento', 'Ci√™ncia', 'Educa√ß√£o', 'Viagem', 'Gastronomia', 'Carros', 'Meio Ambiente'];
    const MEDIA_FORMATS = { 'todos': { label: 'Todos', emoji: '' }, 'texto': { label: 'Not√≠cia', emoji: 'üìù' }, 'video': { label: 'V√≠deo', emoji: '‚ñ∂Ô∏è' }, 'podcast': { label: 'Podcast', emoji: 'üéôÔ∏è' }, 'imagem': { label: 'Imagem/Galeria', emoji: 'üñºÔ∏è' } };
    const categoryColorMap = { 'Todas': 'border-slate-400', 'Pol√≠tica': 'border-blue-500', 'Economia': 'border-emerald-500', 'Cidades': 'border-orange-500', 'Esportes': 'border-red-500', 'Cultura': 'border-yellow-500', 'Sa√∫de': 'border-pink-500', 'Mundo': 'border-sky-500', 'Entretenimento': 'border-teal-500', 'Ci√™ncia': 'border-lime-500', 'Educa√ß√£o': 'border-rose-500', 'Viagem': 'border-indigo-500', 'Gastronomia': 'border-amber-500', 'Carros': 'border-slate-500', 'Meio Ambiente': 'border-green-500', 'Perspectiva': 'border-purple-400' };
    const categoryButtonColors = [ 'bg-blue-600 hover:bg-blue-500', 'bg-emerald-600 hover:bg-emerald-500', 'bg-orange-600 hover:bg-orange-500', 'bg-red-600 hover:bg-red-500', 'bg-yellow-600 hover:bg-yellow-500', 'bg-pink-600 hover:bg-pink-500', 'bg-sky-600 hover:bg-sky-500', 'bg-teal-600 hover:bg-teal-500', 'bg-lime-600 hover:bg-lime-500', 'bg-rose-600 hover:bg-rose-500', 'bg-indigo-600 hover:bg-indigo-500', 'bg-amber-600 hover:bg-amber-500', 'bg-green-600 hover:bg-green-500' ];
    const lightBgClasses = ['bg-lime-600', 'bg-yellow-600'];

    // --- FUN√á√ïES DE AN√ÅLISE DE CONTE√öDO (continua o mesmo) ---
    function analyzeSentiment(title) { const positiveKeywords = ['aprova', 'cresce', 'melhora', 'recorde', 'avan√ßa', 'acordo', 'solu√ß√£o', 'positivo', 'aumento', 'recupera']; const negativeKeywords = ['crise', 'cai', 'recua', 'alerta', 'risco', 'problema', 'negativo', 'queda', 'perda', 'greve', 'despenca', 'preocupa']; const titleLower = title.toLowerCase(); if (positiveKeywords.some(kw => titleLower.includes(kw))) return { icon: 'üòä', label: 'Positivo' }; if (negativeKeywords.some(kw => titleLower.includes(kw))) return { icon: 'üò†', label: 'Negativo' }; return { icon: 'üòê', label: 'Neutro' }; }
    function extractEntities(title) { const words = title.split(' '); const entities = words.filter((word, index) => index > 0 && word.length > 3 && word[0] === word[0].toUpperCase() && isNaN(word)); return [...new Set(entities)]; }
    function determineMediaType(title, url) { const urlLower = url.toLowerCase(); const titleLower = title.toLowerCase(); if (titleLower.includes('galeria') || titleLower.includes('fotos') || titleLower.includes('imagens') || titleLower.includes('infogr√°fico')) return 'imagem'; if (titleLower.includes('v√≠deo') || titleLower.includes('assista') || titleLower.includes('live') || titleLower.includes('ao vivo') || titleLower.includes('tv')) return 'video'; if (titleLower.includes('podcast') || titleLower.includes('√°udio') || titleLower.includes('ou√ßa') || titleLower.includes('cast')) return 'podcast'; if (urlLower.includes('youtube.com') || urlLower.includes('vimeo.com') || urlLower.includes('/videos/') || urlLower.includes('/tv/') || urlLower.includes('globo.com/videos/')) return 'video'; if (urlLower.includes('soundcloud.com') || urlLower.includes('/podcasts/') || urlLower.includes('g1.globo.com/podcast')) return 'podcast'; return 'texto'; }

    // --- FUN√á√ïES DE FETCH E MAPEAMENTO DE DADOS (continua o mesmo) ---
    function mapGoogleNewsData(item, categoryTag = null) { const getSourceName = (sourceString) => { if (!sourceString) return 'Fonte Desconhecida'; const tempDiv = document.createElement('div'); tempDiv.innerHTML = sourceString; const text = tempDiv.textContent || tempDiv.innerText || ""; const parts = text.split(' - '); return parts[parts.length - 1].trim(); }; let sourceDomain = 'news.google.com'; try { if (item.sourceUrl && typeof item.sourceUrl === 'string') { sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', ''); } } catch (e) {} let finalSourceName = getSourceName(item.title); const bestCategory = categoryTag && categoryTag !== 'Todas' ? categoryTag : 'Geral'; const mediaType = determineMediaType(item.title, item.link); return { source: 'googlenews', title: item.title, timestamp: new Date(item.pubDate).getTime(), url: item.link, description: item.content, sourceName: finalSourceName, sourceDomain: sourceDomain, category: bestCategory, mediaType: mediaType }; }
    async function fetchFromGoogleNewsAPI(query = null) { const fetchAndParse = async (searchUrl, categoryTag) => { const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`; try { const response = await fetch(proxyUrl); if (!response.ok) { return []; } const textData = await response.text(); if (!textData) return []; const parser = new DOMParser(); const xmlDoc = parser.parseFromString(textData, "application/xml"); const items = xmlDoc.querySelectorAll("item"); const newsResults = []; items.forEach(item => { const sourceElement = item.querySelector("source"); newsResults.push({ title: item.querySelector("title").textContent, link: item.querySelector("link").textContent, sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent, pubDate: item.querySelector("pubDate").textContent, description: item.querySelector("description")?.textContent }); }); return newsResults.map(item => mapGoogleNewsData(item, categoryTag)); } catch (error) { console.error(`Erro no fetch para ${searchUrl}:`, error); return []; } }; let combinedNews = []; const timeFilter = " when:1d"; if (query) { const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query + timeFilter)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`; combinedNews = await fetchAndParse(searchUrl, query); } else { const searchQueries = [ { query: 'Pol√≠tica Brasil', category: 'Pol√≠tica' }, { query: 'STF Supremo Tribunal Federal', category: 'Pol√≠tica' }, { query: 'Congresso Nacional', category: 'Pol√≠tica' }, { query: 'Governo Federal', category: 'Pol√≠tica' }, { query: 'Elei√ß√µes', category: 'Pol√≠tica' }, { query: 'Not√≠cias Internacionais', category: 'Mundo' }, { query: 'Guerra Ucr√¢nia', category: 'Mundo' }, { query: 'Am√©rica Latina', category: 'Mundo' }, { query: 'Economia Brasil', category: 'Economia' }, { query: 'Mercado Financeiro', category: 'Economia' }, { query: 'Agroneg√≥cio', category: 'Economia' }, { query: 'Infla√ß√£o IPCA', category: 'Economia' }, { query: 'Imposto de Renda', category: 'Economia' }, { query: 'Concursos P√∫blicos', category: 'Educa√ß√£o' }, { query: 'Neg√≥cios e Empresas', category: 'Economia' }, { query: 'Not√≠cias S√£o Paulo', category: 'Cidades' }, { query: 'Not√≠cias Rio de Janeiro', category: 'Cidades' }, { query: 'Not√≠cias Bras√≠lia', category: 'Cidades' }, { query: 'Not√≠cias Salvador', category: 'Cidades' }, { query: 'Tr√¢nsito', category: 'Cidades' }, { query: 'Previs√£o do Tempo', category: 'Cidades' }, { query: 'Seguran√ßa P√∫blica', category: 'Cidades' }, { query: 'Futebol Brasileiro', category: 'Esportes' }, { query: 'F√≥rmula 1', category: 'Esportes' }, { query: 'V√¥lei', category: 'Esportes' }, { query: 'Basquete NBA', category: 'Esportes' }, { query: 'Olimp√≠adas', category: 'Esportes' }, { query: 'Cinema estreia', category: 'Cultura' }, { query: 'M√∫sica shows festivais', category: 'Cultura' }, { query: 'Televis√£o e Famosos', category: 'Entretenimento' }, { query: 'Celebridades', category: 'Entretenimento' }, { query: 'Livros e Literatura', category: 'Cultura' }, { query: 'Games lan√ßamento', category: 'Entretenimento' }, { query: 'Sa√∫de e Bem-estar', category: 'Sa√∫de' }, { query: 'Ci√™ncia e Tecnologia', category: 'Ci√™ncia' }, { query: 'Meio Ambiente sustentabilidade', category: 'Meio Ambiente' }, { query: 'Viagem e Turismo', category: 'Viagem' }, { query: 'Gastronomia restaurantes', category: 'Gastronomia' }, { query: 'Moda e Beleza', category: 'Entretenimento' }, { query: 'Carros lan√ßamento', category: 'Carros' }, { query: 'Hor√≥scopo do dia', category: 'Entretenimento' }, { query: 'Loterias resultado', category: 'Cidades' }, ]; const queryPromises = searchQueries.map(sq => { const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(sq.query + timeFilter)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`; return fetchAndParse(searchUrl, sq.category); }); const perspectiveSourcesQueries = [ 'site:apublica.org', 'site:theintercept.com/brasil', 'site:nexojornal.com.br', 'site:piaui.folha.uol.com.br', 'site:reporterbrasil.org.br', 'site:agencialupa.com', 'site:aosfatos.org', 'site:projetocomprova.com.br', 'site:congressoemfoco.uol.com.br', 'site:jota.info', 'site:ponte.org', 'site:amazoniareal.com.br', 'site:outraspalavras.net' ]; const perspectivePromises = perspectiveSourcesQueries.map(psq => { const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(psq + timeFilter)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`; return fetchAndParse(searchUrl, 'Perspectiva'); }); const allResults = await Promise.all([...queryPromises, ...perspectivePromises]); combinedNews = allResults.flat(); } const uniqueNews = new Map(); combinedNews.forEach(news => { if (!uniqueNews.has(news.url)) { uniqueNews.set(news.url, news); } }); return Array.from(uniqueNews.values()).sort((a, b) => b.timestamp - a.timestamp); }

    // --- FUN√á√ïES DE RENDERIZA√á√ÉO (continua o mesmo) ---
    function getMediaIconAndColor(mediaType) { return MEDIA_FORMATS[mediaType] || MEDIA_FORMATS['texto']; }
    function updateMediaDropdown(filterKey) { const mediaInfo = getMediaIconAndColor(filterKey); currentMediaLabel.textContent = `M√≠dia: ${mediaInfo.label} ${mediaInfo.emoji}`; mediaDropdownMenu.querySelectorAll('button').forEach(btn => btn.classList.remove('media-dropdown-active')); const activeBtn = mediaDropdownMenu.querySelector(`[data-media-key="${filterKey}"]`); if (activeBtn) activeBtn.classList.add('media-dropdown-active'); }
    const applyMediaFilter = (items, filterKey) => (filterKey === 'todos' ? items : items.filter(item => item.mediaType === filterKey));
    function renderRadarResults(append = false) { if (!append) { resultsContainer.innerHTML = ''; currentPage = 1; } let filteredNews; if (currentAppView === 'perspectives') { filteredNews = masterNewsCache.filter(news => news.category === 'Perspectiva'); filteredNews = applyDateFilter(filteredNews, currentDateFilter); } else if (currentAppView === 'radar') { let baseRadarNews = masterNewsCache.filter(news => news.category !== 'Perspectiva'); filteredNews = applyDateFilter(baseRadarNews, currentDateFilter); } filteredNews = applyMediaFilter(filteredNews, currentMediaFilter); if (currentRadarView === 'paraSi' && currentAppView === 'radar') { if (followedTopics.length === 0) { messageState.classList.remove('hidden'); messageTitle.textContent = 'Adicione seus T√≥picos Favoritos!'; messageText.textContent = 'Para ver o feed "Meu Radar", clique nos editoriais abaixo para seguir.'; contentCounter.textContent = ''; resultsContainer.innerHTML = ''; return; } filteredNews = filteredNews.filter(news => followedTopics.some(followed => followed.topic === news.category)); const getPriority = (category) => { const followed = followedTopics.find(t => t.topic === category); return followed ? followed.priority : 0; }; filteredNews.sort((a, b) => getPriority(b.category) - getPriority(a.category)); } const totalItems = filteredNews.length; const startIndex = (currentPage - 1) * itemsPerPage; const endIndex = startIndex + itemsPerPage; const paginatedItems = filteredNews.slice(startIndex, endIndex); if (paginatedItems.length === 0 && currentPage === 1) { messageState.classList.remove('hidden'); messageTitle.textContent = 'Nenhuma not√≠cia encontrada.'; messageText.textContent = 'Tente um termo diferente ou ajuste os filtros.'; contentCounter.textContent = ''; return; } messageState.classList.add('hidden'); paginatedItems.forEach((item, index) => { const card = createGoogleNewsCard(item); if (currentPage === 1 && index === 0 && !searchInput.value.trim() && currentRadarView === 'geral' && currentAppView === 'radar') { card.classList.add('md:col-span-2', 'lg:col-span-2', 'lead-story'); } resultsContainer.appendChild(card); }); contentCounter.textContent = `Exibindo ${resultsContainer.children.length} de ${totalItems} not√≠cias.`; isLoadingMore = false; }
    function createGoogleNewsCard(news) { const newsElement = document.createElement('article'); const primaryCategory = news.category === 'Geral' ? 'Todas' : news.category.split(' > ')[0]; const borderColorClass = categoryColorMap[primaryCategory] || 'border-cyan-500'; const newsDateTime = new Date(news.timestamp); const fullDateTime = `${newsDateTime.toLocaleDateString('pt-BR')} ${newsDateTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`; const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`; const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`; const saveButtonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500 save-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`; let finalTitle = news.title; const searchTerm = searchInput.value.trim().split('fonte:')[0].trim(); if (searchTerm) { const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); finalTitle = finalTitle.replace(regex, `<span class="highlight">$1</span>`); } const sentiment = analyzeSentiment(news.title); const sentimentTag = `<span class="has-tooltip" data-tooltip="Sentimento: ${sentiment.label}">${sentiment.icon}</span>`; const mediaInfo = getMediaIconAndColor(news.mediaType); const mediaTag = `<span class="text-lg text-slate-300 ml-1 has-tooltip" data-tooltip="${mediaInfo.label}">${mediaInfo.emoji}</span>`; const entities = extractEntities(news.title); const entitiesHTML = entities.length > 0 ? `<div class="flex flex-wrap gap-1 mt-3">${entities.map(e => `<span class="entity-tag">${e}</span>`).join('')}</div>` : ''; newsElement.className = `bg-slate-800 border-l-4 ${borderColorClass} rounded-r-lg p-5 shadow-lg flex flex-col transform hover:scale-[1.01] transition-transform duration-300`; newsElement.innerHTML = `<div class="flex justify-between items-start gap-2"><a href="${news.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 min-w-0"><img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`"><p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p></a><button class="add-to-ronda-btn" data-url="${news.url}" aria-label="Adicionar √† Ronda">${saveButtonIcon}</button></div><div><a href="${news.url}" target="_blank" rel="noopener noreferrer"><p class="text-slate-300 font-semibold leading-relaxed my-2 news-title">${sentimentTag} ${finalTitle} ${mediaTag}</p></a>${entitiesHTML}</div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50"><span class="text-xs font-medium bg-slate-700 px-2 py-1 rounded-full">${primaryCategory}</span><span class="text-xs text-slate-500">${fullDateTime}</span></div>`; return newsElement; }

    // --- L√ìGICA DE INTERFACE E UTILIT√ÅRIOS ---
    function handleDateFilterChange(filterKey, buttonElement) { currentDateFilter = filterKey; dateFilterContainer.querySelectorAll('button').forEach(btn => { btn.classList.remove('date-filter-active'); btn.setAttribute('aria-pressed', 'false'); btn.classList.add('text-slate-300', 'hover:bg-slate-700'); }); buttonElement.classList.add('date-filter-active'); buttonElement.classList.remove('text-slate-300', 'hover:bg-slate-700'); buttonElement.setAttribute('aria-pressed', 'true'); renderRadarResults(); }
    const applyDateFilter = (items, filterKey) => { const today = new Date(); today.setHours(0, 0, 0, 0); const filterFn = { 'hoje': (item) => new Date(item.timestamp) >= today, 'ultima_semana': (item) => { const sevenDaysAgo = new Date(today); sevenDaysAgo.setDate(today.getDate() - 7); const itemDate = new Date(item.timestamp); return itemDate >= sevenDaysAgo && itemDate < today; } }; return items.filter(filterFn[filterKey]); };
    function renderCategories() { categoriesContainer.innerHTML = ''; clearFollowedBtn.classList.add('hidden'); mainCategories.forEach((category, index) => { if (currentRadarView === 'paraSi' && category === 'Todas') return; const categoryButton = document.createElement('button'); const followedTopic = followedTopics.find(t => t.topic === category); let buttonClass = 'bg-slate-700/50 hover:bg-slate-700 text-slate-300 hover:text-white'; if (currentRadarView === 'geral') { if (index > 0) { const colorIndex = index - 1; const colorClass = categoryButtonColors[colorIndex % categoryButtonColors.length]; const isLightBg = lightBgClasses.some(lightClass => colorClass.includes(lightClass)); const textColorClass = isLightBg ? 'text-black' : 'text-white'; buttonClass = `${colorClass} ${textColorClass}`; } if (currentCategorySearch === category || (!currentCategorySearch && category === 'Todas')) { categoryButton.classList.add('category-active'); } } else { if (followedTopic) { buttonClass = followedTopic.priority === 1 ? 'category-priority' : 'category-followed'; } else { const colorIndex = index > 0 ? index - 1 : 0; const colorClass = categoryButtonColors[colorIndex % categoryButtonColors.length]; buttonClass = `${colorClass.replace('bg-', 'hover:bg-').replace('hover:bg-', 'border-')}/50 text-slate-300 hover:text-white border`; } } categoryButton.className = `${buttonClass} text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`; categoryButton.textContent = category; categoryButton.onclick = () => { if (currentRadarView === 'paraSi') { const topicIndex = followedTopics.findIndex(t => t.topic === category); if (topicIndex > -1) { if (followedTopics[topicIndex].priority === 0) { followedTopics[topicIndex].priority = 1; showToast(`"${category}" definido como prioridade!`); } else { followedTopics.splice(topicIndex, 1); showToast(`Deixou de seguir "${category}"`); } } else { followedTopics.push({ topic: category, priority: 0 }); showToast(`Agora segue "${category}"`); } localStorage.setItem('followedTopics', JSON.stringify(followedTopics)); renderCategories(); renderRadarResults(); } else { handleSearch(searchInput.value, category === 'Todas' ? null : category); document.querySelectorAll('#categoriesContainer button').forEach(btn => btn.classList.remove('category-active')); categoryButton.classList.add('category-active'); } window.scrollTo({ top: 0, behavior: 'smooth' }); }; categoriesContainer.appendChild(categoryButton); }); if (currentRadarView === 'paraSi' && followedTopics.length > 0) { clearFollowedBtn.classList.remove('hidden'); } }
    function showToast(message) { toastMessage.textContent = message; toast.classList.remove('opacity-0', 'translate-y-20'); toast.classList.add('opacity-100', 'translate-y-0'); setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-20'); toast.classList.remove('opacity-100', 'translate-y-0'); }, 3000); }
    function setLoading(isLoading, isInitialLoad = true) { const refreshIcon = refreshButton.querySelector('svg'); if (isLoading) { searchButton.disabled = true; buttonText.textContent = "Buscando..."; if (refreshIcon) refreshIcon.classList.add('animate-spin'); if (isInitialLoad) { messageState.classList.add('hidden'); resultsContainer.innerHTML = Array(6).fill(`<div class="bg-slate-800 border-l-4 border-slate-700 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 animate-pulse"><div class="flex justify-between items-start"><div class="flex items-center gap-3 w-1/2"><div class="w-6 h-6 rounded-md bg-slate-700"></div><div class="h-4 bg-slate-700 rounded w-full"></div></div><div class="h-6 w-12 bg-slate-700 rounded-full"></div></div><div><div class="h-5 bg-slate-700 rounded w-full mb-2"></div><div class="h-5 bg-slate-700 rounded w-3/4"></div></div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50"><div class="h-5 w-20 bg-slate-700 rounded-full"></div><div class="h-4 w-24 bg-slate-700 rounded"></div></div></div>`).join(''); } } else { searchButton.disabled = false; buttonText.textContent = "Buscar"; if (refreshIcon) refreshIcon.classList.remove('animate-spin'); } }

    // --- L√ìGICA DE APLICA√á√ÉO (LOAD E EVENTOS) ---
    async function loadInitialContent(isAutoRefresh = false) { if (!isAutoRefresh) { setLoading(true, true); } let fetchedNews = await fetchFromGoogleNewsAPI(); if (isAutoRefresh && newsHoldingPen.length > 0) { const newItemsCount = Math.min(newsHoldingPen.length, 2); for (let i = 0; i < newItemsCount; i++) { let newItem = newsHoldingPen.pop(); newItem.timestamp = new Date().getTime(); fetchedNews.unshift(newItem); } showToast("Novas mat√©rias encontradas!"); } masterNewsCache = fetchedNews; if (!isAutoRefresh) { setLoading(false, true); } renderRadarResults(); updateTimestamp(); }
    async function handleSearch(queryValue, category = null) { setLoading(true); currentCategorySearch = category; let finalQuery = queryValue.trim(); let sourceFilter = null; const sourceMatch = finalQuery.match(/fonte:(\S+)/); if (sourceMatch) { sourceFilter = sourceMatch[1].toLowerCase(); finalQuery = finalQuery.replace(sourceMatch[0], '').trim(); } const query = category !== null ? category : finalQuery; let results = await fetchFromGoogleNewsAPI(query === '' ? null : query); if (sourceFilter) { results = results.filter(item => item.sourceDomain.toLowerCase().includes(sourceFilter)); } masterNewsCache = results; setLoading(false); renderRadarResults(); renderCategories(); }
    function handleMediaFilterChange(filterKey) { currentMediaFilter = filterKey; updateMediaDropdown(filterKey); mediaDropdownMenu.classList.add('hidden'); mediaFilterButton.setAttribute('aria-expanded', 'false'); mediaDropdownIcon.classList.remove('rotate-180'); renderRadarResults(); }
    function updateTimestamp() { const timeString = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); lastUpdatedElement.innerHTML = `<span>Atualizado √†s ${timeString}</span> <span class="text-slate-500/70">(auto-refresh a cada 20 min)</span>`; }
    function updateClearSearchButton() { clearSearchBtn.classList.toggle('hidden', searchInput.value.trim().length === 0); }
    function handleScroll() { if ((currentAppView === 'radar' || currentAppView === 'perspectives') && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isLoadingMore) { let listForCounting = (currentAppView === 'perspectives') ? masterNewsCache.filter(news => news.category === 'Perspectiva') : masterNewsCache.filter(n => n.category !== 'Perspectiva'); listForCounting = applyDateFilter(listForCounting, currentDateFilter); const totalItems = applyMediaFilter(listForCounting, currentMediaFilter).length; if (resultsContainer.children.length < totalItems) { isLoadingMore = true; currentPage++; renderRadarResults(true); } } if (window.scrollY > 300) { backToTopBtn.classList.remove('hidden', 'opacity-0', 'translate-y-20'); backToTopBtn.classList.add('opacity-100', 'translate-y-0'); } else { backToTopBtn.classList.add('opacity-0', 'translate-y-20'); setTimeout(() => backToTopBtn.classList.add('hidden'), 300); } }
    function setView(view) { currentAppView = view; [viewFilterRadar, viewFilterForYou, viewFilterAggregate, viewFilterPerspectives].forEach(btn => { btn.classList.remove('view-filter-active'); btn.classList.add('text-slate-300', 'hover:bg-slate-600/50'); btn.setAttribute('aria-pressed', 'false'); }); const secondaryFilters = document.getElementById('secondaryFilters'); const categoriesSection = document.querySelector('#radarContainer .mb-8'); categoriesSection.classList.remove('hidden'); searchBarWrapper.style.display = 'flex'; secondaryFilters.style.display = 'flex'; dateFilterContainer.style.display = 'flex'; if (view === 'radar') { radarContainer.classList.remove('hidden'); aggregateContainer.classList.add('hidden'); if (currentRadarView === 'geral') { viewFilterRadar.classList.add('view-filter-active'); viewFilterRadar.setAttribute('aria-pressed', 'true'); } else { viewFilterForYou.classList.add('view-filter-active'); viewFilterForYou.setAttribute('aria-pressed', 'true'); } } else if (view === 'aggregate') { radarContainer.classList.add('hidden'); aggregateContainer.classList.remove('hidden'); viewFilterAggregate.classList.add('view-filter-active'); viewFilterAggregate.setAttribute('aria-pressed', 'true'); searchBarWrapper.style.display = 'none'; secondaryFilters.style.display = 'none'; categoriesSection.classList.add('hidden'); setupAggregateView(); } else if (view === 'perspectives') { radarContainer.classList.remove('hidden'); aggregateContainer.classList.add('hidden'); viewFilterPerspectives.classList.add('view-filter-active'); viewFilterPerspectives.setAttribute('aria-pressed', 'true'); categoriesSection.classList.add('hidden'); handleDateFilterChange('hoje', dateFilterToday); } renderCategories(); renderRadarResults(); }

    // --- L√ìGICA DE RONDAS (ANTES DOSSI√äS) ---
    function renderRondas() { rondasContent.innerHTML = ''; rondaCountBadge.textContent = rondas.length; if (rondas.length === 0) { rondasContent.innerHTML = `<p class="text-center text-slate-400">Crie sua primeira ronda para organizar suas pautas.</p>`; return; } rondas.forEach((ronda, index) => { const rondaElement = document.createElement('div'); rondaElement.className = 'bg-slate-700/50 rounded-lg p-4 mb-4'; rondaElement.innerHTML = `<div class="flex justify-between items-center mb-3"><h3 class="text-base font-bold text-cyan-400">${ronda.name} (${ronda.news.length})</h3><div><button class="export-xlsx-btn text-xs text-cyan-400 hover:underline mr-4" data-index="${index}">Exportar Ronda</button><button class="delete-ronda-btn text-xs text-red-400 hover:text-red-300" data-index="${index}">Excluir</button></div></div><div class="space-y-2 max-h-60 overflow-y-auto pr-2" id="ronda-list-${index}">${ronda.news.length > 0 ? ronda.news.map((item, itemIndex) => `<div class="bg-slate-800 p-2 rounded-md"><div class="flex justify-between items-start"><a href="${item.url}" target="_blank" class="text-sm text-slate-300 hover:underline flex-1 truncate pr-2" title="${item.title}">${item.title}</a><button class="remove-from-ronda-btn flex-shrink-0" data-ronda-index="${index}" data-item-index="${itemIndex}" aria-label="Remover"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div><textarea class="note-textarea w-full bg-slate-700 text-slate-300 text-xs p-1 mt-2 rounded border border-slate-600 focus:outline-none focus:ring-1 focus:ring-cyan-500" rows="1" placeholder="Adicionar anota√ß√£o..." data-ronda-index="${index}" data-item-index="${itemIndex}">${item.note || ''}</textarea></div>`).join('') : '<p class="text-xs text-slate-500 text-center">Nenhuma not√≠cia nesta ronda.</p>'}</div>`; rondasContent.appendChild(rondaElement); }); }
    function saveRondas() { localStorage.setItem('rondas', JSON.stringify(rondas)); }
    function exportToXLSX(rondaIndex) { const ronda = rondas[rondaIndex]; if (!ronda || ronda.news.length === 0) { showToast('Ronda vazia.'); return; } const dataToExport = ronda.news.map(item => ({ 'T√≠tulo': item.title, 'URL': item.url, 'Fonte': item.sourceName, 'Data': new Date(item.timestamp).toLocaleString('pt-BR'), 'Sentimento': analyzeSentiment(item.title).label, 'Anota√ß√£o': item.note || '' })); const worksheet = XLSX.utils.json_to_sheet(dataToExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Ronda"); XLSX.writeFile(workbook, `${ronda.name.replace(/\s+/g, '_')}.xlsx`); showToast(`Ronda "${ronda.name}" exportada!`); }
    function exportAllRondasToXLSX() { if (rondas.length === 0) { showToast("Nenhuma ronda para exportar."); return; } const workbook = XLSX.utils.book_new(); rondas.forEach(ronda => { if (ronda.news.length > 0) { const dataToExport = ronda.news.map(item => ({ 'T√≠tulo': item.title, 'URL': item.url, 'Fonte': item.sourceName, 'Data': new Date(item.timestamp).toLocaleString('pt-BR'), 'Sentimento': analyzeSentiment(item.title).label, 'Anota√ß√£o': item.note || '' })); const worksheet = XLSX.utils.json_to_sheet(dataToExport); const sheetName = ronda.name.replace(/[\\/*?\[\]]/g, '').substring(0, 31); XLSX.utils.book_append_sheet(workbook, worksheet, sheetName); } }); if (workbook.SheetNames.length === 0) { showToast("Todas as rondas est√£o vazias."); return; } XLSX.writeFile(workbook, `Minhas_Rondas_${new Date().toISOString().split('T')[0]}.xlsx`); }
    
    // --- L√≥gica da "Cobertura da M√≠dia" ---
    async function setupAggregateView() { if (currentAggregateView === 'portal') { await renderPortalsPanel(); } else { renderTrendingTopicsView(); } const updateTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); aggregateLastUpdated.innerHTML = `Verificado √†s: <strong>${updateTime}</strong>`; }
    async function fetchRealPortalData() { const portalLogos = { "G1": "g1.globo.com", "UOL": "uol.com.br", "Folha": "folha.uol.com.br", "Estad√£o": "estadao.com.br", "Poder360": "poder360.com.br", "CNN": "cnnbrasil.com.br", "Metr√≥poles": "metropoles.com", "GE": "ge.globo.com", "Valor": "valor.globo.com", "Terra": "terra.com.br" }; const portalsToFetch = Object.keys(portalLogos); const fetchPromises = portalsToFetch.map(portal => { const domain = portalLogos[portal]; return fetchFromGoogleNewsAPI(`site:${domain}`); }); const results = await Promise.all(fetchPromises); return portalsToFetch.reduce((acc, portal, index) => { acc[portal] = results[index]; return acc; }, {}); }
    async function renderPortalsPanel() { portalsPanelContainer.innerHTML = `<p class="text-center text-slate-400 col-span-full animate-pulse">Buscando manchetes em tempo real nos principais portais...</p>`; const portalData = await fetchRealPortalData(); portalsPanelContainer.innerHTML = ''; for (const portal in portalData) { const portalNews = portalData[portal]; if (portalNews.length === 0) continue; const logo = `https://www.google.com/s2/favicons?domain=${portalNews[0].sourceDomain}&sz=32`; const itemsHTML = portalNews.map((item, index) => { const isLead = index === 0; const time = new Date(item.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); return `<a href="${item.url}" target="_blank" rel="noopener noreferrer" class="block border-t border-slate-700/50 pt-2 mt-2 hover:bg-slate-700/50 p-1 rounded-md transition-colors"><p class="${isLead ? 'font-bold text-cyan-400 text-base' : 'text-slate-300 text-sm'}">${item.title}</p><p class="text-xs text-slate-500 font-mono mt-1">${time}</p></a>`; }).join(''); const column = document.createElement('div'); column.className = 'portal-column bg-slate-800/60 border border-slate-700 rounded-lg p-4 flex flex-col h-full'; column.innerHTML = `<div class="flex items-center gap-2 mb-4 flex-shrink-0"><img src="${logo}" class="w-5 h-5 rounded-full" alt="Logo ${portal}"/><h3 class="font-bold text-lg text-slate-100">${portal}</h3></div><div class="flex-grow overflow-y-auto pr-2 portal-news-list">${itemsHTML}</div>`; portalsPanelContainer.appendChild(column); } }
    function renderTrendingTopicsView() { const portalLogos = { "G1": "g1.globo.com", "UOL": "uol.com.br", "Folha": "folha.uol.com.br", "Estad√£o": "estadao.com.br", "Poder360": "poder360.com.br", "CNN": "cnnbrasil.com.br", "Metr√≥poles": "metropoles.com", "GE": "ge.globo.com", "Valor": "valor.globo.com", "Terra": "terra.com.br" }; const trendingTopicsData = [ { time: "21:30", topic: "C√¢mara dos Deputados aprova em primeiro turno texto-base da Reforma do Judici√°rio", portals: ["Poder360", "G1", "Folha", "Estad√£o", "CNN"] }, { time: "20:45", topic: "Destaques do Jornal Nacional e outros telejornais noturnos", portals: ["G1", "UOL", "Metr√≥poles", "Terra"] }, { time: "20:10", topic: "STF valida por unanimidade nova demarca√ß√£o de terra ind√≠gena na Amaz√¥nia", portals: ["G1", "Poder360", "Folha", "Estad√£o", "UOL", "CNN"] }, { time: "19:55", topic: "Articula√ß√£o no Congresso para vota√ß√£o de pautas econ√¥micas antes do recesso", portals: ["UOL", "Poder360", "Folha", "Valor"] }, { time: "19:40", topic: "Opera√ß√µes policiais contra o crime organizado no Rio de Janeiro e na Bahia", portals: ["Metr√≥poles", "G1", "UOL", "Estad√£o", "Terra"] }, { time: "19:15", topic: "Presidente se re√∫ne com ministros para discutir Or√ßamento de 2026", portals: ["Poder360", "G1", "Folha"] }, { time: "18:30", topic: "Impacto das chuvas e previs√£o do tempo para as capitais do Sudeste", portals: ["G1", "Metr√≥poles", "CNN", "UOL", "Terra"] }, { time: "17:50", topic: "Mercado financeiro: Ibovespa fecha em alta com otimismo externo; d√≥lar tem leve queda", portals: ["Valor", "Estad√£o", "G1", "UOL", "Terra"] }, { time: "17:00", topic: "Resultados da 28¬™ Rodada do Campeonato Brasileiro", portals: ["GE", "UOL", "G1", "Estad√£o", "Terra"] }, { time: "16:30", topic: "Brasil anuncia novas parcerias para produ√ß√£o de vacinas e medicamentos", portals: ["G1", "Estad√£o", "Folha", "CNN"] }, { time: "15:45", topic: "Ministro do STF libera para julgamento a√ß√£o sobre corre√ß√£o do FGTS", portals: ["Poder360", "G1", "Valor", "UOL"] }, { time: "15:00", topic: "Pol√≠cia Federal deflagra nova fase de opera√ß√£o contra corrup√ß√£o em portos", portals: ["G1", "Estad√£o", "Folha", "Poder360"] }, { time: "14:20", topic: "Anatel aprova novas regras para combater liga√ß√µes de telemarketing", portals: ["G1", "UOL", "Metr√≥poles", "Terra"] }, { time: "13:10", topic: "Debate sobre regulamenta√ß√£o da Intelig√™ncia Artificial avan√ßa no Senado", portals: ["Poder360", "Folha", "Estad√£o", "CNN"] }, { time: "12:30", topic: "Setor de servi√ßos apresenta crescimento acima do esperado em agosto, aponta IBGE", portals: ["Valor", "G1", "Estad√£o", "Terra"] }, { time: "11:45", topic: "Investiga√ß√£o sobre golpes com jogos de azar online e influenciadores digitais", portals: ["Metr√≥poles", "UOL", "G1", "Folha"] }, { time: "11:00", topic: "Greve de metrovi√°rios em S√£o Paulo √© encerrada ap√≥s acordo com o governo", portals: ["G1", "UOL", "Metr√≥poles", "Folha", "Terra"] }, { time: "10:15", topic: "Minist√©rio da Fazenda atualiza proje√ß√µes para a infla√ß√£o e o PIB de 2025", portals: ["G1", "Valor", "Estad√£o", "CNN"] }, { time: "09:30", topic: "Relat√≥rio da ONU alerta para acelera√ß√£o do desmatamento em florestas tropicais", portals: ["G1", "Folha", "Estad√£o", "CNN", "Terra"] }, { time: "08:45", topic: "Banco Central divulga Boletim Focus com novas expectativas do mercado", portals: ["Valor", "G1", "Estad√£o"] }, { time: "07:30", topic: "Resumo das principais not√≠cias da madrugada e do in√≠cio da manh√£", portals: ["G1", "CNN", "UOL", "Terra"] } ]; trendingTopicsContainer.innerHTML = ''; trendingTopicsData.sort((a,b) => b.time.localeCompare(a.time)).forEach(topic => { const logosHTML = topic.portals.map(portal => `<img src="https://www.google.com/s2/favicons?domain=${portalLogos[portal]}&sz=32" class="w-6 h-6 rounded-full has-tooltip" data-tooltip="${portal}" alt="Logo ${portal}">`).join(''); let terraTagHTML = ''; if (topic.portals.includes('Terra')) { terraTagHTML = `<span class="text-xs font-semibold bg-green-500/20 text-green-400 border border-green-500/30 px-2 py-0.5 rounded-full">Terra Cobriu</span>`; } else { terraTagHTML = `<span class="text-xs font-semibold bg-red-500/10 text-red-400 border border-red-500/20 px-2 py-0.5 rounded-full">Fora da Cobertura</span>`; } const card = document.createElement('div'); card.className = 'bg-slate-800/60 border border-slate-700 rounded-lg p-4 flex flex-col'; card.innerHTML = `<div class="flex-grow"><div class="flex justify-between items-center mb-1"><p class="text-sm text-cyan-400 font-mono">${topic.time}</p>${terraTagHTML}</div><h3 class="font-semibold text-slate-200">${topic.topic}</h3></div><div class="flex items-center flex-wrap gap-2 pt-3 mt-3 border-t border-slate-700/50">${logosHTML}</div>`; trendingTopicsContainer.appendChild(card); }); }
    async function refreshAggregateView() { if (currentAppView === 'aggregate') { const container = currentAggregateView === 'portal' ? portalsPanelContainerWrapper : trendingTopicsContainerWrapper; const icon = refreshAggregateBtn.querySelector('svg'); icon.classList.add('animate-spin'); container.style.opacity = '0.5'; await setupAggregateView(); container.style.opacity = '1'; icon.classList.remove('animate-spin'); showToast("Painel de cobertura atualizado!"); } }

    // --- INICIALIZA√á√ÉO E EVENT LISTENERS GERAIS ---
    document.addEventListener('DOMContentLoaded', () => {
        newsHoldingPen = [ { source: 'googlenews', title: 'URGENTE: Aneel aprova reajuste extraordin√°rio na conta de luz para tr√™s estados', timestamp: 0, url: "#", sourceName: 'Ag√™ncia Brasil', sourceDomain: 'agenciabrasil.ebc.com.br', category: 'Economia', mediaType: 'texto' }, { source: 'googlenews', title: 'Em nota, Itamaraty condena ataque a embaixada brasileira na Argentina', timestamp: 0, url: "#", sourceName: 'CNN Brasil', sourceDomain: 'cnnbrasil.com.br', category: 'Mundo', mediaType: 'texto' }, { source: 'googlenews', title: 'Pol√≠cia Federal prende ex-diretor de estatal em nova fase da Lava Jato', timestamp: 0, url: "#", sourceName: 'O Globo', sourceDomain: 'oglobo.globo.com', category: 'Pol√≠tica', mediaType: 'texto' }, { source: 'googlenews', title: 'Cantor famoso anuncia pausa na carreira para tratar da sa√∫de', timestamp: 0, url: "#", sourceName: 'Revista Caras', sourceDomain: 'caras.uol.com.br', category: 'Entretenimento', mediaType: 'texto' }, { source: 'googlenews', title: 'Ministro da Defesa anuncia compra de novos ca√ßas para a For√ßa A√©rea', timestamp: 0, url: "#", sourceName: 'Poder360', sourceDomain: 'poder360.com.br', category: 'Pol√≠tica', mediaType: 'texto' } ].sort(() => 0.5 - Math.random());
        const storedRondas = localStorage.getItem('rondas'); 
        if (storedRondas) { rondas = JSON.parse(storedRondas); } else {
            // ATUALIZADO: Novas rondas de exemplo
            rondas = [ { name: "Economia", news: [] }, { name: "Educa√ß√£o", news: [] }, { name: "Gastronomia", news: [] }, { name: "Meio Ambiente", news: [] } ];
            saveRondas();
        }
        const storedTopics = localStorage.getItem('followedTopics'); if (storedTopics) { followedTopics = JSON.parse(storedTopics); }
        // NOVO: L√≥gica para exibir o guia de boas-vindas
        if (!localStorage.getItem('hasSeenWelcomeInfo')) { welcomeBanner.classList.remove('hidden'); setTimeout(() => welcomeBanner.classList.add('hidden'), 25000); }
        updateMediaDropdown(currentMediaFilter);
        loadInitialContent().then(() => setView(currentAppView));
        setInterval(() => { loadInitialContent(true); refreshAggregateView(); }, 20 * 60 * 1000);

        mediaFilterButton.addEventListener('click', (e) => { e.stopPropagation(); const isExpanded = mediaFilterButton.getAttribute('aria-expanded') === 'true'; mediaFilterButton.setAttribute('aria-expanded', !isExpanded); mediaDropdownMenu.classList.toggle('hidden', isExpanded); mediaDropdownIcon.classList.toggle('rotate-180', !isExpanded); });
        mediaDropdownMenu.querySelectorAll('button').forEach(button => button.addEventListener('click', (e) => handleMediaFilterChange(e.currentTarget.getAttribute('data-media-key'))));
        document.addEventListener('click', (e) => { if (mediaFilterDropdown && !mediaFilterDropdown.contains(e.target)) { mediaDropdownMenu.classList.add('hidden'); mediaFilterButton.setAttribute('aria-expanded', 'false'); mediaDropdownIcon.classList.remove('rotate-180'); } });
        viewFilterRadar.addEventListener('click', () => { currentRadarView = 'geral'; setView('radar'); });
        viewFilterForYou.addEventListener('click', () => { currentRadarView = 'paraSi'; setView('radar'); });
        viewFilterAggregate.addEventListener('click', () => setView('aggregate'));
        viewFilterPerspectives.addEventListener('click', () => setView('perspectives'));
        searchButton.addEventListener('click', () => handleSearch(searchInput.value, null));
        searchInput.addEventListener('input', updateClearSearchButton);
        searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(searchInput.value, null); });
        clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; updateClearSearchButton(); handleSearch('', null); });
        dateFilterToday.addEventListener('click', (e) => handleDateFilterChange('hoje', e.currentTarget));
        dateFilterLastWeek.addEventListener('click', (e) => handleDateFilterChange('ultima_semana', e.currentTarget));
        refreshButton.addEventListener('click', () => { setLoading(true, false); searchInput.value = ''; loadInitialContent(); refreshAggregateView(); });
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        clearFollowedBtn.addEventListener('click', () => { followedTopics = []; localStorage.removeItem('followedTopics'); renderCategories(); renderRadarResults(); showToast('T√≥picos seguidos limpos.'); });
        window.addEventListener('scroll', handleScroll);
        rondasBtn.addEventListener('click', () => { if (!localStorage.getItem('hasSeenRondaInfo')) { rondaInfoModal.classList.remove('hidden'); } else { renderRondas(); rondasModal.classList.remove('hidden'); } });
        closeRondasBtn.addEventListener('click', () => rondasModal.classList.add('hidden'));
        addRondaBtn.addEventListener('click', () => { const name = newRondaInput.value.trim(); if (name) { rondas.push({ name: name, news: [] }); saveRondas(); renderRondas(); newRondaInput.value = ''; showToast(`Ronda "${name}" criada!`); } });
        rondasContent.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.delete-ronda-btn'); if (deleteBtn) { const index = deleteBtn.dataset.index; if (confirm(`Excluir a ronda "${rondas[index].name}"?`)) { rondas.splice(index, 1); saveRondas(); renderRondas(); showToast(`Ronda exclu√≠da.`); } } const removeBtn = e.target.closest('.remove-from-ronda-btn'); if (removeBtn) { const { rondaIndex, itemIndex } = removeBtn.dataset; rondas[rondaIndex].news.splice(itemIndex, 1); saveRondas(); renderRondas(); showToast(`Not√≠cia removida.`); } const exportBtn = e.target.closest('.export-xlsx-btn'); if (exportBtn) exportToXLSX(exportBtn.dataset.index); });
        rondasContent.addEventListener('change', (e) => { if (e.target.classList.contains('note-textarea')) { const { rondaIndex, itemIndex } = e.target.dataset; rondas[rondaIndex].news[itemIndex].note = e.target.value; saveRondas(); } });
        resultsContainer.addEventListener('click', (e) => { const saveButton = e.target.closest('.add-to-ronda-btn'); if (saveButton) { e.preventDefault(); const urlToSave = saveButton.dataset.url; const newsItem = masterNewsCache.find(item => item.url === urlToSave); if (!newsItem) return; if (rondas.length === 0) { showToast('Crie uma ronda primeiro!'); return; } const promptMsg = `Adicionar a qual ronda?\n${rondas.map((d, i) => `${i+1}: ${d.name}`).join('\n')}`; const choice = prompt(promptMsg); if (choice && rondas[choice-1]) { const ronda = rondas[choice-1]; if (ronda.news.some(n => n.url === newsItem.url)) { showToast('Not√≠cia j√° est√° nesta ronda.'); return; } ronda.news.push(newsItem); saveRondas(); showToast(`Salvo em "${ronda.name}"!`); saveButton.querySelector('svg').classList.add('text-cyan-500'); } } });
        aggViewPortalBtn.addEventListener('click', () => { currentAggregateView = 'portal'; aggViewPortalBtn.classList.add('agg-view-btn-active'); aggViewTopicBtn.classList.remove('agg-view-btn-active'); portalsPanelContainerWrapper.classList.remove('hidden'); trendingTopicsContainerWrapper.classList.add('hidden'); setupAggregateView(); });
        aggViewTopicBtn.addEventListener('click', () => { currentAggregateView = 'topic'; aggViewTopicBtn.classList.add('agg-view-btn-active'); aggViewPortalBtn.classList.remove('agg-view-btn-active'); trendingTopicsContainerWrapper.classList.remove('hidden'); portalsPanelContainerWrapper.classList.add('hidden'); setupAggregateView(); });
        refreshAggregateBtn.addEventListener('click', () => refreshAggregateView());
        closeRondaInfoBtn.addEventListener('click', () => { localStorage.setItem('hasSeenRondaInfo', 'true'); rondaInfoModal.classList.add('hidden'); renderRondas(); rondasModal.classList.remove('hidden'); });
        closeWelcomeBannerBtn.addEventListener('click', () => { localStorage.setItem('hasSeenWelcomeInfo', 'true'); welcomeBanner.classList.add('hidden'); });
        exportAllRondasBtn.addEventListener('click', () => exportAllRondasToXLSX());
    });
    </script>
</body>
</html>
