<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; } /* light: slate-100 */
        .dark ::-webkit-scrollbar-track { background: #1e293b; } /* dark: slate-800 */
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; } /* light: slate-300 */
        .dark ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; } /* dark: slate-600 */
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; } /* light: slate-400 */
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* dark: slate-500 */

        .loader {
            border-top-color: #06b6d4;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .date-filter-active {
            background-color: #06b6d4 !important;
            color: #ffffff !important;
        }
        .category-active {
            background-color: #0891b2 !important; /* cyan-600 */
            color: #ffffff !important;
            font-weight: 600;
        }
        .highlight {
            background-color: #fde047; /* yellow-300 */
            color: #1e293b; /* slate-800 */
            padding: 0 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-6 relative">
             <!-- Theme Toggle -->
            <button id="themeToggle" class="absolute top-0 right-0 p-2 rounded-full bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors">
                <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>

            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-500 dark:text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="6" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v10l-4 4"></path>
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-600 dark:text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-600 dark:text-slate-400 mt-2">As últimas notícias sobre os principais assuntos do Brasil.</p>
            <div id="lastUpdated" class="text-sm text-slate-500 dark:text-slate-500 mt-2 flex justify-center items-center gap-2"></div>
        </header>

        <!-- Control Panel Menu -->
        <div class="sticky top-4 bg-slate-100/80 dark:bg-slate-800/80 backdrop-blur-sm z-10 p-4 rounded-xl border border-slate-300 dark:border-slate-700 shadow-lg mb-8">
            <div class="flex flex-wrap items-center justify-center gap-4">
                
                <div class="flex-grow flex items-center gap-4 bg-white dark:bg-slate-900 rounded-lg p-1 border border-slate-300 dark:border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder="Busque por um assunto..." class="w-full bg-transparent text-slate-800 dark:text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    
                    <select id="portalFilter" class="bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5">
                        <option selected value="">Todos os Portais</option>
                        <option value="g1.globo.com">G1</option>
                        <option value="uol.com.br">UOL</option>
                        <option value="folha.uol.com.br">Folha de S.Paulo</option>
                        <option value="estadao.com.br">Estadão</option>
                        <option value="r7.com">R7</option>
                        <option value="cnnbrasil.com.br">CNN Brasil</option>
                        <option value="terra.com.br">Terra</option>
                        <option value="valor.globo.com">Valor Econômico</option>
                        <option value="metropoles.com">Metrópoles</option>
                    </select>

                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-400 dark:disabled:bg-slate-600 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span id="buttonText">Buscar</span>
                    </button>
                </div>

            </div>

            <!-- Date Filter -->
            <div class="flex justify-center items-center gap-2 mt-4">
                <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200">Hoje</button>
                <button id="dateFilterYesterday" class="text-slate-600 dark:text-slate-300 text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200 bg-slate-300/50 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-700">Ontem</button>
            </div>
            
            <p id="apiError" class="text-center text-red-500 dark:text-red-400 text-sm mt-3 h-4"></p>
        </div>
        
        <!-- Main Content Area -->
        <div class="lg:grid lg:grid-cols-12 lg:gap-8">
            <div class="lg:col-span-8 xl:col-span-9">
                <div id="loadingState" class="hidden text-center py-16">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-300 dark:border-slate-700 h-12 w-12 mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300">Buscando notícias...</h3>
                </div>
                
                <div id="contentCounter" class="text-sm text-slate-500 dark:text-slate-400 mb-4 h-5"></div>

                <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
                    <!-- News will be dynamically inserted here -->
                </main>

                <!-- Pagination Controls -->
                <div id="paginationControls" class="hidden flex justify-center items-center gap-4 mt-8">
                    <button id="prevPageBtn" class="bg-slate-300/50 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Voltar</button>
                    <span id="pageIndicator" class="text-slate-500 dark:text-slate-400 text-sm font-medium"></span>
                    <button id="nextPageBtn" class="bg-slate-300/50 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Avançar</button>
                </div>
                
                <div id="messageState" class="hidden text-center py-16">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-400 dark:text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    <h3 id="messageTitle" class="text-xl font-semibold text-slate-700 dark:text-slate-300">Nenhum resultado</h3>
                    <p id="messageText" class="text-slate-500 dark:text-slate-500">Tente um termo diferente.</p>
                </div>
            </div>

            <!-- Sidebar Sections -->
            <aside class="lg:col-span-4 xl:col-span-3 mt-8 lg:mt-0">
                <div class="sticky top-28 flex flex-col gap-8">
                    <!-- Trending Topics Section -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                        <h2 class="text-lg font-bold text-cyan-600 dark:text-cyan-400 mb-4">Nuvem de Termos de Hoje</h2>
                        <div id="trendingTopicsContainer" class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 p-2 min-h-[10rem]">
                            <div class="text-center text-slate-500 dark:text-slate-400 p-4">Carregando nuvem de termos...</div>
                        </div>
                    </div>

                    <!-- Categories Section -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                        <h2 class="text-lg font-bold text-cyan-600 dark:text-cyan-400 mb-4">Navegue por Editoria</h2>
                        <div id="categoriesContainer" class="flex flex-wrap gap-2">
                            <!-- Category buttons will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Sub-Categories Section -->
                    <div id="subCategoriesWrapper" class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hidden">
                        <h2 class="text-lg font-bold text-cyan-600 dark:text-cyan-400 mb-4">Sub-editorias</h2>
                        <div id="subCategoriesContainer" class="flex flex-wrap gap-2">
                            <!-- Sub-category buttons will be inserted here -->
                        </div>
                    </div>

                    <!-- Saved News Section -->
                     <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                        <h2 class="text-lg font-bold text-cyan-600 dark:text-cyan-400 mb-4">Lista de Leitura</h2>
                        <div id="savedNewsContainer" class="flex flex-col">
                           <!-- Saved news will be inserted here -->
                        </div>
                    </div>

                </div>
            </aside>
        </div>
        
        <footer class="text-center py-4 mt-8 border-t border-slate-200 dark:border-slate-700">
            <p class="text-sm text-slate-500 dark:text-slate-500">
                Ferramenta desenvolvida por Estratégia de Dados - 
                <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-500 dark:text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const resultsContainer = document.getElementById('resultsContainer');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const portalFilter = document.getElementById('portalFilter');
        const buttonText = document.getElementById('buttonText');
        const messageState = document.getElementById('messageState');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const loadingState = document.getElementById('loadingState');
        const apiError = document.getElementById('apiError');
        const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
        const categoriesContainer = document.getElementById('categoriesContainer');
        const subCategoriesWrapper = document.getElementById('subCategoriesWrapper');
        const subCategoriesContainer = document.getElementById('subCategoriesContainer');
        const savedNewsContainer = document.getElementById('savedNewsContainer');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const dateFilterToday = document.getElementById('dateFilterToday');
        const dateFilterYesterday = document.getElementById('dateFilterYesterday');
        const paginationControls = document.getElementById('paginationControls');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageIndicator = document.getElementById('pageIndicator');
        const contentCounter = document.getElementById('contentCounter');
        const themeToggle = document.getElementById('themeToggle');
        const themeIconSun = document.getElementById('themeIconSun');
        const themeIconMoon = document.getElementById('themeIconMoon');

        // App State
        let currentDateFilter = 'hoje'; // 'hoje', 'ontem'
        let allNewsCache = []; // Cache news to avoid re-fetching
        let currentPage = 1;
        const itemsPerPage = 20;
        let activeCategoryButton = null;
        let savedNews = [];
        let currentCategorySearch = null;

        const subCategoriesMap = {
            'Esportes': ['Futebol', 'Basquete', 'Fórmula 1', 'Vôlei', 'UFC', 'Tênis'],
            'Tecnologia': ['Inteligência Artificial', 'Smartphones', 'Games', 'Startups', 'Inovação'],
            'Cultura': ['Música', 'Cinema', 'Séries', 'Livros', 'Teatro'],
            'Economia': ['Inflação', 'Investimentos', 'Juros', 'Câmbio', 'Bolsa de Valores'],
            'Política': ['Governo', 'Eleições', 'Congresso', 'STF']
        };
        const mainCategories = ['Todas', 'Política', 'Economia', 'Esportes', 'Tecnologia', 'Cultura', 'Saúde', 'Mundo', 'Horóscopo', 'Entretenimento', 'A Fazenda 2025', 'Ciência', 'Educação', 'Viagem', 'Gastronomia', 'Carros', 'Imóveis', 'Música', 'Cinema', 'Games', 'Moda', 'Meio Ambiente'];

        // --- MAPPING HELPERS ---
        function mapGoogleNewsData(item, categoryTag = null) {
            const getSourceName = (sourceString) => {
                if (!sourceString) return 'Fonte Desconhecida';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = sourceString;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                const parts = text.split(' - ');
                return parts[parts.length - 1].trim();
            };

            let sourceDomain = 'news.google.com'; // A safe default
            try {
                if (item.sourceUrl && typeof item.sourceUrl === 'string') {
                    sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', '');
                }
            } catch (e) {
                console.error("Could not parse source URL:", item.sourceUrl, e);
            }

            const tempDivDesc = document.createElement('div');
            tempDivDesc.innerHTML = item.content;
            const imageUrl = tempDivDesc.querySelector('img')?.src || null;
            
            let finalCategory = categoryTag;
            if (!finalCategory) {
                const titleLower = item.title.toLowerCase();
                 for (const [parent, children] of Object.entries(subCategoriesMap)) {
                    const foundSub = children.find(child => titleLower.includes(child.toLowerCase()));
                    if(foundSub) {
                        finalCategory = `${parent} > ${foundSub}`;
                        break;
                    }
                }
                if (!finalCategory) {
                    const foundMain = mainCategories.find(cat => cat !== 'Todas' && titleLower.includes(cat.toLowerCase()));
                    if(foundMain) finalCategory = foundMain;
                }
            }


            return {
                source: 'googlenews',
                title: item.title,
                timestamp: new Date(item.pubDate).getTime(),
                url: item.link,
                description: item.content,
                sourceName: getSourceName(item.title),
                sourceDomain: sourceDomain,
                imageUrl: imageUrl,
                category: finalCategory || 'Geral'
            };
        }
        
        // --- API FETCHER ---
        async function fetchFromGoogleNewsAPI(query = null) {
            const fetchAndParse = async (searchUrl, categoryTag) => {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`;
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        console.warn(`Falha ao buscar notícias de: ${searchUrl}`);
                        return [];
                    }
                    const textData = await response.text();
                    if (!textData) return [];

                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(textData, "application/xml");
                    const items = xmlDoc.querySelectorAll("item");
                    
                    const newsResults = [];
                    items.forEach(item => {
                        const sourceElement = item.querySelector("source");
                        newsResults.push({
                            title: item.querySelector("title").textContent,
                            link: item.querySelector("link").textContent,
                            sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent,
                            pubDate: item.querySelector("pubDate").textContent,
                            content: item.querySelector("description").textContent
                        });
                    });
                    return newsResults.map(item => mapGoogleNewsData(item, categoryTag));
                } catch (error) {
                    console.error(`Erro no fetch para ${searchUrl}:`, error);
                    return [];
                }
            };

            if (query) {
                const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                return fetchAndParse(searchUrl, query);
            } else {
                const categories = ['Brasil', 'Mundo', 'Negócios', 'Ciência e Tecnologia', 'Entretenimento', 'Esportes', 'Saúde'];
                let combinedNews = [];
                for (const cat of categories) {
                    const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(cat)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                    const newsForCat = await fetchAndParse(searchUrl, cat);
                    combinedNews.push(...newsForCat);
                }

                const uniqueNews = new Map();
                combinedNews.forEach(news => {
                    if (!uniqueNews.has(news.url)) {
                        uniqueNews.set(news.url, news);
                    }
                });
                
                return Array.from(uniqueNews.values()).sort((a, b) => b.timestamp - a.timestamp);
            }
        }


        async function fetchTrendingTopics() {
            try {
                const news = await fetchFromGoogleNewsAPI();
                const todayStart = new Date(new Date().setHours(0, 0, 0, 0));
                const todayNews = news.filter(item => new Date(item.timestamp) >= todayStart);

                if (todayNews.length === 0) {
                    trendingTopicsContainer.innerHTML = `<p class="text-sm text-slate-500 dark:text-slate-400 text-center">Nenhuma notícia de hoje para gerar a nuvem de termos.</p>`;
                    return;
                }

                const wordFrequency = {};
                const stopwords = ['a', 'o', 'e', 'é', 'de', 'do', 'da', 'dos', 'das', 'em', 'no', 'na', 'nos', 'nas', 'um', 'uma', 'que', 'com', 'por', 'para', 'se', 'como', 'mas', 'foi', 'ser', 'ter', 'pelo', 'pela', 'seu', 'sua', 'meu', 'minha', 'num', 'à', 'ao', 'qual', 'quando', 'quem', 'são', 'você', 'ele', 'ela', 'nós', 'este', 'esta', 'isto', 'esse', 'essa', 'isso', 'já', 'ou', 'até', 'muito', 'pode', 'sobre', 'está', 'só', 'mais', 'tem', 'era', 'vai', 'pra', 'após', 'diz', 'faz', 'veja', 'ainda'];

                todayNews.forEach(item => {
                    const title = item.title.split(' - ')[0].toLowerCase().replace(/[^\w\s]/g, '');
                    const words = title.split(/\s+/);
                    
                    words.forEach(word => {
                        if (word && word.length > 3 && !stopwords.includes(word)) {
                            wordFrequency[word] = (wordFrequency[word] || 0) + 1;
                        }
                    });
                });

                const sortedKeywords = Object.entries(wordFrequency)
                    .sort(([,a],[,b]) => b - a)
                    .slice(0, 40);

                renderTrendingTopics(sortedKeywords);

            } catch (error) {
                console.error("Trending Topics Error:", error);
                trendingTopicsContainer.innerHTML = `<p class="text-sm text-red-400">Não foi possível carregar os tópicos.</p>`;
            }
        }

        async function loadInitialContent() {
            setLoading(true);
            try {
                const news = await fetchFromGoogleNewsAPI();
                allNewsCache = news;
                renderResults();
                updateTimestamp();
            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }

        // --- RENDERERS & FILTERS ---
        function applyDateFilter(items, filter) {
            const todayStart = new Date(new Date().setHours(0, 0, 0, 0));

            switch (filter) {
                case 'hoje':
                    return items.filter(item => new Date(item.timestamp) >= todayStart);
                case 'ontem':
                    const yesterdayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
                    return items.filter(item => {
                        const itemDate = new Date(item.timestamp);
                        return itemDate >= yesterdayStart && itemDate < todayStart;
                    });
                default:
                    return items;
            }
        }

        function renderTrendingTopics(topics) {
            trendingTopicsContainer.innerHTML = '';
            
            if (topics.length === 0) {
                trendingTopicsContainer.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400 p-4">Nenhum termo popular encontrado hoje.</p>`;
                return;
            }

            const maxFreq = topics[0][1];

            topics.forEach(([word, freq]) => {
                const topicElement = document.createElement('button');
                const ratio = freq / maxFreq;

                let sizeClass = 'text-base';
                let colorClass = 'text-slate-500 dark:text-slate-400';

                if (ratio > 0.7) {
                    sizeClass = 'text-3xl';
                    colorClass = 'text-cyan-600 dark:text-cyan-400';
                } else if (ratio > 0.4) {
                    sizeClass = 'text-xl';
                    colorClass = 'text-slate-700 dark:text-slate-200';
                } else if (ratio > 0.2) {
                    sizeClass = 'text-lg';
                    colorClass = 'text-slate-600 dark:text-slate-300';
                }

                topicElement.className = `font-semibold transition-colors duration-200 ${sizeClass} ${colorClass} hover:text-orange-500 dark:hover:text-orange-400`;
                const capitalizedWord = word.charAt(0).toUpperCase() + word.slice(1);
                topicElement.textContent = capitalizedWord;
                
                topicElement.onclick = () => {
                    searchInput.value = capitalizedWord;
                    handleSearch();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                trendingTopicsContainer.appendChild(topicElement);
            });
        }

        function renderSubCategories(category) {
            const subs = subCategoriesMap[category];
            if (subs && subs.length > 0) {
                subCategoriesContainer.innerHTML = '';
                subs.forEach(sub => {
                    const subButton = document.createElement('button');
                    subButton.className = 'bg-slate-200/50 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200';
                    subButton.textContent = sub;
                    subButton.onclick = () => {
                        searchInput.value = sub;
                        handleSearch(null, sub);
                    };
                    subCategoriesContainer.appendChild(subButton);
                });
                subCategoriesWrapper.classList.remove('hidden');
            } else {
                subCategoriesWrapper.classList.add('hidden');
                subCategoriesContainer.innerHTML = '';
            }
        }

        function renderCategories() {
            categoriesContainer.innerHTML = '';
            mainCategories.forEach((category, index) => {
                const categoryButton = document.createElement('button');
                categoryButton.className = `bg-slate-200/50 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`;
                categoryButton.textContent = category;
                
                categoryButton.onclick = () => {
                    const searchTerm = (category === 'Todas') ? null : category;
                    currentCategorySearch = searchTerm;
                    searchInput.value = (category === 'Todas') ? '' : category;
                    portalFilter.value = ""; 
                    handleSearch(null, searchTerm);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    if(activeCategoryButton) {
                        activeCategoryButton.classList.remove('category-active');
                    }
                    categoryButton.classList.add('category-active');
                    activeCategoryButton = categoryButton;
                    renderSubCategories(category);
                };

                if (index === 0) {
                    categoryButton.classList.add('category-active');
                    activeCategoryButton = categoryButton;
                }

                categoriesContainer.appendChild(categoryButton);
            });
        }

        function renderResults() {
            const filteredByDate = applyDateFilter(allNewsCache, currentDateFilter);
            
            // Pagination logic
            const totalItems = filteredByDate.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedItems = filteredByDate.slice(startIndex, startIndex + itemsPerPage);

            resultsContainer.innerHTML = '';

            if (paginatedItems.length === 0) {
                messageState.classList.remove('hidden');
                paginationControls.classList.add('hidden');
                contentCounter.textContent = 'Nenhuma notícia encontrada.';
                return;
            }

            messageState.classList.add('hidden');
            paginatedItems.forEach(item => {
                resultsContainer.appendChild(createGoogleNewsCard(item));
            });

            contentCounter.textContent = `Exibindo ${paginatedItems.length} de ${totalItems} notícias.`;
            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            pageIndicator.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }

        function renderSavedNews() {
            savedNewsContainer.innerHTML = '';
            if (savedNews.length === 0) {
                savedNewsContainer.innerHTML = `<p class="text-sm text-center text-slate-500 dark:text-slate-400 p-4">Nenhuma notícia salva.</p>`;
                return;
            }
            savedNews.forEach(news => {
                const savedItem = document.createElement('div');
                savedItem.className = 'flex items-center justify-between gap-2 p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700';
                savedItem.innerHTML = `
                    <a href="${news.url}" target="_blank" class="text-sm text-slate-600 dark:text-slate-300 truncate" title="${news.title}">${news.title}</a>
                    <button class="remove-saved-btn flex-shrink-0" data-url="${news.url}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                `;
                savedNewsContainer.appendChild(savedItem);
            });

            document.querySelectorAll('.remove-saved-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleRemoveNews(button.dataset.url);
                });
            });
        }
        
        function createGoogleNewsCard(news) {
            const newsElement = document.createElement('div');
            newsElement.className = 'bg-white dark:bg-slate-800 border-l-4 border-orange-500 dark:border-cyan-500 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 transform hover:scale-105 transition-transform duration-300';
            
            const newsDateTime = new Date(news.timestamp);
            const newsDate = newsDateTime.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const newsTime = newsDateTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const fullDateTime = `${newsDate} às ${newsTime}`;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = news.description;
            const snippet = (tempDiv.textContent || tempDiv.innerText || "").substring(0, 150) + '...';

            const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
            const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-200 dark:bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400 dark:text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
            
            const isSaved = savedNews.some(saved => saved.url === news.url);
            const saveButtonIcon = isSaved 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>` 
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;

            const imageHTML = news.imageUrl ? `<a href="${news.url}" target="_blank" rel="noopener noreferrer"><img src="${news.imageUrl}" alt="Imagem da notícia" class="w-full h-40 object-cover rounded-lg mb-2" onerror="this.style.display='none'"></a>` : '';
            
            const searchTerm = searchInput.value.trim();
            let finalTitle = news.title;
            let finalSnippet = snippet;

            if (searchTerm) {
                const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                finalTitle = finalTitle.replace(regex, `<span class="highlight">$1</span>`);
                finalSnippet = finalSnippet.replace(regex, `<span class="highlight">$1</span>`);
            }

            const categoryHTML = `<span class="text-xs font-medium bg-slate-200 dark:bg-slate-700 text-cyan-600 dark:text-cyan-400 px-2 py-1 rounded-full">${news.category}</span>`;
            
            newsElement.innerHTML = `
                ${imageHTML}
                <div class="flex justify-between items-start">
                    <a href="${news.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 overflow-hidden">
                         <img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`">
                         <div class="truncate">
                            <p class="font-semibold text-slate-800 dark:text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p>
                        </div>
                    </a>
                    <button class="save-btn" data-url="${news.url}">${saveButtonIcon}</button>
                </div>
                 <div>
                    <a href="${news.url}" target="_blank" rel="noopener noreferrer">
                        <p class="text-slate-700 dark:text-slate-300 font-semibold leading-relaxed mb-2">${finalTitle}</p>
                    </a>
                    <p class="text-sm text-slate-500 dark:text-slate-400 leading-relaxed max-h-24 overflow-hidden">${finalSnippet}</p>
                </div>
                <div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-200 dark:border-slate-700/50">
                    <div>${categoryHTML}</div>
                    <span class="text-xs text-slate-400 dark:text-slate-500">${fullDateTime}</span>
                </div>`;

            newsElement.querySelector('.save-btn').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleSaveNews(news, e.currentTarget);
            });

            return newsElement;
        }
        
        // --- UI & EVENT HANDLERS ---
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            lastUpdatedElement.innerHTML = `<span>Atualizado às ${timeString}</span> <span class="text-slate-500/70">(auto-refresh a cada 20 min)</span>`;
        }

        function setLoading(isLoading) {
             if(isLoading) {
                searchButton.disabled = true;
                buttonText.textContent = "Buscando...";
                messageState.classList.add('hidden');
                loadingState.classList.remove('hidden');
                apiError.textContent = '';
             } else {
                searchButton.disabled = false;
                buttonText.textContent = "Buscar";
                loadingState.classList.add('hidden');
             }
        }
        
        function handleApiError(error) {
            console.error(error);
            apiError.textContent = error.message;
            resultsContainer.innerHTML = '';
            messageState.classList.remove('hidden');
            messageTitle.textContent = 'Erro na busca';
            messageText.textContent = 'Não foi possível se conectar à API. Tente novamente mais tarde.';
        }

        async function handleSearch(event, categorySearch = null) {
            let searchTerm = categorySearch !== null ? categorySearch : searchInput.value.trim();
            const portal = portalFilter.value;

            if ((searchInput.value.trim() || portal) && event?.type === 'auto-refresh') {
                return;
            }
            
            if ((!searchInput.value.trim() && !portal) || event?.type === 'auto-refresh') {
                loadInitialContent();
                return;
            }
            
            setLoading(true);
            currentPage = 1; 
            
            let finalQuery = searchTerm;
            if (portal) {
                finalQuery = `${searchTerm} site:${portal}`.trim();
            }

            try {
                const newsResults = await fetchFromGoogleNewsAPI(finalQuery);
                allNewsCache = newsResults;
                renderResults();
                updateTimestamp();

            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }
        
        function setDateFilter(filter) {
            currentDateFilter = filter;
            currentPage = 1; 

            [dateFilterToday, dateFilterYesterday].forEach(btn => {
                btn.classList.remove('date-filter-active');
                btn.classList.add('bg-slate-300/50', 'dark:bg-slate-700/50', 'hover:bg-slate-300', 'dark:hover:bg-slate-700', 'text-slate-600', 'dark:text-slate-300');
            });

            const activeBtn = {
                'hoje': dateFilterToday,
                'ontem': dateFilterYesterday,
            }[filter];

            if(activeBtn) {
                activeBtn.classList.add('date-filter-active');
                activeBtn.classList.remove('bg-slate-300/50', 'dark:bg-slate-700/50', 'hover:bg-slate-300', 'dark:hover:bg-slate-700', 'text-slate-600', 'dark:text-slate-300');
            }
            
            renderResults();
        }

        function handleThemeToggle() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons(isDark);
        }

        function updateThemeIcons(isDark) {
            if (isDark) {
                themeIconMoon.classList.remove('hidden');
                themeIconSun.classList.add('hidden');
            } else {
                themeIconMoon.classList.add('hidden');
                themeIconSun.classList.remove('hidden');
            }
        }

        function handleSaveNews(newsItem, buttonElement) {
            const isAlreadySaved = savedNews.some(item => item.url === newsItem.url);

            if (isAlreadySaved) {
                savedNews = savedNews.filter(item => item.url !== newsItem.url);
                buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
            } else {
                savedNews.push(newsItem);
                buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>`;
            }
            
            localStorage.setItem('savedNews', JSON.stringify(savedNews));
            renderSavedNews();
        }

        function handleRemoveNews(newsUrl) {
            savedNews = savedNews.filter(item => item.url !== newsUrl);
            localStorage.setItem('savedNews', JSON.stringify(savedNews));
            renderSavedNews();
            renderResults(); // Re-render main results to update save icons
        }
        
        // --- INITIAL LOAD & EVENT LISTENERS ---
        searchButton.addEventListener('click', () => handleSearch());
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') handleSearch();
        });
        portalFilter.addEventListener('change', () => handleSearch());
        
        dateFilterToday.addEventListener('click', () => setDateFilter('hoje'));
        dateFilterYesterday.addEventListener('click', () => setDateFilter('ontem'));

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderResults();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(applyDateFilter(allNewsCache, currentDateFilter).length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderResults();
            }
        });
        
        themeToggle.addEventListener('click', handleThemeToggle);

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
                updateThemeIcons(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcons(false);
            }

            const storedNews = localStorage.getItem('savedNews');
            if (storedNews) {
                savedNews = JSON.parse(storedNews);
            } 
            renderSavedNews();

            loadInitialContent();
            fetchTrendingTopics();
            renderCategories();

            setInterval(() => handleSearch({type: 'auto-refresh'}), 20 * 60 * 1000);
        });

    </script>
</body>
</html>

