<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Default Dark Mode */
        :root {
            --bg-body: #0f172a;
            --bg-container: #1e293b;
            --bg-card: #1e293b;
            --border-color: #334155;
            --text-color: #cbd5e1;
            --text-secondary: #94a3b8;
            --text-title: #e2e8f0;
            --brand-color: #06b6d4;
        }

        /* Light Mode - OTIMIZADO */
        body.light-mode {
            --bg-body: #f8fafc;
            --bg-container: #ffffff;
            --bg-card: #ffffff;
            --border-color: #e2e8f0;
            --text-color: #1e293b;
            --text-secondary: #64748b;
            --text-title: #1e293b;
            --brand-color: #0d9488;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-container); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        .loader {
            border-top-color: var(--brand-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .date-filter-active {
            background-color: var(--brand-color);
            color: #ffffff;
        }
        .category-filter-active {
            background-color: var(--brand-color) !important;
            color: #ffffff !important;
        }

        /* Applying theme colors to elements */
        body { background-color: var(--bg-body); color: var(--text-color); }
        .container-panel { background-color: var(--bg-container); border-color: var(--border-color); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .input-group { background-color: var(--bg-body); border-color: var(--border-color); }
        input, select { background-color: transparent; color: var(--text-color); }
        input::placeholder { color: var(--text-secondary); }
        .button-primary { background-color: var(--brand-color); color: #fff; }
        .button-secondary { background-color: var(--bg-body); color: var(--text-secondary); border-color: var(--border-color); }
        .news-card { background-color: var(--bg-card); border-left-color: var(--brand-color); }
        .news-card h3 { color: var(--text-title); }
        .news-card p { color: var(--text-secondary); }
        .footer-text { color: var(--text-secondary); }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-6">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.465 14.535a6.002 6.002 0 018.07 0M5.93 12.005a10.002 10.002 0 0112.14 0" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01" />
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-400 mt-2">As últimas notícias sobre os principais assuntos do Brasil.</p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2"></div>
        </header>

        <div class="sticky top-4 container-panel backdrop-blur-sm z-10 p-4 rounded-xl border-2 shadow-lg mb-8">
            <div class="flex flex-wrap items-center justify-center gap-4">
                
                <div class="flex-grow flex items-center gap-4 input-group rounded-lg p-1 border w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder="Busque por um assunto..." class="w-full bg-transparent focus:outline-none px-4 py-2">
                    
                    <select id="portalFilter" class="bg-transparent text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5">
                        <option selected value="">Todos os Portais</option>
                        <option value="g1.globo.com">G1</option>
                        <option value="uol.com.br">UOL</option>
                        <option value="folha.uol.com.br">Folha de S.Paulo</option>
                        <option value="estadao.com.br">Estadão</option>
                        <option value="r7.com">R7</option>
                        <option value="cnnbrasil.com.br">CNN Brasil</option>
                        <option value="terra.com.br">Terra</option>
                        <option value="valor.globo.com">Valor Econômico</option>
                        <option value="metropoles.com">Metrópoles</option>
                    </select>

                    <button id="searchButton" class="button-primary hover:bg-cyan-600 font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span id="buttonText">Buscar</span>
                    </button>
                    
                    <button id="clearFiltersBtn" class="p-2.5 button-secondary hover:bg-slate-700 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

            </div>

            <div class="flex flex-wrap items-center justify-center gap-2 mt-4">
                <div class="flex gap-2">
                    <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200 bg-cyan-600">Hoje</button>
                    <button id="dateFilterYesterday" class="button-secondary text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200">Ontem</button>
                </div>

                <div class="flex-grow"></div>
                
                <button id="themeToggleBtn" class="p-2.5 button-secondary rounded-lg transition-colors duration-200">
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                    </svg>
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 12a1 1 0 01-1 1h-2a1 1 0 110-2h2a1 1 0 011 1zm0-7a1 1 0 01-1 1h-2a1 1 0 110-2h2a1 1 0 011 1zm-7 0a1 1 0 01-1 1H4a1 1 0 110-2h2a1 1 0 011 1zM4.707 14.707a1 1 0 011.414 0l1.414 1.414a1 1 0 01-1.414 1.414l-1.414-1.414a1 1 0 010-1.414zm-.707-8a1 1 0 011.414 0L6.414 8.707a1 1 0 11-1.414 1.414L4 8.414a1 1 0 010-1.414zm1.414-1.414a1 1 0 010 1.414l-1.414 1.414a1 1 0 11-1.414-1.414l1.414-1.414a1 1 0 011.414 0zM17.707 4.707a1 1 0 01-1.414 0l-1.414-1.414a1 1 0 111.414-1.414l1.414 1.414a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <p id="apiError" class="text-center text-red-400 text-sm mt-3 h-4"></p>
        </div>
        
        <div class="lg:grid lg:grid-cols-12 lg:gap-8">
            <div class="lg:col-span-8 xl:col-span-9">
                <div id="loadingState" class="hidden text-center py-16">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 h-12 w-12 mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-slate-300">Buscando notícias...</h3>
                </div>

                <div id="resultsInfo" class="text-sm text-slate-500 mb-4 h-5"></div>
                
                <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
                    </main>

                <div id="paginationControls" class="hidden flex justify-center items-center gap-4 mt-8">
                    <button id="prevPageBtn" class="button-secondary font-semibold px-4 py-2 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Voltar</button>
                    <span id="pageIndicator" class="text-slate-400 text-sm font-medium"></span>
                    <button id="nextPageBtn" class="button-secondary font-semibold px-4 py-2 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Avançar</button>
                </div>
                
                <div id="messageState" class="hidden text-center py-16">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    <h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3>
                    <p id="messageText" class="text-slate-500">Tente um termo diferente.</p>
                </div>
            </div>

            <aside class="lg:col-span-4 xl:col-span-3 mt-8 lg:mt-0">
                <div class="sticky top-28 flex flex-col gap-8">
                    <div class="container-panel rounded-xl p-4 border">
                        <h2 class="text-lg font-bold text-cyan-400 mb-4">Principais Assuntos Hoje</h2>
                        <div id="trendingTopicsContainer" class="flex flex-col">
                            <div class="text-center text-slate-400 p-4">Carregando tópicos...</div>
                        </div>
                    </div>

                    <div class="container-panel rounded-xl p-4 border">
                        <h2 class="text-lg font-bold text-cyan-400 mb-4">Navegue por Editoria</h2>
                        <div id="categoriesContainer" class="flex flex-wrap gap-2">
                            </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <footer class="text-center py-4 mt-8 border-t border-slate-700">
            <p class="text-sm footer-text">
                Ferramenta desenvolvida por Estratégia de Dados - 
                <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const resultsContainer = document.getElementById('resultsContainer');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const portalFilter = document.getElementById('portalFilter');
        const buttonText = document.getElementById('buttonText');
        const messageState = document.getElementById('messageState');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const loadingState = document.getElementById('loadingState');
        const apiError = document.getElementById('apiError');
        const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
        const categoriesContainer = document.getElementById('categoriesContainer');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const dateFilterToday = document.getElementById('dateFilterToday');
        const dateFilterYesterday = document.getElementById('dateFilterYesterday');
        const paginationControls = document.getElementById('paginationControls');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageIndicator = document.getElementById('pageIndicator');
        const resultsInfo = document.getElementById('resultsInfo');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');

        // App State
        let currentDateFilter = 'hoje'; 
        let activeCategory = null; 
        let allNewsCache = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        const refreshIntervalInMinutes = 20;

        // Google News RSS URLs for different categories
        const categoryFeeds = {
            'Geral': 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Mundo': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTlZJTlJ5Y0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Negócios': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTlZJTlJ5c0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Tecnologia': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTnllWjNsVm5rQmdBUklBQQA?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Esportes': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTnllWjNsWmhCY0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Ciência': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTllYWTNsZ2dBUklBQQA?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Saúde': 'https://news.google.com/rss/topics/CAAqJQgKIh9DQkFTRVFvSUFmZ0tDUXhHTi13eTNsUW9Jc0FnQVJpZ0FQAQ?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Política': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTWtxc0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Entretenimento': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHT3p3c0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Automóveis': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTjBnd0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Meio Ambiente': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHT2twc0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Justiça': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTlV3Y0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Educação': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTjB0Z0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Cultura': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHT1J0Z0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419',
            'Turismo': 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRlFvSUFmZ0tDUXhHTkVsZ0FnQVJpQVAB?hl=pt-BR&gl=BR&ceid=BR:pt-419'
        };

        // --- MAPPING HELPERS ---
        function mapGoogleNewsData(item) {
            const getSourceName = (sourceString) => {
                if (!sourceString) return 'Fonte Desconhecida';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = sourceString;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                const parts = text.split(' - ');
                return parts[parts.length - 1].trim();
            };

            let sourceDomain = 'news.google.com'; 
            try {
                if (item.sourceUrl && typeof item.sourceUrl === 'string') {
                    sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', '');
                }
            } catch (e) {
                console.error("Could not parse source URL:", item.sourceUrl, e);
            }

            return {
                source: 'googlenews',
                title: item.title,
                timestamp: new Date(item.pubDate).getTime(),
                url: item.link,
                description: item.content,
                sourceName: getSourceName(item.title),
                sourceDomain: sourceDomain
            };
        }
        
        // --- API FETCHER ---
        async function fetchFromGoogleNewsAPI(query = null) {
             const searchUrl = query 
                 ? `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`
                 : `https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419`;

             const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
             const response = await fetch(proxyUrl);
             if (!response.ok) throw new Error('Falha ao buscar notícias do Google.');
             
             const data = await response.json();
             if(!data.contents) throw new Error('Proxy não retornou conteúdo válido.');
             
             const parser = new DOMParser();
             const xmlDoc = parser.parseFromString(data.contents, "application/xml");
             const items = xmlDoc.querySelectorAll("item");
             
             const newsResults = [];
             items.forEach(item => {
                 const sourceElement = item.querySelector("source");
                 newsResults.push({
                     title: item.querySelector("title").textContent,
                     link: item.querySelector("link").textContent,
                     sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent,
                     pubDate: item.querySelector("pubDate").textContent,
                     content: item.querySelector("description").textContent
                 });
             });
             return newsResults.map(mapGoogleNewsData);
        }

        async function fetchAllCategoryNews() {
            setLoading(true);
            try {
                const promises = Object.values(categoryFeeds).map(url => 
                    fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (!data.contents) throw new Error('Proxy não retornou conteúdo válido.');
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(data.contents, "application/xml");
                            const items = xmlDoc.querySelectorAll("item");
                            const newsResults = [];
                            items.forEach(item => {
                                const sourceElement = item.querySelector("source");
                                newsResults.push({
                                    title: item.querySelector("title").textContent,
                                    link: item.querySelector("link").textContent,
                                    sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent,
                                    pubDate: item.querySelector("pubDate").textContent,
                                    content: item.querySelector("description").textContent
                                });
                            });
                            return newsResults.map(mapGoogleNewsData);
                        })
                );

                const allResults = await Promise.all(promises);
                const combinedNews = allResults.flat().sort((a, b) => b.timestamp - a.timestamp);
                
                allNewsCache = combinedNews;
                renderResults();
                updateTimestamp();
            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }

        async function fetchTrendingTopics() {
            try {
                const news = await fetchFromGoogleNewsAPI();
                
                const topics = news.slice(0, 10).map(item => {
                    const fullTitle = item.title.split(' - ')[0];
                    const words = fullTitle.split(/\s+/);
                    const truncatedTitle = words.slice(0, 4).join(' ');
                    
                    return {
                        full: fullTitle,
                        truncated: words.length > 4 ? truncatedTitle + '...' : truncatedTitle
                    };
                });
                
                renderTrendingTopics(topics);

            } catch (error) {
                console.error("Trending Topics Error:", error);
                trendingTopicsContainer.innerHTML = `<p class="text-sm text-red-400">Não foi possível carregar os tópicos.</p>`;
            }
        }

        async function loadInitialContent() {
            setLoading(true);
            try {
                await fetchAllCategoryNews();
            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }

        // --- RENDERERS & FILTERS ---
        function applyDateFilter(items, filter) {
            const todayStart = new Date(new Date().setHours(0, 0, 0, 0));

            switch (filter) {
                case 'hoje':
                    return items.filter(item => new Date(item.timestamp) >= todayStart);
                case 'ontem':
                    const yesterdayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
                    return items.filter(item => {
                        const itemDate = new Date(item.timestamp);
                        return itemDate >= yesterdayStart && itemDate < todayStart;
                    });
                default:
                    return items;
            }
        }
        
        function renderTrendingTopics(topics) {
            trendingTopicsContainer.innerHTML = '';
            topics.forEach(topic => {
                const topicElement = document.createElement('button');
                topicElement.className = 'text-left text-sm text-slate-300 p-3 hover:bg-slate-700 transition-colors duration-200 cursor-pointer w-full flex items-center gap-3 border-b border-slate-700 last:border-b-0';
                
                topicElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span class="truncate">${topic.truncated}</span>
                `;
                
                topicElement.title = topic.full;
                topicElement.onclick = () => {
                    searchInput.value = topic.full;
                    activeCategory = null; 
                    handleSearch();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                trendingTopicsContainer.appendChild(topicElement);
            });
        }

        function renderCategories() {
            const categories = Object.keys(categoryFeeds);
            
            categoriesContainer.innerHTML = '';
            categories.forEach((category) => {
                const categoryButton = document.createElement('button');
                categoryButton.textContent = category;
                
                let buttonClasses = `button-secondary text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`;
                if (activeCategory === category) {
                    buttonClasses += ' category-filter-active';
                }
                categoryButton.className = buttonClasses;

                categoryButton.onclick = () => {
                    searchInput.value = category;
                    portalFilter.value = ""; 
                    activeCategory = category;
                    handleSearch();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                categoriesContainer.appendChild(categoryButton);
            });
        }

        function renderResults() {
            const filteredByDate = applyDateFilter(allNewsCache, currentDateFilter);
            
            resultsInfo.textContent = `Encontradas ${filteredByDate.length} notícias.`;
            
            const totalItems = filteredByDate.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedItems = filteredByDate.slice(startIndex, startIndex + itemsPerPage);

            resultsContainer.innerHTML = '';

            if (paginatedItems.length === 0) {
                messageState.classList.remove('hidden');
                paginationControls.classList.add('hidden');
                messageTitle.textContent = 'Nenhum resultado para este período';
                messageText.textContent = 'Tente um termo diferente ou altere o filtro de data.';
                return;
            }

            messageState.classList.add('hidden');
            paginatedItems.forEach(item => {
                resultsContainer.appendChild(createGoogleNewsCard(item));
            });

            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            pageIndicator.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }
        
        function createGoogleNewsCard(news) {
            const newsElement = document.createElement('a');
            newsElement.href = news.url;
            newsElement.target = '_blank';
            newsElement.rel = 'noopener noreferrer';
            newsElement.className = 'news-card border-l-4 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 transform hover:scale-105 transition-transform duration-300';
            const newsDate = new Date(news.timestamp).toLocaleDateString('pt-BR');
            const newsTime = new Date(news.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = news.description;
            const snippet = tempDiv.textContent || tempDiv.innerText || "";

            const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
            const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
            
            newsElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-3 overflow-hidden">
                         <img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`">
                         <div class="truncate">
                            <p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p>
                        </div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6"></path></svg>
                </div>
                 <div>
                    <p class="text-slate-300 font-semibold leading-relaxed mb-2">${news.title}</p>
                    <p class="text-sm text-slate-400 leading-relaxed max-h-24 overflow-hidden">${snippet}</p>
                </div>
                <div class="flex items-center justify-end text-sm mt-auto pt-4 border-t border-slate-700/50">
                    <span class="text-xs text-slate-500">${newsDate} - ${newsTime}</span>
                </div>`;
            return newsElement;
        }
        
        // --- UI & EVENT HANDLERS ---
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            lastUpdatedElement.textContent = `Atualizado em ${timeString}. Próxima atualização em ${refreshIntervalInMinutes} minutos.`;
        }

        function setLoading(isLoading) {
             if(isLoading) {
                 searchButton.disabled = true;
                 buttonText.textContent = "Buscando...";
                 messageState.classList.add('hidden');
                 loadingState.classList.remove('hidden');
                 apiError.textContent = '';
             } else {
                 searchButton.disabled = false;
                 buttonText.textContent = "Buscar";
                 loadingState.classList.add('hidden');
             }
        }
        
        function handleApiError(error) {
            console.error(error);
            apiError.textContent = error.message;
            resultsContainer.innerHTML = '';
            messageState.classList.remove('hidden');
            messageTitle.textContent = 'Erro na busca';
            messageText.textContent = 'Não foi possível se conectar à API. Tente novamente mais tarde.';
        }

        async function handleSearch(event) {
            const searchTerm = searchInput.value.trim();
            const portal = portalFilter.value;

            if ((searchTerm || portal) && event?.type === 'auto-refresh') {
                return;
            }
            
            setLoading(true);
            currentPage = 1; 
            
            if (searchTerm && activeCategory && searchTerm !== activeCategory) {
                activeCategory = null;
            }
            renderCategories();

            let finalQuery = searchTerm;
            if (portal) {
                finalQuery = `${searchTerm} site:${portal}`.trim();
            }

            try {
                if (finalQuery) {
                    const newsResults = await fetchFromGoogleNewsAPI(finalQuery);
                    allNewsCache = newsResults;
                } else {
                    await fetchAllCategoryNews();
                }

                renderResults();
                updateTimestamp();

            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }
        
        function setDateFilter(filter) {
            currentDateFilter = filter;
            currentPage = 1; 

            const allDateButtons = [dateFilterToday, dateFilterYesterday];
            allDateButtons.forEach(btn => {
                btn.classList.remove('date-filter-active', 'bg-cyan-600', 'text-white');
                btn.classList.add('button-secondary');
            });

            const activeBtn = {
                'hoje': dateFilterToday,
                'ontem': dateFilterYesterday,
            }[filter];

            if(activeBtn) {
                activeBtn.classList.add('date-filter-active', 'bg-cyan-600', 'text-white');
                activeBtn.classList.remove('button-secondary');
            }
            
            renderResults();
        }
        
        function toggleClearButton() {
            if (searchInput.value.trim() !== '' || portalFilter.value !== '' || activeCategory !== null) {
                clearFiltersBtn.classList.remove('hidden');
            } else {
                clearFiltersBtn.classList.add('hidden');
            }
        }

        // --- THEME TOGGLE LOGIC ---
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            }
        }

        function toggleTheme() {
            const isLightMode = document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            moonIcon.classList.toggle('hidden', isLightMode);
            sunIcon.classList.toggle('hidden', !isLightMode);
        }
        
        // --- INITIAL LOAD & EVENT LISTENERS ---
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keyup', (event) => {
            toggleClearButton();
            if (event.key === 'Enter') handleSearch();
        });
        portalFilter.addEventListener('change', () => {
            toggleClearButton();
            handleSearch();
        });

        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            portalFilter.value = '';
            activeCategory = null;
            toggleClearButton();
            renderCategories(); 
            handleSearch();
        });
        
        dateFilterToday.addEventListener('click', () => setDateFilter('hoje'));
        dateFilterYesterday.addEventListener('click', () => setDateFilter('ontem'));

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderResults();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(applyDateFilter(allNewsCache, currentDateFilter).length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderResults();
            }
        });

        themeToggleBtn.addEventListener('click', toggleTheme);
        
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadInitialContent();
            fetchTrendingTopics();
            renderCategories();

            setInterval(() => handleSearch({type: 'auto-refresh'}), refreshIntervalInMinutes * 60 * 1000);
        });

    </script>
</body>
</html>
