<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .view-filter-active,
        .date-filter-active {
            background-color: #06b6d4 !important;
            color: #ffffff !important;
        }
        .gap-filter-active {
            background-color: #fbbf24 !important; /* amber-400 */
            color: #1e293b !important;
        }
        .category-active {
            background-color: #0891b2 !important;
            color: #ffffff !important;
            font-weight: 600;
        }
        .highlight {
            background-color: #fde047;
            color: #1e293b;
            padding: 0 2px;
            border-radius: 2px;
        }
        #toast {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        #backToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
        .category-followed {
            background-color: #334155 !important; /* slate-700 */
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.25);
        }
        #info-banner {
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        #info-banner.hidden {
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
        }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div id="info-banner" role="alert" class="hidden fixed top-5 right-5 w-80 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-50 p-4">
        <button id="close-info-banner" type="button" aria-label="Fechar dicas" class="absolute top-2 right-2 text-slate-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <h3 class="font-bold text-cyan-400 mb-2 text-base">Dicas Rápidas do Radar</h3>
        <ul class="space-y-2 text-sm text-slate-300 list-inside">
            <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <span><b>Busca Inteligente:</b> Basta digitar no campo de busca e os resultados aparecem.</span>
            </li>
            <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                <span><b>Feed 'Para Si':</b> Siga suas editorias favoritas para criar um feed personalizado.</span>
            </li>
             <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span><b>Análise Agregada:</b> Descubra o que está em alta na concorrência e compare a cobertura.</span>
            </li>
        </ul>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-6 relative">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="6" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v10l-4 4"></path>
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-400 mt-2">As últimas notícias sobre os principais assuntos do Brasil.</p>
             <p class="text-sm text-slate-500 mt-1">
                Ferramenta desenvolvida por Estratégia de Dados - 
                <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2 flex justify-center items-center gap-2"></div>
        </header>

        <div class="sticky top-4 bg-slate-800/80 backdrop-blur-sm z-10 p-4 rounded-xl border border-slate-700 shadow-lg mb-8">
            <div id="searchBarWrapper" class="flex flex-wrap items-center justify-center gap-4">
                <div class="flex-grow flex items-center gap-4 bg-slate-900 rounded-lg p-1 border border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder="Busque enquanto digita..." class="w-full bg-transparent text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-600 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span id="buttonText">Buscar</span>
                    </button>
                </div>
            </div>

            <div class="flex justify-center items-center mt-4 flex-wrap gap-x-4 gap-y-2">
                 <div class="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg">
                    <button id="viewFilterRadar" class="view-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" aria-pressed="true">Radar Geral</button>
                    <button id="viewFilterForYou" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" aria-pressed="false">Para Si</button>
                    <button id="viewFilterAggregate" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" aria-pressed="false">Conteúdo Agregado</button>
                </div>
                <div id="dateFilterContainer" class="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg">
                    <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" aria-pressed="true">Hoje</button>
                </div>
                 <div class="flex items-center gap-2">
                    <button id="refreshButton" aria-label="Atualizar notícias" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-500"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                    </button>
                    <button id="readingListBtn" aria-label="Abrir lista de leitura" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                        <span id="savedNewsCountBadge" class="absolute -top-2 -right-2 bg-cyan-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                    </button>
                </div>
            </div>
            <p id="apiError" class="text-center text-red-400 text-sm mt-3 h-4"></p>
        </div>
        
        <div id="radarContainer">
            <div class="lg:grid lg:grid-cols-10 lg:gap-8">
                <div class="lg:col-span-7">
                    <div id="contentCounter" class="text-sm text-slate-400 mb-4 h-5"></div>
                    <div class="mb-8">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <h2 class="text-lg font-bold text-cyan-400 mb-4">Navegue por Editorial</h2>
                            <div id="categoriesContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div id="subCategoriesWrapper" class="bg-slate-800 rounded-xl p-4 border border-slate-700 hidden mt-4">
                            <h2 class="text-lg font-bold text-cyan-400 mb-4">Sub-editorias</h2>
                            <div id="subCategoriesContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6"></main>
                    <div id="messageState" class="hidden text-center py-16">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        <h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3>
                        <p id="messageText" class="text-slate-500">Tente um termo diferente.</p>
                    </div>
                </div>
                <aside class="lg:col-span-3 mt-8 lg:mt-0">
                    <div class="sticky top-28 flex flex-col gap-8 overflow-y-auto max-h-[calc(100vh-8rem)] pr-2">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-cyan-400">Lista de Leitura (<span id="savedNewsCountSidebar">0</span>)</h2>
                                <div><button id="copyListBtn" class="text-xs text-cyan-400 hover:underline">Copiar Lista</button></div>
                            </div>
                            <div id="savedNewsPreviewContainer" class="space-y-2"></div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
        
        <div id="aggregateContainer" class="hidden">
            <h2 class="text-2xl font-bold text-cyan-400 mb-6 text-center">Análise de Cobertura Competitiva (Últimas 24h)</h2>
            <div id="gapAnalysisContainer" class="mb-8 bg-slate-800/50 border border-slate-700 rounded-xl p-6">
                <h3 class="text-xl font-semibold text-amber-400 mb-4">Assuntos em Destaque na Concorrência</h3>
                
                <div class="flex items-center justify-center mb-6">
                    <div class="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg">
                        <button id="filterGapsNotCovered" class="gap-filter-active text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" aria-pressed="true">Não Produzido pelo Terra</button>
                        <button id="filterGapsCovered" class="text-slate-300 hover:bg-slate-700 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" aria-pressed="false">Produzido pelo Terra</button>
                    </div>
                </div>
                <div id="gapResults"><p class="text-slate-400 text-center py-4">Clique em "Conteúdo Agregado" para iniciar a análise.</p></div>
                
                <div id="gapPaginationControls" class="flex justify-center items-center mt-6 gap-2"></div>

            </div>
            
            <h3 class="text-xl font-semibold text-cyan-400 mb-4">Conteúdo por Portal | Google News</h3>

            <div id="dashboardContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>

        </div>
    </div>
    
    <div id="readingListModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h2 class="text-lg font-bold text-cyan-400">Lista de Leitura</h2>
                <button id="closeReadingListBtn" aria-label="Fechar lista de leitura"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </header>
            <div id="savedNewsContainer" class="flex-grow p-4 overflow-y-auto space-y-2"></div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-transform duration-300">
        <p id="toastMessage"></p>
    </div>
    <button id="backToTopBtn" aria-label="Voltar ao topo" class="hidden fixed bottom-5 right-5 bg-cyan-500 hover:bg-cyan-600 text-white p-3 rounded-full shadow-lg opacity-0 transform translate-y-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
    </button>
    
    <script>
    // =================================================================================
    // CÓDIGO FINAL UNIFICADO - RADAR DE NOTÍCIAS
    // =================================================================================

    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const buttonText = document.getElementById('buttonText');
    const apiError = document.getElementById('apiError');
    const lastUpdatedElement = document.getElementById('lastUpdated');
    const refreshButton = document.getElementById('refreshButton');
    const backToTopBtn = document.getElementById('backToTopBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const searchBarWrapper = document.getElementById('searchBarWrapper');
    const radarContainer = document.getElementById('radarContainer');
    const aggregateContainer = document.getElementById('aggregateContainer');
    const viewFilterRadar = document.getElementById('viewFilterRadar');
    const viewFilterForYou = document.getElementById('viewFilterForYou');
    const viewFilterAggregate = document.getElementById('viewFilterAggregate');
    const dateFilterContainer = document.getElementById('dateFilterContainer');
    const dateFilterToday = document.getElementById('dateFilterToday');
    const resultsContainer = document.getElementById('resultsContainer');
    const messageState = document.getElementById('messageState');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const subCategoriesWrapper = document.getElementById('subCategoriesWrapper');
    const subCategoriesContainer = document.getElementById('subCategoriesContainer');
    const contentCounter = document.getElementById('contentCounter');
    const readingListBtn = document.getElementById('readingListBtn');
    const readingListModal = document.getElementById('readingListModal');
    const closeReadingListBtn = document.getElementById('closeReadingListBtn');
    const savedNewsContainer = document.getElementById('savedNewsContainer');
    const savedNewsCountBadge = document.getElementById('savedNewsCountBadge');
    const savedNewsPreviewContainer = document.getElementById('savedNewsPreviewContainer');
    const copyListBtn = document.getElementById('copyListBtn');
    const savedNewsCountSidebar = document.getElementById('savedNewsCountSidebar');
    const gapResults = document.getElementById('gapResults');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const filterGapsNotCoveredBtn = document.getElementById('filterGapsNotCovered');
    const filterGapsCoveredBtn = document.getElementById('filterGapsCovered');

    
    // --- APP STATE ---
    let currentAppView = 'radar';
    let currentRadarView = 'geral';
    let currentDateFilter = 'hoje';
    let masterNewsCache = [];
    let savedNews = [];
    let followedTopics = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let isLoadingMore = false;
    let activeCategoryButton = null;
    let currentCategorySearch = null;
    let currentGapView = 'not_covered'; // 'not_covered' ou 'covered'
    let latestAnalysisResult = { covered: [], not_covered: [] };
    let currentGapPage = 1;

    // --- CONSTANTS & CONFIGS ---
    const mainCategories = ['Todas', 'Política', 'Economia', 'Esportes', 'Cultura', 'Saúde', 'Mundo', 'Horóscopo', 'Entretenimento', 'Ciência', 'Educação', 'Viagem', 'Gastronomia', 'Carros', 'Imóveis', 'Música', 'Cinema', 'Moda', 'Meio Ambiente'];
    
    const GAPS_PER_PAGE = 20;
    const MAX_GAP_PAGES = 5;
    
const categoryKeywordsMap = {
  Política: [
    'governo','eleições','partido','lei','congresso','presidente','ministro','stf','plenário','senado','câmara','decreto','lula','bolsonaro',
    'reforma ministerial','articulação partidária','coalizão governamental','lobby político','pauta legislativa',
    'comissão especial','plano de governo','discurso parlamentar','emenda constitucional','base aliada',
    'oposição estratégica','governabilidade','promulgação de lei','agenda política','consulta pública'
  ],
  Economia: [
    'finanças','mercado','ações','inflação','juros','empresa','investimento','pib','dólar','câmbio','haddad','selic','ibovespa',
    'pacote fiscal','projeção econômica','índice de consumo','balança comercial','cenário macroeconômico',
    'política monetária','crescimento sustentável','taxa de inadimplência','crédito privado','fluxo cambial',
    'orçamento público','arrecadação tributária','risco país','planejamento financeiro','análise setorial'
  ],
  Esportes: [
    'futebol','vôlei','basquete','campeonato','atleta','time','olimpíadas','brasileirão','sul-americana','libertadores','f1','atleta','neymar','ronaldo','fórmula 1','ufc','medalha',
    'preparação física','comissão técnica','desempenho esportivo','rivalidade histórica','torcida organizada',
    'calendário esportivo','convocação oficial','treino intensivo','fair play','ranking mundial',
    'doping esportivo','estreia competitiva','título inédito','superação atlética','legado olímpico'
  ],
  Cultura: [
    'arte','exposição','teatro','livro','museu','patrimônio','bienal','concerto','literatura','peça teatral',
    'identidade cultural','expressão artística','movimento literário','tradição popular','influência estética',
    'produção autoral','crítica especializada','linguagem simbólica','manifestação folclórica','diversidade criativa',
    'curadoria temática','circuito cultural','memória coletiva','valorização regional','intercâmbio cultural'
  ],
  Saúde: [
    'bem-estar','doença','tratamento','medicina','hospital','vacina','nutrição','anvisa','oms','surto','epidemia','dengue',
    'protocolo médico','prevenção sanitária','diagnóstico precoce','campanha de vacinação','sistema de saúde',
    'alerta epidemiológico','cobertura hospitalar','plano terapêutico','vigilância sanitária','atendimento emergencial',
    'triagem clínica','saúde pública','impacto imunológico','bem-estar mental','acesso universal'
  ],
  Mundo: [
    'internacional','notícia global','conflito','acordo','guerra','diplomacia','eleição eua','biden','trump','gaza','ucrânia','onu',
    'tensão diplomática','sanção internacional','tratado bilateral','missão humanitária','crise migratória',
    'intervenção militar','panorama geopolítico','coalizão global','liderança mundial','posicionamento estratégico',
    'reunião multilateral','impacto global','ajuda externa','estabilidade regional','conflito armado'
  ],
  Horóscopo: [
    'signo','signos','astrologia','previsão','zodíaco','mapa astral','horóscopo','áries','touro','gêmeos','câncer','leão','virgem','libra','escorpião','sagitário','capricórnio','aquário','peixes','ascendente','mercúrio retrógrado','tarô','numerologia',
    'influência astral','trânsito planetário','energia cósmica','ciclo lunar','alinhamento celeste',
    'leitura espiritual','jornada zodiacal','vibração energética','conexão esotérica','revelação intuitiva',
    'mapa kármico','destino astral','orientação mística','fase planetária','despertar espiritual'
  ],
  Entretenimento: [
    'famosos','celebridade','tv','série','fofoca','evento','reality show','bbb','a fazenda','novela','premiação',
    'bastidores exclusivos','estreia bombástica','escândalo midiático','performance ao vivo','audiência recorde',
    'produção audiovisual','cobertura especial','reação dos fãs','spoiler inesperado','cena viral',
    'elenco confirmado','roteiro adaptado','evento memorável','crítica popular','participação surpresa',
    'casal do momento','flagra dos paparazzi','look do dia','red carpet','treta de famosos',
    'declaração polêmica','romance secreto','divórcio midiático','confirmação de namoro','amizade famosa',
    'transformação estética','desabafo nas redes','vídeo viral','comentário polêmico','stories bombásticos',
    'capa de revista','ensaio fotográfico','estrela teen','influenciador digital','celebridade internacional',
    'perfil verificado','nova parceria artística','making of exclusivo','briga pública','reconciliação amorosa',
    'cancelamento digital','entrevista reveladora','homenagem especial','presença vip','curiosidade dos bastidores'
  ],
  Ciência: [
    'pesquisa','descoberta','espaço','biologia','física','nasa','estudo científico','foguete','astrônomo',
    'inovação tecnológica','experimento controlado','avanço científico','hipótese testada','teoria comprovada',
    'simulação computacional','descoberta genética','publicação acadêmica','impacto ambiental','estudo interdisciplinar',
    'observação astronômica','método empírico','análise laboratorial','pesquisa aplicada','desenvolvimento sustentável'
  ],
  Educação: [
    'escola','universidade','enem','vestibular','curso','professor','mec','prouni','fies','educação básica',
    'metodologia ativa','avaliação pedagógica','formação docente','currículo escolar','inclusão educacional',
    'ambiente de aprendizagem','ensino híbrido','plataforma educacional','alfabetização digital','política educacional',
    'jornada acadêmica','capacitação profissional','gestão escolar','acesso ao conhecimento','inovação didática'
  ],
  Viagem: [
    'turismo','destino','passagem','hotel','férias','ponto turístico','roteiro','viajar','milhas',
    'experiência turística','roteiro personalizado','dica de hospedagem','aventura internacional','destino exótico',
    'viagem cultural','pacote promocional','planejamento de férias','guia local','atração imperdível',
    'transporte alternativo','turismo sustentável','descoberta regional','escapada urbana','conexão aérea'
  ],
  Gastronomia: [
    'receita','restaurante','chef','comida','bebida','culinária','gourmet','harmonização','degustação',
    'sabor autêntico','prato típico','técnica culinária','harmonização perfeita','ingrediente secreto',
    'experiência gourmet','cardápio exclusivo','tendência alimentar','cozinha autoral','preparo artesanal',
    'toque regional','apresentação criativa','textura surpreendente','aroma marcante','receita inovadora'
  ],
  Carros: [
    'automóvel','veículo','montadora','lançamento','teste','mercado automotivo','carro elétrico','ipva',
    'desempenho automotivo','tecnologia embarcada','design arrojado','consumo eficiente','segurança veicular',
    'conectividade inteligente','avaliação técnica','manutenção preventiva','inovação elétrica','mobilidade urbana',
    'modelo híbrido','conforto interno','autonomia energética','direção assistida','lançamento premium'
  ],
  Imóveis: [
    'casa','apartamento','aluguel','compra','venda','construção','mercado imobiliário','financiamento','condomínio',
    'valorização imobiliária','planta arquitetônica','projeto residencial','localização estratégica','infraestrutura urbana',
    'padrão construtivo','condomínio fechado','mercado de luxo','imóvel decorado','financiamento acessível',
    'reforma planejada','investimento patrimonial','tendência habitacional','espaço funcional','moradia sustentável'
  ],
  Música: [
    'show','festival','artista','banda','lançamento','clipe','turnê','rock in rio','lollapalooza','spotify',
    'sonoridade única','composição autoral','performance acústica','produção independente','estilo musical',
    'influência sonora','trilha envolvente','remix criativo','colaboração artística','lançamento exclusivo',
    'voz marcante','clipe visual','repertório variado','sucesso nas paradas','turnê internacional'
  ],
  Cinema: [
    'filme','estreia','crítica','ator','diretor','oscar','streaming','netflix','bilheteria','série',
    'narrativa envolvente','direção premiada','roteiro original','produção cinematográfica','atuação memorável',
    'trilha sonora','adaptação literária','crítica especializada','cena impactante','estética visual',
    'festival internacional','bilheteria recorde','bastidores revelados','estreia aguardada','elenco estelar'
  ],
  Moda: [
    'tendência','desfile','estilo','roupa','acessório','marca','spfw','estilista','coleção',
    'conceito estilístico','paleta de cores','corte moderno','textura sofisticada','tendência global',
    'inspiração vintage','look do dia','coleção cápsula','design autoral','moda consciente',
    'styling criativo','peça-chave','desfile conceitual','identidade visual','inovação têxtil'
  ],
  'Meio Ambiente': [
    'sustentabilidade','natureza','ecologia','aquecimento global','desmatamento','reciclagem','mudanças climáticas','amazônia',
    'impacto ecológico','preservação natural','biodiversidade ameaçada','ação sustentável','responsabilidade ambiental',
    'educação ecológica','iniciativa verde','recuperação florestal','gestão climática','proteção da fauna',
    'equilíbrio ambiental','recurso renovável','consciência planetária','adaptação climática','ativismo ambiental'
  ]
};
    
    const categoryColorMap = { 'Política': 'border-blue-500', 'Economia': 'border-emerald-500', 'Esportes': 'border-red-500', 'Cultura': 'border-yellow-500', 'Saúde': 'border-pink-500', 'Mundo': 'border-sky-500', 'Horóscopo': 'border-orange-500', 'Entretenimento': 'border-teal-500', 'Ciência': 'border-lime-500', 'Educação': 'border-rose-500', 'Viagem': 'border-indigo-500', 'Gastronomia': 'border-amber-500', 'Carros': 'border-slate-500', 'Imóveis': 'border-gray-500', 'Música': 'border-pink-400', 'Cinema': 'border-yellow-400', 'Moda': 'border-rose-400', 'Meio Ambiente': 'border-green-500' };
    
    const categoryButtonColors = [ 'bg-blue-600 hover:bg-blue-500', 'bg-emerald-600 hover:bg-emerald-500', 'bg-red-600 hover:bg-red-500', 'bg-yellow-600 hover:bg-yellow-500', 'bg-pink-600 hover:bg-pink-500', 'bg-sky-600 hover:bg-sky-500', 'bg-orange-600 hover:bg-orange-500', 'bg-teal-600 hover:bg-teal-500', 'bg-lime-600 hover:bg-lime-500', 'bg-rose-600 hover:bg-rose-500', 'bg-indigo-600 hover:bg-indigo-500', 'bg-amber-600 hover:bg-amber-500', 'bg-slate-600 hover:bg-slate-500', 'bg-pink-400 hover:bg-pink-300', 'bg-yellow-400 hover:bg-yellow-300', 'bg-rose-400 hover:bg-rose-300', 'bg-green-600 hover:bg-green-500' ];
    const lightBgClasses = ['bg-lime-600', 'bg-pink-400', 'bg-yellow-400'];

    // --- CORE DATA FUNCTIONS (API, Mapping) ---
    function mapGoogleNewsData(item, categoryTag = null) {
        const getSourceName = (sourceString) => { if (!sourceString) return 'Fonte Desconhecida'; const tempDiv = document.createElement('div'); tempDiv.innerHTML = sourceString; const text = tempDiv.textContent || tempDiv.innerText || ""; const parts = text.split(' - '); return parts[parts.length - 1].trim(); };
        let sourceDomain = 'news.google.com';
        try { if (item.sourceUrl && typeof item.sourceUrl === 'string') { sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', ''); } } catch (e) { console.error("Could not parse source URL:", item.sourceUrl, e); }
        
        // Lógica de classificação desativada para forçar "Geral" em tudo.
        /* --- Início do Bloco Desativado ---
        const textToAnalyze = `${item.title.toLowerCase()} ${(item.description || '').toLowerCase()}`;
        const categoryScores = {};
        mainCategories.forEach(cat => { if (cat !== 'Todas') categoryScores[cat] = 0; });
        for (const [category, keywords] of Object.entries(categoryKeywordsMap)) { for (const keyword of keywords) { if (textToAnalyze.includes(keyword)) { categoryScores[category]++; } } }
        let bestCategory = 'Geral'; 
        let maxScore = 0;
        for (const [category, score] of Object.entries(categoryScores)) { if (score > maxScore) { maxScore = score; bestCategory = category; } }
        if (maxScore === 0) { const fetchCategoryMap = { 'Negócios': 'Economia', 'Ciência e Tecnologia': 'Ciência' }; const fallbackCategory = fetchCategoryMap[categoryTag] || categoryTag; if (mainCategories.includes(fallbackCategory)) { bestCategory = fallbackCategory; } }
        --- Fim do Bloco Desativado --- */
        
        // LÓGICA SIMPLIFICADA: Classifica tudo como "Geral"
        const bestCategory = 'Geral';
        
        return { source: 'googlenews', title: item.title, timestamp: new Date(item.pubDate).getTime(), url: item.link, description: item.content, sourceName: getSourceName(item.title), sourceDomain: sourceDomain, category: bestCategory };
    }

    async function fetchFromGoogleNewsAPI(query = null) {
        const fetchAndParse = async (searchUrl, categoryTag) => {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) { console.warn(`Falha ao buscar notícias de: ${searchUrl}`); return []; }
                const textData = await response.text(); if (!textData) return [];
                const parser = new DOMParser(); const xmlDoc = parser.parseFromString(textData, "application/xml");
                const items = xmlDoc.querySelectorAll("item"); const newsResults = [];
                items.forEach(item => { const sourceElement = item.querySelector("source"); newsResults.push({ title: item.querySelector("title").textContent, link: item.querySelector("link").textContent, sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent, pubDate: item.querySelector("pubDate").textContent, description: item.querySelector("description")?.textContent }); });
                return newsResults.map(item => mapGoogleNewsData(item, categoryTag));
            } catch (error) { console.error(`Erro no fetch para ${searchUrl}:`, error); return []; }
        };
        if (query) { const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`; return fetchAndParse(searchUrl, query); }
        else { 
            const categories = ['Brasil', 'Mundo', 'Política', 'Economia', 'Negócios', 'Esportes', 'Ciência', 'Cultura', 'Entretenimento', 'Saúde', 'Educação', 'Viagem', 'Gastronomia', 'Meio Ambiente', 'Carros', 'Música', 'Cinema']; 
            let combinedNews = []; 
            for (const cat of categories) { const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(cat)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`; const newsForCat = await fetchAndParse(searchUrl, cat); combinedNews.push(...newsForCat); } const uniqueNews = new Map(); combinedNews.forEach(news => { if (!uniqueNews.has(news.url)) { uniqueNews.set(news.url, news); } }); return Array.from(uniqueNews.values()).sort((a, b) => b.timestamp - a.timestamp); }
    }

    // --- AGGREGATE VIEW FUNCTIONS ---
    async function fetchCompetitorData() {
        const competitors = { 'Terra': 'terra.com.br', 'G1': 'g1.globo.com', 'UOL': 'uol.com.br', 'CNN Brasil': 'cnnbrasil.com.br', 'Metrópoles': 'metropoles.com' };
        const allCompetitorNews = {};
        const promises = [];
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const afterDate = yesterday.toISOString().split('T')[0];
        for (const [name, domain] of Object.entries(competitors)) {
            const query = `site:${domain} after:${afterDate}`;
            const promise = fetchFromGoogleNewsAPI(query).then(news => { allCompetitorNews[name] = news.map(n => ({...n, sourceName: name})); });
            promises.push(promise);
        }
        await Promise.all(promises);
        return allCompetitorNews;
    }
    
    function analyzeCoverage(competitorNews) {
        const allArticles = Object.values(competitorNews).flat();
        const storyClusters = {};
        const stopwords = ['a', 'o', 'e', 'é', 'de', 'do', 'da', 'dos', 'das', 'em', 'no', 'na', 'nos', 'nas', 'um', 'uma', 'que', 'com', 'por', 'para', 'se', 'como', 'mas', 'foi', 'ser', 'ter', 'pelo', 'pela', 'veja', 'sobre', 'diz'];
        allArticles.forEach(article => {
            const titleWords = article.title.toLowerCase().replace(/[^\w\s]/g, '').split(' ');
            const significantWords = titleWords.filter(word => word.length > 3 && !stopwords.includes(word));
            if (significantWords.length < 2) return;
            const key = significantWords.slice(0, 2).sort().join(' '); 
            if (!storyClusters[key]) {
                storyClusters[key] = {
                    topic: article.title.split(' - ')[0],
                    articles: [],
                    latestTimestamp: 0
                };
            }
            storyClusters[key].articles.push({ title: article.title, url: article.url, source: article.sourceName });
            if (article.timestamp > storyClusters[key].latestTimestamp) {
                storyClusters[key].latestTimestamp = article.timestamp;
            }
        });
        
        const gapsNotCovered = [];
        const gapsCovered = [];

        for (const key in storyClusters) {
            const cluster = storyClusters[key];
            const sourcesInCluster = [...new Set(cluster.articles.map(a => a.source))];
            
            const isRelevant = sourcesInCluster.length >= 2;
            
            if (isRelevant) {
                const item = {
                    topic: cluster.topic,
                    coveredBy: sourcesInCluster,
                    timestamp: cluster.latestTimestamp
                };

                if (sourcesInCluster.includes('Terra')) {
                    gapsCovered.push(item);
                } else {
                    gapsNotCovered.push(item);
                }
            }
        }
        return { gapsCovered, gapsNotCovered };
    }

    function renderGapPagination(totalPages, currentPage) {
        const paginationContainer = document.getElementById('gapPaginationControls');
        paginationContainer.innerHTML = '';
        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.className = `w-8 h-8 rounded-md text-sm font-semibold transition-colors duration-200 ${
                i === currentPage 
                ? 'bg-cyan-500 text-white cursor-default' 
                : 'bg-slate-700 hover:bg-slate-600 text-slate-300'
            }`;
            pageButton.onclick = () => renderGapAnalysis(i);
            paginationContainer.appendChild(pageButton);
        }
    }

    function renderGapAnalysis(page = 1) {
        currentGapPage = page;
        gapResults.innerHTML = '';
        document.getElementById('gapPaginationControls').innerHTML = '';

        const sourceData = currentGapView === 'not_covered' 
            ? latestAnalysisResult.not_covered 
            : latestAnalysisResult.covered;

        const todayStart = new Date().setHours(0, 0, 0, 0);
        const todaysGaps = sourceData.filter(gap => gap.timestamp >= todayStart);

        todaysGaps.sort((a, b) => b.timestamp - a.timestamp);
        
        const totalItemsToPaginate = Math.min(todaysGaps.length, GAPS_PER_PAGE * MAX_GAP_PAGES);
        const gapsForDisplay = todaysGaps.slice(0, totalItemsToPaginate);

        if (gapsForDisplay.length === 0) {
            gapResults.innerHTML = `<p class="text-slate-400 text-center py-4">Nenhum assunto encontrado para este filtro hoje.</p>`;
            return;
        }

        const startIndex = (currentGapPage - 1) * GAPS_PER_PAGE;
        const endIndex = startIndex + GAPS_PER_PAGE;
        const paginatedGaps = gapsForDisplay.slice(startIndex, endIndex);

        paginatedGaps.forEach(gap => {
            const gapElement = document.createElement('div');
            const formattedTime = new Date(gap.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const borderColor = currentGapView === 'not_covered' ? 'border-amber-400' : 'border-green-500';
            const coveredByList = gap.coveredBy
                .map(source => source === 'Terra' ? `<strong class="text-slate-200">${source}</strong>` : source)
                .join(', ');
            
            gapElement.className = `bg-slate-800 p-4 rounded-lg mb-3 border-l-4 ${borderColor}`;
            gapElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="font-semibold text-slate-200 pr-4">${gap.topic}</p>
                    <span class="text-xs text-slate-500 bg-slate-700/50 px-2 py-1 rounded-md flex-shrink-0">${formattedTime}</span>
                </div>
                <p class="text-xs text-slate-500 mt-2">Coberto por: <span class="font-medium text-slate-400">${coveredByList}</span></p>
            `;
            gapResults.appendChild(gapElement);
        });

        const totalPages = Math.ceil(gapsForDisplay.length / GAPS_PER_PAGE);
        renderGapPagination(totalPages, currentGapPage);
    }

    function renderDashboard(competitorNews) {
        dashboardContainer.innerHTML = '';

        const allArticles = Object.values(competitorNews).flat();
        const sortedArticles = allArticles.sort((a, b) => b.timestamp - a.timestamp);

        if (sortedArticles.length === 0) {
            dashboardContainer.innerHTML = '<p class="text-slate-500 text-center p-4">Nenhuma notícia encontrada nas últimas 24h.</p>';
            return;
        }

        const articlesHTML = sortedArticles.map(article => {
            const faviconUrl = `https://www.google.com/s2/favicons?domain=${article.sourceName.toLowerCase().replace(' ', '')}.com.br&sz=64`;
            const defaultFallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
            const formattedDate = new Date(article.timestamp).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(',', ' -');
            
            return `
                <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="flex flex-col h-full bg-slate-800 rounded-lg hover:bg-slate-700/70 transition-transform hover:-translate-y-1 duration-300 border border-slate-700 shadow-md overflow-hidden">
                    <header class="flex items-center gap-3 p-3 border-b border-slate-700/50 bg-slate-800/50">
                        <img src="${faviconUrl}" alt="Favicon ${article.sourceName}" class="h-6 w-6 rounded-md flex-shrink-0" onerror="this.outerHTML = \`${defaultFallbackSvg}\`">
                        <span class="font-semibold text-sm text-slate-300">${article.sourceName}</span>
                    </header>
                    <main class="p-4 flex-grow">
                        <p class="text-slate-200 font-medium leading-relaxed" title="${article.title.split(' - ')[0]}">
                            ${article.title.split(' - ')[0]}
                        </p>
                    </main>
                    <footer class="p-3 mt-auto text-right">
                        <span class="text-xs text-slate-500">${formattedDate}</span>
                    </footer>
                </a>
            `;
        }).join('');

        dashboardContainer.innerHTML = articlesHTML;
    }


    // --- RADAR VIEW FUNCTIONS ---
    function createGoogleNewsCard(news) {
        const newsElement = document.createElement('div');
        const parentCategory = news.category.split(' > ')[0];
        const borderColorClass = categoryColorMap[parentCategory] || 'border-cyan-500';
        newsElement.className = `bg-slate-800 border-l-4 ${borderColorClass} rounded-r-lg p-5 shadow-lg flex flex-col gap-4 transform hover:scale-105 transition-transform duration-300`;
        const newsDateTime = new Date(news.timestamp);
        const newsDate = newsDateTime.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const newsTime = newsDateTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const fullDateTime = `${newsDate} às ${newsTime}`;
        const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
        const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
        const isSaved = savedNews.some(saved => saved.url === news.url);
        const saveButtonIcon = isSaved ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
        const searchTerm = searchInput.value.trim();
        let finalTitle = news.title;
        if (searchTerm) { const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); finalTitle = finalTitle.replace(regex, `<span class="highlight">$1</span>`); }
        const categoryIndex = mainCategories.indexOf(parentCategory); let categoryColorClass = 'bg-slate-700'; if (categoryIndex > 0) { categoryColorClass = categoryButtonColors[(categoryIndex - 1) % categoryButtonColors.length]; }
        const isLightBg = lightBgClasses.some(lightClass => categoryColorClass.includes(lightClass)); const categoryTextColorClass = isLightBg ? 'text-black' : 'text-white';
        const categoryHTML = `<span class="text-xs font-medium ${categoryColorClass.split(' ')[0]} ${categoryTextColorClass} px-2 py-1 rounded-full">${news.category}</span>`;
        newsElement.innerHTML = `<div class="flex justify-between items-start"><a href="${news.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 overflow-hidden"><img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`"><div class="truncate"><p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p></div></a><div class="flex items-center gap-2"><button class="save-btn" data-url="${news.url}" aria-label="Salvar notícia">${saveButtonIcon}</button></div></div><div><a href="${news.url}" target="_blank" rel="noopener noreferrer"><p class="text-slate-300 font-semibold leading-relaxed mb-2">${finalTitle}</p></a></div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50"><div>${categoryHTML}</div><span class="text-xs text-slate-500">${fullDateTime}</span></div>`;
        newsElement.querySelector('.save-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); handleSaveNews(news, e.currentTarget); });
        return newsElement;
    }
    function renderRadarResults(append = false) {
        if (!append) { 
            resultsContainer.innerHTML = ''; 
            currentPage = 1;
        }
        if (currentRadarView === 'paraSi' && followedTopics.length === 0) {
            messageState.classList.remove('hidden'); messageTitle.textContent = 'Comece a seguir tópicos!'; messageText.textContent = 'Clique nas editorias para personalizar o seu feed.';
            contentCounter.textContent = ''; resultsContainer.innerHTML = ''; return;
        }
        const applyDateFilter = (items, filter) => {
            const todayStart = new Date(new Date().setHours(0, 0, 0, 0));
            if (filter === 'hoje') return items.filter(item => new Date(item.timestamp) >= todayStart);
            return items;
        };
        let filteredNews = applyDateFilter(masterNewsCache, currentDateFilter);
        if (currentRadarView === 'paraSi') {
            filteredNews = filteredNews.filter(news => { const titleLower = news.title.toLowerCase(); const categoryLower = news.category ? news.category.toLowerCase() : ''; return followedTopics.some(topic => { const topicLower = topic.toLowerCase(); return titleLower.includes(topicLower) || categoryLower.includes(topicLower); }); });
        }
        const totalItems = filteredNews.length; 
        const startIndex = (currentPage - 1) * itemsPerPage; 
        const endIndex = startIndex + itemsPerPage; 
        const paginatedItems = filteredNews.slice(startIndex, endIndex);
        
        if (paginatedItems.length === 0 && currentPage === 1) {
            messageState.classList.remove('hidden'); messageTitle.textContent = 'Nenhuma notícia encontrada.'; messageText.textContent = currentRadarView === 'paraSi' ? 'Não foram encontrados resultados para os seus tópicos seguidos.' : 'Tente um termo diferente ou ajuste os filtros.';
            contentCounter.textContent = ''; return;
        }
        messageState.classList.add('hidden');
        paginatedItems.forEach(item => { resultsContainer.appendChild(createGoogleNewsCard(item)); });
        contentCounter.textContent = `Exibindo ${resultsContainer.children.length} de ${totalItems} notícias.`;
    }
    function renderSavedNews() {
        savedNewsContainer.innerHTML = ''; savedNewsCountSidebar.textContent = savedNews.length; savedNewsCountBadge.textContent = savedNews.length; savedNewsPreviewContainer.innerHTML = '';
        if (savedNews.length === 0) { const emptyMsg = `<p class="text-sm text-center text-slate-400 p-4">Nenhuma notícia salva.</p>`; savedNewsContainer.innerHTML = emptyMsg; savedNewsPreviewContainer.innerHTML = emptyMsg; return; }
        savedNews.forEach(news => { const savedItem = document.createElement('div'); savedItem.className = 'flex items-center justify-between gap-2 p-2 rounded-lg hover:bg-slate-700'; savedItem.innerHTML = `<a href="${news.url}" target="_blank" class="text-sm text-slate-300 truncate" title="${news.title}">${news.title}</a><button class="remove-saved-btn flex-shrink-0" data-url="${news.url}" aria-label="Remover notícia"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; savedNewsContainer.appendChild(savedItem); });
        savedNews.slice(0, 15).forEach(news => { const savedItem = document.createElement('div'); savedItem.className = 'flex items-center justify-between gap-2 p-1 rounded-lg hover:bg-slate-700'; savedItem.innerHTML = `<a href="${news.url}" target="_blank" class="text-sm text-slate-300 truncate" title="${news.title}">${news.title}</a><button class="remove-saved-btn flex-shrink-0" data-url="${news.url}" aria-label="Remover notícia"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; savedNewsPreviewContainer.appendChild(savedItem); });
        document.querySelectorAll('.remove-saved-btn').forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); handleRemoveNews(button.dataset.url); }); });
    }
    function renderCategories() {
        categoriesContainer.innerHTML = '';
        mainCategories.forEach((category, index) => {
            const categoryButton = document.createElement('button'); const isFollowed = followedTopics.includes(category);
            if (index === 0) { categoryButton.className = `bg-slate-700/50 hover:bg-slate-700 text-slate-300 hover:text-white text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`; } else { const colorClass = categoryButtonColors[(index - 1) % categoryButtonColors.length]; const isLightBg = lightBgClasses.some(lightClass => colorClass.includes(lightClass)); const textColorClass = isLightBg ? 'text-black' : 'text-white'; categoryButton.className = `${colorClass} ${textColorClass} text-xs font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200`; }
            if (isFollowed) { categoryButton.classList.add('category-followed'); }
            categoryButton.textContent = category;
            categoryButton.onclick = () => {
                if (currentRadarView === 'paraSi' && category !== 'Todas') { toggleFollowTopic(category); } else {
                    handleSearch(null, category === 'Todas' ? null : category); window.scrollTo({ top: 0, behavior: 'smooth' });
                    if (activeCategoryButton) { activeCategoryButton.classList.remove('category-active'); }
                    categoryButton.classList.add('category-active'); activeCategoryButton = categoryButton;
                }
            };
            if (index === 0) { categoryButton.classList.add('category-active'); activeCategoryButton = categoryButton; }
            categoriesContainer.appendChild(categoryButton);
        });
    }

    // --- SHARED UI/EVENT HANDLERS ---
    function handleSaveNews(newsItem, buttonElement) {
        const isAlreadySaved = savedNews.some(item => item.url === newsItem.url);
        if (isAlreadySaved) {
            savedNews = savedNews.filter(item => item.url !== newsItem.url);
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
            showToast('Notícia removida da lista!');
        } else {
            savedNews.push(newsItem);
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>`;
            showToast('Notícia salva!');
        }
        localStorage.setItem('savedNews', JSON.stringify(savedNews));
        renderSavedNews();
    }
    function handleRemoveNews(newsUrl) {
        savedNews = savedNews.filter(item => item.url !== newsUrl);
        localStorage.setItem('savedNews', JSON.stringify(savedNews));
        renderSavedNews();
        if(currentAppView === 'radar') renderRadarResults();
        showToast('Notícia removida da lista!');
    }
    function toggleFollowTopic(topic) {
        const topicIndex = followedTopics.indexOf(topic);
        if (topicIndex > -1) {
            followedTopics.splice(topicIndex, 1);
            showToast(`Deixou de seguir "${topic}"`);
        } else {
            followedTopics.push(topic);
            showToast(`Agora segue "${topic}"`);
        }
        localStorage.setItem('followedTopics', JSON.stringify(followedTopics));
        renderCategories();
        if (currentRadarView === 'paraSi') { renderRadarResults(); }
    }
    function showToast(message) {
        toastMessage.textContent = message;
        toast.classList.remove('opacity-0', 'translate-y-20');
        toast.classList.add('opacity-100', 'translate-y-0');
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-20');
            toast.classList.remove('opacity-100', 'translate-y-0');
        }, 3000);
    }
    function updateTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        lastUpdatedElement.innerHTML = `<span>Atualizado às ${timeString}</span> <span class="text-slate-500/70">(auto-refresh a cada 20 min)</span>`;
    }
    function setLoading(isLoading, isInitialLoad = true) {
        if(isLoading) {
            searchButton.disabled = true; 
            buttonText.textContent = "Buscando..."; 
            if (isInitialLoad) {
                messageState.classList.add('hidden'); 
                resultsContainer.innerHTML = '';
                for(let i = 0; i < 6; i++) { resultsContainer.innerHTML += `<div class="bg-slate-800 border-l-4 border-slate-700 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 animate-pulse"><div class="flex justify-between items-start"><div class="flex items-center gap-3 w-1/2"><div class="w-6 h-6 rounded-md bg-slate-700"></div><div class="h-4 bg-slate-700 rounded w-full"></div></div><div class="h-6 w-12 bg-slate-700 rounded-full"></div></div><div><div class="h-5 bg-slate-700 rounded w-full mb-2"></div><div class="h-5 bg-slate-700 rounded w-3/4"></div></div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50"><div class="h-5 w-20 bg-slate-700 rounded-full"></div><div class="h-4 w-24 bg-slate-700 rounded"></div></div></div>`; }
            }
        } else {
            searchButton.disabled = false; 
            buttonText.textContent = "Buscar";
        }
    }
    async function handleSearch(queryValue, category = null) {
        setLoading(true);
        const query = category !== null ? category : queryValue;
        masterNewsCache = await fetchFromGoogleNewsAPI(query);
        setLoading(false);
        renderRadarResults();
    }

    // --- VIEW CONTROLLER ---
    function setView(view) {
        currentAppView = view;
        const buttons = [viewFilterRadar, viewFilterForYou, viewFilterAggregate];
        buttons.forEach(btn => {
            btn.classList.remove('view-filter-active');
            btn.setAttribute('aria-pressed', 'false');
        });

        if (view === 'radar') {
            radarContainer.classList.remove('hidden');
            aggregateContainer.classList.add('hidden');
            searchBarWrapper.classList.remove('hidden');
            dateFilterContainer.classList.remove('hidden');
            
            if (currentRadarView === 'geral') {
                viewFilterRadar.classList.add('view-filter-active');
                viewFilterRadar.setAttribute('aria-pressed', 'true');
            } else {
                viewFilterForYou.classList.add('view-filter-active');
                viewFilterForYou.setAttribute('aria-pressed', 'true');
            }
        } else if (view === 'aggregate') {
            radarContainer.classList.add('hidden');
            aggregateContainer.classList.remove('hidden');
            viewFilterAggregate.classList.add('view-filter-active');
            viewFilterAggregate.setAttribute('aria-pressed', 'true');
            searchBarWrapper.classList.add('hidden');
            dateFilterContainer.classList.add('hidden');
        }
    }
    
    // --- INITIALIZATION & REFRESH LOGIC ---
    async function refreshAggregateView(isAutoRefresh = false) {
        if (!isAutoRefresh) {
            gapResults.innerHTML = `<p class="text-slate-400 text-center py-4">Analisando dados dos portais...</p>`;
            document.getElementById('gapPaginationControls').innerHTML = '';
            dashboardContainer.innerHTML = `<div class="text-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-400 mx-auto"></div><p class="text-slate-400 mt-4">Buscando e organizando notícias...</p></div>`;
        }
        try {
            const competitorNews = await fetchCompetitorData();
            const analysis = analyzeCoverage(competitorNews);
            
            latestAnalysisResult = {
                covered: analysis.gapsCovered,
                not_covered: analysis.gapsNotCovered
            };
            
            renderGapAnalysis(1);
            
            renderDashboard(competitorNews);
        } catch (e) {
            gapResults.innerHTML = `<p class="text-red-500 text-center py-4">Erro ao buscar dados. Verifique a conexão ou o proxy.</p>`;
            dashboardContainer.innerHTML = '';
        }
    }
    
    async function loadInitialContent(isAutoRefresh = false) {
        if (!isAutoRefresh) {
             setLoading(true, true);
        }
        masterNewsCache = await fetchFromGoogleNewsAPI();
        if (!isAutoRefresh) {
            setLoading(false, true);
        }
        renderRadarResults();
        updateTimestamp();
    }

    async function handleAutoRefresh() {
        if (currentAppView === 'radar') {
            await loadInitialContent(true);
            showToast('Notícias do radar atualizadas.');
        } else if (currentAppView === 'aggregate') {
            await refreshAggregateView(true);
            showToast('Conteúdo agregado atualizado.');
        }
        updateTimestamp();
    }

    function debounce(func, delay = 500) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    }

    const debouncedSearch = debounce((event) => {
        handleSearch(event.target.value);
    });
    
    function manageInfoBanner() {
        const banner = document.getElementById('info-banner');
        const closeButton = document.getElementById('close-info-banner');
        
        const hideBanner = () => banner.classList.add('hidden');

        setTimeout(() => {
             banner.classList.remove('hidden');
        }, 500);

        const timer = setTimeout(hideBanner, 15000);

        closeButton.addEventListener('click', () => {
            hideBanner();
            clearTimeout(timer);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const storedNews = localStorage.getItem('savedNews');
        if (storedNews) { savedNews = JSON.parse(storedNews); }
        const storedTopics = localStorage.getItem('followedTopics');
        if (storedTopics) { followedTopics = JSON.parse(storedTopics); }
        
        renderSavedNews();
        renderCategories();
        loadInitialContent();
        
        manageInfoBanner();
        
        setInterval(handleAutoRefresh, 20 * 60 * 1000);

        // --- EVENT LISTENERS ---
        viewFilterRadar.addEventListener('click', () => { currentRadarView = 'geral'; setView('radar'); renderRadarResults(); });
        viewFilterForYou.addEventListener('click', () => { currentRadarView = 'paraSi'; setView('radar'); renderRadarResults(); });
        
        viewFilterAggregate.addEventListener('click', async () => {
            setView('aggregate');
            await refreshAggregateView(false);
        });

        searchButton.addEventListener('click', () => handleSearch(searchInput.value));
        
        searchInput.addEventListener('input', debouncedSearch);
        
        dateFilterToday.addEventListener('click', () => { 
            currentDateFilter = 'hoje'; 
            dateFilterToday.classList.add('date-filter-active');
            dateFilterToday.setAttribute('aria-pressed', 'true');
            renderRadarResults(); 
        });

        refreshButton.addEventListener('click', () => { searchInput.value = ''; loadInitialContent(); });
        readingListBtn.addEventListener('click', () => readingListModal.classList.remove('hidden'));
        closeReadingListBtn.addEventListener('click', () => readingListModal.classList.add('hidden'));
        readingListModal.addEventListener('click', (e) => { if(e.target === readingListModal) readingListModal.classList.add('hidden'); });
        
        filterGapsNotCoveredBtn.addEventListener('click', () => {
            currentGapView = 'not_covered';
            filterGapsNotCoveredBtn.classList.add('gap-filter-active');
            filterGapsCoveredBtn.classList.remove('gap-filter-active');
            filterGapsNotCoveredBtn.setAttribute('aria-pressed', 'true');
            filterGapsCoveredBtn.setAttribute('aria-pressed', 'false');
            renderGapAnalysis(1);
        });

        filterGapsCoveredBtn.addEventListener('click', () => {
            currentGapView = 'covered';
            filterGapsCoveredBtn.classList.add('gap-filter-active');
            filterGapsNotCoveredBtn.classList.remove('gap-filter-active');
            filterGapsCoveredBtn.setAttribute('aria-pressed', 'true');
            filterGapsNotCoveredBtn.setAttribute('aria-pressed', 'false');
            renderGapAnalysis(1);
        });

        window.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop > 300) {
                backToTopBtn.classList.remove('hidden', 'opacity-0', 'translate-y-20');
                backToTopBtn.classList.add('opacity-100', 'translate-y-0');
            } else {
                backToTopBtn.classList.add('opacity-0', 'translate-y-20');
                setTimeout(() => {
                    if (scrollTop <= 300) {
                        backToTopBtn.classList.add('hidden');
                    }
                }, 300);
            }
            if (currentAppView === 'radar' && clientHeight + scrollTop >= scrollHeight - 500 && !isLoadingMore) {
                const totalItems = masterNewsCache.filter(item => {
                    const todayStart = new Date(new Date().setHours(0, 0, 0, 0));
                    if (currentDateFilter === 'hoje') return new Date(item.timestamp) >= todayStart;
                    return true;
                }).length;

                if (resultsContainer.children.length < totalItems) {
                    isLoadingMore = true;
                    currentPage++;
                    renderRadarResults(true);
                    isLoadingMore = false;
                }
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    });
    </script>
</body>
</html>
