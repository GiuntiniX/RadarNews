<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .loader {
            border-top-color: #06b6d4;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .date-filter-active {
            background-color: #06b6d4 !important;
            color: #ffffff !important;
        }
        .category-active {
            background-color: #0891b2 !important; /* cyan-600 */
            color: #ffffff !important;
            font-weight: 600;
        }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-6 relative">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="6" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v10l-4 4"></path>
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-400 mt-2">As últimas notícias sobre os principais assuntos do Brasil.</p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2 flex justify-center items-center gap-2"></div>
        </header>

        <!-- Control Panel Menu -->
        <div class="sticky top-4 bg-slate-800/80 backdrop-blur-sm z-10 p-4 rounded-xl border border-slate-700 shadow-lg mb-8">
            <div class="flex flex-wrap items-center justify-center gap-4">
                
                <div class="flex-grow flex items-center gap-4 bg-slate-900 rounded-lg p-1 border border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder="Busque por um assunto..." class="w-full bg-transparent text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    
                    <select id="portalFilter" class="bg-slate-800 border border-slate-700 text-slate-300 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5">
                        <option selected value="">Todos os Portais</option>
                        <option value="g1.globo.com">G1</option>
                        <option value="uol.com.br">UOL</option>
                        <option value="folha.uol.com.br">Folha de S.Paulo</option>
                        <option value="estadao.com.br">Estadão</option>
                        <option value="r7.com">R7</option>
                        <option value="cnnbrasil.com.br">CNN Brasil</option>
                        <option value="terra.com.br">Terra</option>
                        <option value="valor.globo.com">Valor Econômico</option>
                        <option value="metropoles.com">Metrópoles</option>
                    </select>

                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-600 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span id="buttonText">Buscar</span>
                    </button>
                </div>

            </div>

            <!-- Date Filter -->
            <div class="flex justify-center items-center gap-2 mt-4">
                <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200">Hoje</button>
                <button id="dateFilterYesterday" class="text-slate-300 text-sm font-semibold px-4 py-2 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700">Ontem</button>
            </div>
            
            <p id="apiError" class="text-center text-red-400 text-sm mt-3 h-4"></p>
        </div>
        
        <!-- Main Content Area -->
        <div class="lg:grid lg:grid-cols-12 lg:gap-8">
            <div class="lg:col-span-8 xl:col-span-9">
                <div id="loadingState" class="hidden text-center py-16">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-700 h-12 w-12 mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-slate-300">Buscando notícias...</h3>
                </div>
                
                <div id="contentCounter" class="text-sm text-slate-400 mb-4 h-5"></div>

                <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
                    <!-- News will be dynamically inserted here -->
                </main>

                <!-- Pagination Controls -->
                <div id="paginationControls" class="hidden flex justify-center items-center gap-4 mt-8">
                    <button id="prevPageBtn" class="bg-slate-700/50 hover:bg-slate-700 text-slate-200 font-semibold px-4 py-2 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Voltar</button>
                    <span id="pageIndicator" class="text-slate-400 text-sm font-medium"></span>
                    <button id="nextPageBtn" class="bg-slate-700/50 hover:bg-slate-700 text-slate-200 font-semibold px-4 py-2 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Avançar</button>
                </div>
                
                <div id="messageState" class="hidden text-center py-16">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    <h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3>
                    <p id="messageText" class="text-slate-500">Tente um termo diferente.</p>
                </div>
            </div>

            <!-- Sidebar Sections -->
            <aside class="lg:col-span-4 xl:col-span-3 mt-8 lg:mt-0">
                <div class="sticky top-28 flex flex-col gap-8">
                    <!-- Trending Topics Section -->
                    <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                        <h2 class="text-lg font-bold text-cyan-400 mb-4">Nuvem de Termos de Hoje</h2>
                        <div id="trendingTopicsContainer" class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 p-2 min-h-[10rem]">
                            <div class="text-center text-slate-400 p-4">Carregando nuvem de termos...</div>
                        </div>
                    </div>

                    <!-- Categories Section -->
                    <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                        <h2 class="text-lg font-bold text-cyan-400 mb-4">Navegue por Editoria</h2>
                        <div id="categoriesContainer" class="flex flex-wrap gap-2">
                            <!-- Category buttons will be inserted here -->
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <footer class="text-center py-4 mt-8 border-t border-slate-700">
            <p class="text-sm text-slate-500">
                Ferramenta desenvolvida por Estratégia de Dados - 
                <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const resultsContainer = document.getElementById('resultsContainer');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const portalFilter = document.getElementById('portalFilter');
        const buttonText = document.getElementById('buttonText');
        const messageState = document.getElementById('messageState');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const loadingState = document.getElementById('loadingState');
        const apiError = document.getElementById('apiError');
        const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
        const categoriesContainer = document.getElementById('categoriesContainer');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const dateFilterToday = document.getElementById('dateFilterToday');
        const dateFilterYesterday = document.getElementById('dateFilterYesterday');
        const paginationControls = document.getElementById('paginationControls');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageIndicator = document.getElementById('pageIndicator');
        const contentCounter = document.getElementById('contentCounter');

        // App State
        let currentDateFilter = 'hoje'; // 'hoje', 'ontem'
        let allNewsCache = []; // Cache news to avoid re-fetching
        let currentPage = 1;
        const itemsPerPage = 20;
        let activeCategoryButton = null;

        // --- MAPPING HELPERS ---
        function mapGoogleNewsData(item) {
            const getSourceName = (sourceString) => {
                if (!sourceString) return 'Fonte Desconhecida';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = sourceString;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                const parts = text.split(' - ');
                return parts[parts.length - 1].trim();
            };

            let sourceDomain = 'news.google.com'; // A safe default
            try {
                if (item.sourceUrl && typeof item.sourceUrl === 'string') {
                    sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', '');
                }
            } catch (e) {
                console.error("Could not parse source URL:", item.sourceUrl, e);
            }

            return {
                source: 'googlenews',
                title: item.title,
                timestamp: new Date(item.pubDate).getTime(),
                url: item.link,
                description: item.content,
                sourceName: getSourceName(item.title),
                sourceDomain: sourceDomain
            };
        }
        
        // --- API FETCHER ---
        async function fetchFromGoogleNewsAPI(query = null) {
            const fetchAndParse = async (searchUrl) => {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`;
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        console.warn(`Falha ao buscar notícias de: ${searchUrl}`);
                        return [];
                    }
                    const textData = await response.text();
                    if (!textData) return [];

                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(textData, "application/xml");
                    const items = xmlDoc.querySelectorAll("item");
                    
                    const newsResults = [];
                    items.forEach(item => {
                        const sourceElement = item.querySelector("source");
                        newsResults.push({
                            title: item.querySelector("title").textContent,
                            link: item.querySelector("link").textContent,
                            sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent,
                            pubDate: item.querySelector("pubDate").textContent,
                            content: item.querySelector("description").textContent
                        });
                    });
                    return newsResults.map(mapGoogleNewsData);
                } catch (error) {
                    console.error(`Erro no fetch para ${searchUrl}:`, error);
                    return []; // Return empty array on fetch error
                }
            };

            if (query) {
                // Specific search for a term or category
                const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                return fetchAndParse(searchUrl);
            } else {
                // For "Todas", fetch multiple categories and combine them
                const categories = ['Brasil', 'Mundo', 'Negócios', 'Ciência e Tecnologia', 'Entretenimento', 'Esportes', 'Saúde'];
                let combinedNews = [];
                for (const cat of categories) {
                    const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(cat)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                    const newsForCat = await fetchAndParse(searchUrl);
                    combinedNews.push(...newsForCat);
                }

                // Deduplicate results based on the link
                const uniqueNews = new Map();
                combinedNews.forEach(news => {
                    if (!uniqueNews.has(news.url)) {
                        uniqueNews.set(news.url, news);
                    }
                });
                
                // Sort by timestamp descending to show newest first
                return Array.from(uniqueNews.values()).sort((a, b) => b.timestamp - a.timestamp);
            }
        }


        async function fetchTrendingTopics() {
            try {
                const news = await fetchFromGoogleNewsAPI();
                const todayStart = new Date(new Date().setHours(0, 0, 0, 0));
                const todayNews = news.filter(item => new Date(item.timestamp) >= todayStart);

                if (todayNews.length === 0) {
                    trendingTopicsContainer.innerHTML = `<p class="text-sm text-slate-400 text-center">Nenhuma notícia de hoje para gerar a nuvem de termos.</p>`;
                    return;
                }

                const wordFrequency = {};
                const stopwords = ['a', 'o', 'e', 'é', 'de', 'do', 'da', 'dos', 'das', 'em', 'no', 'na', 'nos', 'nas', 'um', 'uma', 'que', 'com', 'por', 'para', 'se', 'como', 'mas', 'foi', 'ser', 'ter', 'pelo', 'pela', 'seu', 'sua', 'meu', 'minha', 'num', 'à', 'ao', 'qual', 'quando', 'quem', 'são', 'você', 'ele', 'ela', 'nós', 'este', 'esta', 'isto', 'esse', 'essa', 'isso', 'já', 'ou', 'até', 'muito', 'pode', 'sobre', 'está', 'só', 'mais', 'tem', 'era', 'vai', 'pra', 'após', 'diz', 'faz', 'veja', 'ainda'];

                todayNews.forEach(item => {
                    const title = item.title.split(' - ')[0].toLowerCase().replace(/[^\w\s]/g, '');
                    const words = title.split(/\s+/);
                    
                    words.forEach(word => {
                        if (word && word.length > 3 && !stopwords.includes(word)) {
                            wordFrequency[word] = (wordFrequency[word] || 0) + 1;
                        }
                    });
                });

                const sortedKeywords = Object.entries(wordFrequency)
                    .sort(([,a],[,b]) => b - a)
                    .slice(0, 40);

                renderTrendingTopics(sortedKeywords);

            } catch (error) {
                console.error("Trending Topics Error:", error);
                trendingTopicsContainer.innerHTML = `<p class="text-sm text-red-400">Não foi possível carregar os tópicos.</p>`;
            }
        }

        async function loadInitialContent() {
            setLoading(true);
            try {
                const news = await fetchFromGoogleNewsAPI();
                allNewsCache = news;
                renderResults();
                updateTimestamp();
            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }

        // --- RENDERERS & FILTERS ---
        function applyDateFilter(items, filter) {
            const todayStart = new Date(new Date().setHours(0, 0, 0, 0));

            switch (filter) {
                case 'hoje':
                    return items.filter(item => new Date(item.timestamp) >= todayStart);
                case 'ontem':
                    const yesterdayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
                    return items.filter(item => {
                        const itemDate = new Date(item.timestamp);
                        return itemDate >= yesterdayStart && itemDate < todayStart;
                    });
                default:
                    return items;
            }
        }

        function renderTrendingTopics(topics) {
            trendingTopicsContainer.innerHTML = '';
            
            if (topics.length === 0) {
                trendingTopicsContainer.innerHTML = `<p class="text-center text-slate-400 p-4">Nenhum termo popular encontrado hoje.</p>`;
                return;
            }

            const maxFreq = topics[0][1];

            topics.forEach(([word, freq]) => {
                const topicElement = document.createElement('button');
                const ratio = freq / maxFreq;

                let sizeClass = 'text-base';
                let colorClass = 'text-slate-400';

                if (ratio > 0.7) {
                    sizeClass = 'text-3xl';
                    colorClass = 'text-cyan-400';
                } else if (ratio > 0.4) {
                    sizeClass = 'text-xl';
                    colorClass = 'text-slate-200';
                } else if (ratio > 0.2) {
                    sizeClass = 'text-lg';
                    colorClass = 'text-slate-300';
                }

                topicElement.className = `font-semibold transition-colors duration-200 ${sizeClass} ${colorClass} hover:text-orange-400`;
                const capitalizedWord = word.charAt(0).toUpperCase() + word.slice(1);
                topicElement.textContent = capitalizedWord;
                
                topicElement.onclick = () => {
                    searchInput.value = capitalizedWord;
                    handleSearch();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                trendingTopicsContainer.appendChild(topicElement);
            });
        }


        function renderCategories() {
            const categories = ['Todas', 'Política', 'Economia', 'Esportes', 'Tecnologia', 'Cultura', 'Saúde', 'Mundo', 'Horóscopo', 'Entretenimento', 'A Fazenda 2025', 'Ciência', 'Educação', 'Viagem', 'Gastronomia', 'Carros', 'Imóveis', 'Música', 'Cinema', 'Games', 'Moda', 'Meio Ambiente'];
            
            categoriesContainer.innerHTML = '';
            categories.forEach((category, index) => {
                const categoryButton = document.createElement('button');
                categoryButton.className = `bg-slate-700/50 hover:bg-slate-700 text-slate-300 hover:text-white text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`;
                categoryButton.textContent = category;
                
                categoryButton.onclick = () => {
                    const searchTerm = (category === 'Todas') ? null : category;
                    searchInput.value = (category === 'Todas') ? '' : category;
                    portalFilter.value = ""; 
                    handleSearch(null, searchTerm);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    if(activeCategoryButton) {
                        activeCategoryButton.classList.remove('category-active');
                    }
                    categoryButton.classList.add('category-active');
                    activeCategoryButton = categoryButton;
                };

                if (index === 0) {
                    categoryButton.classList.add('category-active');
                    activeCategoryButton = categoryButton;
                }

                categoriesContainer.appendChild(categoryButton);
            });
        }

        function renderResults() {
            const filteredByDate = applyDateFilter(allNewsCache, currentDateFilter);
            
            // Pagination logic
            const totalItems = filteredByDate.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedItems = filteredByDate.slice(startIndex, startIndex + itemsPerPage);

            resultsContainer.innerHTML = '';

            if (paginatedItems.length === 0) {
                messageState.classList.remove('hidden');
                paginationControls.classList.add('hidden');
                contentCounter.textContent = 'Nenhuma notícia encontrada.';
                return;
            }

            messageState.classList.add('hidden');
            paginatedItems.forEach(item => {
                resultsContainer.appendChild(createGoogleNewsCard(item));
            });

            contentCounter.textContent = `Exibindo ${paginatedItems.length} de ${totalItems} notícias.`;
            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            pageIndicator.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }
        
        function createGoogleNewsCard(news) {
            const newsElement = document.createElement('a');
            newsElement.href = news.url;
            newsElement.target = '_blank';
            newsElement.rel = 'noopener noreferrer';
            newsElement.className = 'bg-slate-800 border-l-4 border-cyan-500 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 transform hover:scale-105 transition-transform duration-300';
            
            const newsDateTime = new Date(news.timestamp);
            const newsDate = newsDateTime.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const newsTime = newsDateTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const fullDateTime = `${newsDate} às ${newsTime}`;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = news.description;
            const snippet = tempDiv.textContent || tempDiv.innerText || "";

            const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
            const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
            
            newsElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-3 overflow-hidden">
                         <img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`">
                         <div class="truncate">
                            <p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p>
                        </div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6"></path></svg>
                </div>
                 <div>
                    <p class="text-slate-300 font-semibold leading-relaxed mb-2">${news.title}</p>
                    <p class="text-sm text-slate-400 leading-relaxed max-h-24 overflow-hidden">${snippet}</p>
                </div>
                <div class="flex items-center justify-end text-sm mt-auto pt-4 border-t border-slate-700/50">
                    <span class="text-xs text-slate-500">${fullDateTime}</span>
                </div>`;
            return newsElement;
        }
        
        // --- UI & EVENT HANDLERS ---
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            lastUpdatedElement.innerHTML = `<span>Atualizado às ${timeString}</span> <span class="text-slate-500/70">(auto-refresh a cada 20 min)</span>`;
        }

        function setLoading(isLoading) {
             if(isLoading) {
                searchButton.disabled = true;
                buttonText.textContent = "Buscando...";
                messageState.classList.add('hidden');
                loadingState.classList.remove('hidden');
                apiError.textContent = '';
             } else {
                searchButton.disabled = false;
                buttonText.textContent = "Buscar";
                loadingState.classList.add('hidden');
             }
        }
        
        function handleApiError(error) {
            console.error(error);
            apiError.textContent = error.message;
            resultsContainer.innerHTML = '';
            messageState.classList.remove('hidden');
            messageTitle.textContent = 'Erro na busca';
            messageText.textContent = 'Não foi possível se conectar à API. Tente novamente mais tarde.';
        }

        async function handleSearch(event, categorySearch = null) {
            let searchTerm = categorySearch !== null ? categorySearch : searchInput.value.trim();
            const portal = portalFilter.value;

            // If it's an auto-refresh and the user has a specific search active, do nothing.
            if ((searchInput.value.trim() || portal) && event?.type === 'auto-refresh') {
                return;
            }
            
            // If it's a manual search with no terms, or an auto-refresh, load the main feed.
            if ((!searchInput.value.trim() && !portal) || event?.type === 'auto-refresh') {
                loadInitialContent();
                return;
            }
            
            setLoading(true);
            currentPage = 1; // Reset to first page on new search
            
            let finalQuery = searchTerm;
            if (portal) {
                finalQuery = `${searchTerm} site:${portal}`.trim();
            }

            try {
                const newsResults = await fetchFromGoogleNewsAPI(finalQuery);
                allNewsCache = newsResults;
                renderResults();
                updateTimestamp();

            } catch (error) {
                handleApiError(error);
            } finally {
                setLoading(false);
            }
        }
        
        function setDateFilter(filter) {
            currentDateFilter = filter;
            currentPage = 1; // Reset to first page on date change

            // Update button styles
            [dateFilterToday, dateFilterYesterday].forEach(btn => {
                btn.classList.remove('date-filter-active');
                btn.classList.add('bg-slate-700/50', 'hover:bg-slate-700', 'text-slate-300');
            });

            const activeBtn = {
                'hoje': dateFilterToday,
                'ontem': dateFilterYesterday,
            }[filter];

            if(activeBtn) {
                activeBtn.classList.add('date-filter-active');
                activeBtn.classList.remove('bg-slate-700/50', 'hover:bg-slate-700', 'text-slate-300');
            }
            
            renderResults();
        }

        
        // --- INITIAL LOAD & EVENT LISTENERS ---
        searchButton.addEventListener('click', () => handleSearch());
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') handleSearch();
        });
        portalFilter.addEventListener('change', () => handleSearch());
        
        dateFilterToday.addEventListener('click', () => setDateFilter('hoje'));
        dateFilterYesterday.addEventListener('click', () => setDateFilter('ontem'));

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderResults();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(applyDateFilter(allNewsCache, currentDateFilter).length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderResults();
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialContent();
            fetchTrendingTopics();
            renderCategories();

            // Auto-refresh every 20 minutes
            setInterval(() => handleSearch({type: 'auto-refresh'}), 20 * 60 * 1000);
        });

    </script>
</body>
</html>

