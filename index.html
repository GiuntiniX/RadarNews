<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
        }
        /* Custom scrollbar para melhor visualização */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Estilos dos botões de filtro ATIVO */
        .view-filter-active,
        .date-filter-active,
        .filter-active {
            background-color: #06b6d4 !important; /* cyan-500 */
            color: #ffffff !important;
            font-weight: 600;
        }
        /* Estilo da Categoria Ativa (Geral) */
        .category-active {
            background-color: #0891b2 !important; /* cyan-600 */
            color: #ffffff !important;
            font-weight: 600;
        }
        /* Estilo de Destaque da Busca */
        .highlight {
            background-color: #fde047;
            color: #1e293b;
            padding: 0 2px;
            border-radius: 2px;
        }
        /* Estilo para a Categoria Ativa no Dropdown de Mídia */
        .media-dropdown-active {
            background-color: #06b6d4; /* cyan-500 */
            color: #ffffff;
            font-weight: 600;
        }
        /* Animação para o Dropdown */
        .dropdown-menu {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        .dropdown-menu.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        /* Transições */
        #toast, #info-banner {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        #backToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
        /* Estilo para a Categoria Seguida (Para Si) - Reforço visual */
        .category-followed {
            background-color: #334155 !important; /* slate-700 */
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.25);
            color: #94a3b8 !important; /* slate-400 */
        }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div id="info-banner" role="alert" class="hidden fixed top-5 right-5 w-80 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-50 p-4">
        <button id="close-info-banner" type="button" aria-label="Fechar dicas" class="absolute top-2 right-2 text-slate-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <h3 class="font-bold text-cyan-400 mb-3 text-base">Navegação Principal</h3>
        <ul class="space-y-3 text-sm text-slate-300 list-inside">
            <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6" /></svg>
                <span><b>Últimas Notícias:</b> O feed principal com as notícias mais recentes de todas as fontes.</span>
            </li>
            <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                <span><b>Meu Radar:</b> Crie seu feed personalizado seguindo os assuntos que mais lhe interessam.</span>
            </li>
             <li class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 mt-0.5 text-cyan-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span><b>Cobertura da Mídia:</b> Compare quais portais estão cobrindo os principais fatos do dia.</span>
            </li>
        </ul>
    </div>
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-6 relative">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="6" stroke-opacity="0.4"></circle>
                    <circle cx="12" cy="12" r="2"></circle>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v10l-4 4"></path>
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-400 mt-2">As últimas notícias sobre os principais assuntos do Brasil.</p>
             <p class="text-sm text-slate-500 mt-1">
                Ferramenta desenvolvida por Estratégia de Dados - 
                <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2 flex justify-center items-center gap-2"></div>
        </header>

        <div class="sticky top-4 bg-slate-800/80 backdrop-blur-sm z-10 p-4 rounded-xl border border-slate-700 shadow-lg mb-8 flex flex-col gap-3">
            
            <div id="searchBarWrapper" class="flex flex-wrap items-center justify-center">
                <div class="flex-grow flex items-center bg-slate-900 rounded-lg p-1 border border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder="Busque enquanto digita..." class="w-full bg-transparent text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    <button id="clearSearchBtn" aria-label="Limpar busca" class="text-slate-500 hover:text-slate-300 transition-colors duration-200 p-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-600 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span id="buttonText">Buscar</span>
                    </button>
                </div>
            </div>

            <div class="flex justify-center">
                <div id="mainViewTabs" class="flex justify-center bg-slate-700/50 p-1 rounded-lg">
                    <button id="viewFilterRadar" class="view-filter-active text-white px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200" aria-pressed="true">Últimas Notícias</button>
                    <button id="viewFilterForYou" class="text-slate-300 hover:bg-slate-600/50 px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-1.5" aria-pressed="false">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118l-2.8-2.034c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" /></svg>
                        Meu Radar
                    </button>
                    <button id="viewFilterAggregate" class="text-slate-300 hover:bg-slate-600/50 px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200" aria-pressed="false">Cobertura da Mídia</button>
                </div>
            </div>
            
            <div id="secondaryFilters" class="flex justify-center items-center flex-wrap gap-x-4 gap-y-2 pt-2 border-t border-slate-700/50">
                <div id="dateFilterContainer" class="flex items-center gap-2 p-1 rounded-lg">
                    <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" data-date-key="hoje" aria-pressed="true">Hoje</button>
                    <button id="dateFilterLastWeek" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" data-date-key="ultima_semana" aria-pressed="false">Última Semana</button>
                </div>
                
                <div id="mediaFilterDropdown" class="relative">
                    <button id="mediaFilterButton" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2" aria-expanded="false" aria-controls="mediaDropdownMenu">
                        <span id="currentMediaLabel">Mídia: Todos</span>
                        <svg id="mediaDropdownIcon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="mediaDropdownMenu" class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-20 origin-top-right">
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg media-dropdown-active" data-media-key="todos">Todos</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="texto">Notícias 📝</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="video">Vídeo ▶️</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="podcast">Podcast 🎙️</button>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button id="refreshButton" aria-label="Atualizar notícias" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-500"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        <span>Atualizar</span>
                    </button>
                    <button id="readingListBtn" aria-label="Abrir lista de leitura" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 012 2z"></path></svg>
                        <span id="savedNewsCountBadge" class="absolute -top-2 -right-2 bg-cyan-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                    </button>
                </div>
            </div>

            <p id="apiError" class="text-center text-red-400 text-sm h-4"></p>
        </div>
        
        <div id="radarContainer">
            <div class="lg:grid lg:grid-cols-10 lg:gap-8">
                <div class="lg:col-span-7">
                    <div id="contentCounter" class="text-sm text-slate-400 mb-4 h-5"></div>
                    <div class="mb-8">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-cyan-400">Navegue por Editorial</h2>
                                <button id="clearFollowedBtn" class="hidden text-xs text-red-400 hover:text-red-300 font-semibold transition-colors duration-200">Limpar Tópicos</button>
                            </div>
                            <div id="categoriesContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6"></main>
                    <div id="messageState" class="hidden text-center py-16">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        <h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3>
                        <p id="messageText" class="text-slate-500">Tente um termo diferente.</p>
                    </div>
                </div>
                <aside class="lg:col-span-3 mt-8 lg:mt-0">
                    <div class="sticky top-28 flex flex-col gap-8 overflow-y-auto max-h-[calc(100vh-8rem)] pr-2">
                        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-cyan-400">Lista de Leitura (<span id="savedNewsCountSidebar">0</span>)</h2>
                                <div><button id="copyListBtn" class="text-xs text-cyan-400 hover:underline">Copiar Lista</button></div>
                            </div>
                            <div id="savedNewsPreviewContainer" class="space-y-2"></div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
        
        <div id="aggregateContainer" class="hidden">
            <h2 class="text-2xl font-bold text-cyan-400 mb-2 text-center">Cobertura da Mídia</h2>
            <p class="text-center text-slate-400 mb-8 max-w-3xl mx-auto">Visualize os 50 principais assuntos e a cobertura dos portais. Use o filtro para analisar a presença de cada fonte.</p>
            
            <div class="mb-6">
                <p class="text-sm font-semibold text-slate-400 mb-3 text-center">Filtrar por Fonte:</p>
                <div id="gap-source-filter-container" class="flex flex-wrap justify-center gap-2">
                    </div>
            </div>

            <div id="gap-grid-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                </div>
        </div>
        </div>
    
    <div id="readingListModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h2 class="text-lg font-bold text-cyan-400">Lista de Leitura</h2>
                <button id="closeReadingListBtn" aria-label="Fechar lista de leitura"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </header>
            <div id="savedNewsContainer" class="flex-grow p-4 overflow-y-auto space-y-2"></div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-transform duration-300">
        <p id="toastMessage"></p>
    </div>
    
    <button id="backToTopBtn" aria-label="Voltar ao topo" class="hidden fixed bottom-5 right-5 bg-cyan-500 hover:bg-cyan-600 text-white p-3 rounded-full shadow-lg opacity-0 transform translate-y-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
    </button>
    
    <script>
    // =================================================================================
    // CÓDIGO FINAL UNIFICADO
    // =================================================================================

    // --- DOM ELEMENTS (Inicialização de Variáveis) ---
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearSearchBtn = document.getElementById('clearSearchBtn'); 
    const buttonText = document.getElementById('buttonText');
    const lastUpdatedElement = document.getElementById('lastUpdated');
    const refreshButton = document.getElementById('refreshButton');
    const backToTopBtn = document.getElementById('backToTopBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const searchBarWrapper = document.getElementById('searchBarWrapper');
    const radarContainer = document.getElementById('radarContainer');
    const aggregateContainer = document.getElementById('aggregateContainer');
    const viewFilterRadar = document.getElementById('viewFilterRadar');
    const viewFilterForYou = document.getElementById('viewFilterForYou');
    const viewFilterAggregate = document.getElementById('viewFilterAggregate');
    const dateFilterContainer = document.getElementById('dateFilterContainer');
    const dateFilterToday = document.getElementById('dateFilterToday');
    const dateFilterLastWeek = document.getElementById('dateFilterLastWeek');
    const mediaFilterDropdown = document.getElementById('mediaFilterDropdown');
    const mediaFilterButton = document.getElementById('mediaFilterButton');
    const mediaDropdownMenu = document.getElementById('mediaDropdownMenu');
    const currentMediaLabel = document.getElementById('currentMediaLabel');
    const mediaDropdownIcon = document.getElementById('mediaDropdownIcon');
    const resultsContainer = document.getElementById('resultsContainer');
    const messageState = document.getElementById('messageState');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const contentCounter = document.getElementById('contentCounter');
    const readingListModal = document.getElementById('readingListModal');
    const closeReadingListBtn = document.getElementById('closeReadingListBtn');
    const savedNewsContainer = document.getElementById('savedNewsContainer');
    const savedNewsCountBadge = document.getElementById('savedNewsCountBadge');
    const savedNewsPreviewContainer = document.getElementById('savedNewsPreviewContainer');
    const copyListBtn = document.getElementById('copyListBtn');
    const savedNewsCountSidebar = document.getElementById('savedNewsCountSidebar');
    const clearFollowedBtn = document.getElementById('clearFollowedBtn');


    // --- APP STATE (Estado Global) ---
    let currentAppView = 'radar';
    let currentRadarView = 'geral';
    let currentDateFilter = 'hoje'; 
    let currentMediaFilter = 'todos'; 
    let masterNewsCache = [];
    let savedNews = [];
    let followedTopics = [];
    let currentPage = 1;
    const itemsPerPage = 20; 
    let isLoadingMore = false;
    let currentCategorySearch = null;

    // --- CONSTANTS & CONFIGS ---
    const mainCategories = ['Todas', 'Política', 'Economia', 'Esportes', 'Cultura', 'Saúde', 'Mundo', 'Horóscopo', 'Entretenimento', 'Ciência', 'Educação', 'Viagem', 'Gastronomia', 'Carros', 'Imóveis', 'Música', 'Cinema', 'Moda', 'Meio Ambiente'];
    
    const MEDIA_FORMATS = {
        'todos': { label: 'Todos', emoji: '' },
        'texto': { label: 'Notícias', emoji: '📝' },
        'video': { label: 'Vídeo', emoji: '▶️' },
        'podcast': { label: 'Podcast', emoji: '🎙️' }
    };
    
    const categoryColorMap = {
        'Todas': 'border-slate-400', 'Política': 'border-blue-500', 'Economia': 'border-emerald-500', 'Esportes': 'border-red-500', 'Cultura': 'border-yellow-500', 'Saúde': 'border-pink-500', 'Mundo': 'border-sky-500', 'Horóscopo': 'border-orange-500', 'Entretenimento': 'border-teal-500', 'Ciência': 'border-lime-500', 'Educação': 'border-rose-500', 'Viagem': 'border-indigo-500', 'Gastronomia': 'border-amber-500', 'Carros': 'border-slate-500', 'Imóveis': 'border-gray-500', 'Música': 'border-pink-400', 'Cinema': 'border-yellow-400', 'Moda': 'border-rose-400', 'Meio Ambiente': 'border-green-500'
    };
    
    const categoryButtonColors = [
        'bg-blue-600 hover:bg-blue-500', 'bg-emerald-600 hover:bg-emerald-500', 'bg-red-600 hover:bg-red-500', 'bg-yellow-600 hover:bg-yellow-500', 'bg-pink-600 hover:bg-pink-500', 'bg-sky-600 hover:bg-sky-500', 'bg-orange-600 hover:bg-orange-500', 'bg-teal-600 hover:bg-teal-500', 'bg-lime-600 hover:bg-lime-500', 'bg-rose-600 hover:bg-rose-500', 'bg-indigo-600 hover:bg-indigo-500', 'bg-amber-600 hover:bg-amber-500', 'bg-slate-600 hover:bg-slate-500', 'bg-pink-400 hover:bg-pink-300', 'bg-yellow-400 hover:bg-yellow-300', 'bg-rose-400 hover:bg-rose-300', 'bg-green-600 hover:bg-green-500' 
    ];
    const lightBgClasses = ['bg-lime-600', 'bg-pink-400', 'bg-yellow-400']; 
    
    // --- LÓGICA DE CLASSIFICAÇÃO DE MÍDIA ---
    
    function determineMediaType(title, url) {
        const titleLower = title.toLowerCase();
        const urlLower = url.toLowerCase();
        if (titleLower.includes('vídeo') || titleLower.includes('assista') || titleLower.includes('galeria') || titleLower.includes('imagens') || titleLower.includes('live') || titleLower.includes('ao vivo') || titleLower.includes('tv')) return 'video';
        if (titleLower.includes('podcast') || titleLower.includes('áudio') || titleLower.includes('ouça') || titleLower.includes('spotify') || titleLower.includes('cast')) return 'podcast';
        if (urlLower.includes('youtube.com') || urlLower.includes('vimeo.com') || urlLower.includes('/videos/') || urlLower.includes('/video/') || urlLower.includes('/tv/') || urlLower.includes('globo.com/videos/') || urlLower.includes('recordtv.r7.com') || urlLower.includes('band.com.br/videos') || urlLower.includes('uol.com.br/videos')) return 'video';
        if (urlLower.includes('soundcloud.com') || urlLower.includes('/podcasts/') || urlLower.includes('g1.globo.com/podcast') || urlLower.includes('anchor.fm')) return 'podcast';
        return 'texto';
    }

    // --- FUNÇÕES DE FETCH E MAPEAMENTO DE DADOS ---

    function mapGoogleNewsData(item, categoryTag = null) {
        const getSourceName = (sourceString) => { 
            if (!sourceString) return 'Fonte Desconhecida'; 
            const tempDiv = document.createElement('div'); 
            tempDiv.innerHTML = sourceString; 
            const text = tempDiv.textContent || tempDiv.innerText || ""; 
            const parts = text.split(' - '); 
            return parts[parts.length - 1].trim(); 
        };
        let sourceDomain = 'news.google.com';
        try { 
            if (item.sourceUrl && typeof item.sourceUrl === 'string') { 
                sourceDomain = new URL(item.sourceUrl).hostname.replace('www.', ''); 
            } 
        } catch (e) {}
        
        const bestCategory = categoryTag && categoryTag !== 'Todas' ? categoryTag : 'Geral'; 
        const mediaType = determineMediaType(item.title, item.link); 
        
        return { 
            source: 'googlenews', 
            title: item.title, 
            timestamp: new Date(item.pubDate).getTime(), 
            url: item.link, 
            description: item.content, 
            sourceName: getSourceName(item.title), 
            sourceDomain: sourceDomain, 
            category: bestCategory, 
            mediaType: mediaType 
        };
    }

    async function fetchFromGoogleNewsAPI(query = null) {
        const fetchAndParse = async (searchUrl, categoryTag) => {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) { console.warn(`Falha ao buscar notícias de: ${searchUrl}`); return []; }
                const textData = await response.text(); 
                if (!textData) return [];
                
                const parser = new DOMParser(); 
                const xmlDoc = parser.parseFromString(textData, "application/xml");
                const items = xmlDoc.querySelectorAll("item"); 
                const newsResults = [];
                
                items.forEach(item => { 
                    const sourceElement = item.querySelector("source"); 
                    newsResults.push({ 
                        title: item.querySelector("title").textContent, 
                        link: item.querySelector("link").textContent, 
                        sourceUrl: sourceElement ? sourceElement.getAttribute("url") : item.querySelector("link").textContent, 
                        pubDate: item.querySelector("pubDate").textContent, 
                        description: item.querySelector("description")?.textContent 
                    }); 
                });
                return newsResults.map(item => mapGoogleNewsData(item, categoryTag));
            } catch (error) { 
                console.error(`Erro no fetch para ${searchUrl}:`, error); 
                return []; 
            }
        };

        let combinedNews = [];

        if (query) {
            const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
            combinedNews = await fetchAndParse(searchUrl, query);
        } else { 
            const categories = ['Brasil', 'Mundo', 'Política', 'Economia', 'Esportes', 'Ciência', 'Cultura', 'Entretenimento', 'Saúde', 'Tecnologia']; 
            
            const categoryPromises = categories.map(cat => {
                const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(cat)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                return fetchAndParse(searchUrl, cat);
            });
            
            const mediaQueries = [
                'site:youtube.com "ao vivo" OR site:youtube.com "live"',
                'vídeo de notícia Brasil OR site:g1.globo.com/videos OR site:r7.com/videos OR site:band.com.br/videos OR site:uol.com.br/videos',
                'podcast OR audio OR "programa de rádio"'
            ];

            const mediaPromises = mediaQueries.map(mq => {
                const searchUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(mq)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                return fetchAndParse(searchUrl, 'Mídia Digital');
            });


            const allResults = await Promise.all([...categoryPromises, ...mediaPromises]);
            combinedNews = allResults.flat();
        }

        const uniqueNews = new Map();
        combinedNews.forEach(news => { 
            if (!uniqueNews.has(news.url)) { 
                uniqueNews.set(news.url, news); 
            } 
        }); 
        return Array.from(uniqueNews.values()).sort((a, b) => b.timestamp - a.timestamp);
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO E FILTRO ---

    function getMediaIconAndColor(mediaType) {
        return MEDIA_FORMATS[mediaType] || MEDIA_FORMATS['texto'];
    }

    function updateMediaDropdown(filterKey) {
        const mediaInfo = getMediaIconAndColor(filterKey);
        currentMediaLabel.textContent = `Mídia: ${mediaInfo.label} ${mediaInfo.emoji}`;

        mediaDropdownMenu.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('media-dropdown-active');
        });
        const activeBtn = mediaDropdownMenu.querySelector(`[data-media-key="${filterKey}"]`);
        if(activeBtn) activeBtn.classList.add('media-dropdown-active');
    }

    const applyMediaFilter = (items, filterKey) => {
        if (filterKey === 'todos') {
            return items;
        }
        return items.filter(item => item.mediaType === filterKey);
    };

    function renderRadarResults(append = false) {
        if (!append) { 
            resultsContainer.innerHTML = ''; 
            currentPage = 1;
        }
        
        let filteredNews = applyDateFilter(masterNewsCache, currentDateFilter);
        filteredNews = applyMediaFilter(filteredNews, currentMediaFilter); 

        if (currentRadarView === 'paraSi') {
            if (followedTopics.length === 0) {
                messageState.classList.remove('hidden'); messageTitle.textContent = 'Adicione seus Tópicos Favoritos!'; messageText.textContent = 'Para ver o feed "Meu Radar", selecione seus temas de interesse nas categorias abaixo.';
                contentCounter.textContent = ''; resultsContainer.innerHTML = ''; return;
            }
            filteredNews = filteredNews.filter(news => { 
                const titleLower = news.title.toLowerCase(); 
                const categoryLower = news.category ? news.category.toLowerCase() : ''; 
                return followedTopics.some(topic => { 
                    const topicLower = topic.toLowerCase(); 
                    return titleLower.includes(topicLower) || categoryLower.includes(topicLower); 
                }); 
            });
        }
        
        const totalItems = filteredNews.length; 
        const startIndex = (currentPage - 1) * itemsPerPage; 
        const endIndex = startIndex + itemsPerPage; 
        const paginatedItems = filteredNews.slice(startIndex, endIndex);
        
        if (paginatedItems.length === 0 && currentPage === 1) {
            messageState.classList.remove('hidden'); 
            messageTitle.textContent = 'Nenhuma notícia encontrada.'; 
            messageText.textContent = currentRadarView === 'paraSi' ? 'Não há resultados para seus tópicos seguidos e filtros atuais.' : 'Tente um termo diferente ou ajuste os filtros.';
            contentCounter.textContent = ''; 
            return;
        }
        
        messageState.classList.add('hidden');
        paginatedItems.forEach(item => { resultsContainer.appendChild(createGoogleNewsCard(item)); });
        contentCounter.textContent = `Exibindo ${resultsContainer.children.length} de ${totalItems} notícias.`;
        isLoadingMore = false; 
    }
    
    function createGoogleNewsCard(news) {
        const newsElement = document.createElement('div');
        const primaryCategory = news.category === 'Geral' ? 'Todas' : news.category.split(' > ')[0];
        const borderColorClass = categoryColorMap[primaryCategory] || 'border-cyan-500';
        const categoryIndex = mainCategories.indexOf(primaryCategory); 
        let categoryColorClass = 'bg-slate-700'; 
        let categoryTextColorClass = 'text-white';
        if (categoryIndex > 0) { 
            const colorClass = categoryButtonColors[(categoryIndex - 1) % categoryButtonColors.length];
            categoryColorClass = colorClass.split(' ')[0]; 
            const isLightBg = lightBgClasses.some(lightClass => colorClass.includes(lightClass)); 
            categoryTextColorClass = isLightBg ? 'text-slate-900' : 'text-white'; 
        } else if (primaryCategory === 'Todas') {
            categoryColorClass = 'bg-slate-700'; 
        }
        const newsDateTime = new Date(news.timestamp);
        const newsDate = newsDateTime.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const newsTime = newsDateTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const fullDateTime = `${newsDate} às ${newsTime}`;
        const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
        const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
        const isSaved = savedNews.some(saved => saved.url === news.url);
        const saveButtonIcon = isSaved 
            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>` 
            : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
        const searchTerm = searchInput.value.trim();
        let finalTitle = news.title;
        if (searchTerm) { 
            const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); 
            finalTitle = finalTitle.replace(regex, `<span class="highlight">$1</span>`); 
        }
        const categoryHTML = `<span class="text-xs font-medium ${categoryColorClass} ${categoryTextColorClass} px-2 py-1 rounded-full">${primaryCategory}</span>`;
        const mediaInfo = getMediaIconAndColor(news.mediaType);
        const mediaTag = `<span class="text-lg text-slate-300 ml-1" title="${mediaInfo.label}">${mediaInfo.emoji}</span>`; 
        newsElement.className = `bg-slate-800 border-l-4 ${borderColorClass} rounded-r-lg p-5 shadow-lg flex flex-col gap-4 transform hover:scale-[1.01] transition-transform duration-300`; 
        newsElement.innerHTML = `
            <div class="flex justify-between items-start">
                <a href="${news.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 overflow-hidden">
                    <img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`">
                    <div class="truncate">
                        <p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p>
                    </div>
                </a>
                <div class="flex items-center gap-2">
                    <button class="save-btn" data-url="${news.url}" aria-label="Salvar notícia">${saveButtonIcon}</button>
                </div>
            </div>
            <div>
                <a href="${news.url}" target="_blank" rel="noopener noreferrer">
                    <p class="text-slate-300 font-semibold leading-relaxed mb-2">${finalTitle} ${mediaTag}</p>
                </a>
            </div>
            <div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50">
                <div class="flex flex-wrap gap-2">
                    ${categoryHTML}
                </div>
                <span class="text-xs text-slate-500">${fullDateTime}</span>
            </div>
        `;
        newsElement.querySelector('.save-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); handleSaveNews(news, e.currentTarget); });
        return newsElement;
    }
    
    // --- LÓGICA DE INTERFACE E UTILITÁRIOS ---
    
    function handleDateFilterChange(filterKey, buttonElement) {
        currentDateFilter = filterKey;
        dateFilterContainer.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('date-filter-active');
            btn.setAttribute('aria-pressed', 'false');
            btn.classList.add('text-slate-300', 'hover:bg-slate-700');
        });
        buttonElement.classList.add('date-filter-active');
        buttonElement.classList.remove('text-slate-300', 'hover:bg-slate-700');
        buttonElement.setAttribute('aria-pressed', 'true');
        renderRadarResults();
    }
    
    const applyDateFilter = (items, filterKey) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        const filterFn = {
            'hoje': (item) => new Date(item.timestamp) >= today,
            'ultima_semana': (item) => {
                const weekAgoStart = new Date(today);
                weekAgoStart.setDate(weekAgoStart.getDate() - 7); 
                const itemDate = new Date(item.timestamp);
                return itemDate >= weekAgoStart && itemDate < today;
            }
        };
        return filterFn[filterKey] ? items.filter(filterFn[filterKey]) : items;
    };
    
    function renderSavedNews() {
        savedNewsContainer.innerHTML = ''; 
        savedNewsCountSidebar.textContent = savedNews.length; savedNewsCountBadge.textContent = savedNews.length; savedNewsPreviewContainer.innerHTML = '';
        if (savedNews.length === 0) { const emptyMsg = `<p class="text-sm text-center text-slate-400 p-4">Nenhuma notícia salva.</p>`; savedNewsContainer.innerHTML = emptyMsg; savedNewsPreviewContainer.innerHTML = emptyMsg; return; }
        
        savedNews.forEach(news => { 
            const savedItem = document.createElement('div'); 
            savedItem.className = 'flex items-center justify-between gap-2 p-2 rounded-lg hover:bg-slate-700'; 
            savedItem.innerHTML = `<a href="${news.url}" target="_blank" class="text-sm text-slate-300 truncate" title="${news.title}">${news.title}</a><button class="remove-saved-btn flex-shrink-0" data-url="${news.url}" aria-label="Remover notícia"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; 
            savedNewsContainer.appendChild(savedItem); 
        });
        
        savedNews.slice(0, 15).forEach(news => { 
            const savedItem = document.createElement('div'); 
            savedItem.className = 'flex items-center justify-between gap-2 p-1 rounded-lg hover:bg-slate-700'; 
            savedItem.innerHTML = `<a href="${news.url}" target="_blank" class="text-sm text-slate-300 truncate" title="${news.title}">${news.title}</a><button class="remove-saved-btn flex-shrink-0" data-url="${news.url}" aria-label="Remover notícia"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; 
            savedNewsPreviewContainer.appendChild(savedItem); 
        });
        
        document.querySelectorAll('.remove-saved-btn').forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); handleRemoveNews(button.dataset.url); }); });
    }
    
    function renderCategories() {
        categoriesContainer.innerHTML = '';
        clearFollowedBtn.classList.add('hidden'); 
        mainCategories.forEach((category, index) => {
            if (currentRadarView === 'paraSi' && category === 'Todas') { return; }
            
            const categoryButton = document.createElement('button');
            const isFollowed = followedTopics.includes(category);
            let buttonClass;
            
            if (currentRadarView === 'geral') {
                if (index === 0) { buttonClass = 'bg-slate-700/50 hover:bg-slate-700 text-slate-300 hover:text-white'; } 
                else {
                    const colorIndex = index - 1;
                    const colorClass = categoryButtonColors[colorIndex % categoryButtonColors.length];
                    const isLightBg = lightBgClasses.some(lightClass => colorClass.includes(lightClass));
                    const textColorClass = isLightBg ? 'text-black' : 'text-white';
                    buttonClass = `${colorClass} ${textColorClass}`;
                }
            } else { 
                const colorIndex = index > 0 ? index - 1 : 0; 
                if (isFollowed) { buttonClass = 'category-followed'; } 
                else {
                    const colorClass = categoryButtonColors[colorIndex % categoryButtonColors.length];
                    buttonClass = `${colorClass.replace('bg-', 'hover:bg-').replace('hover:bg-', 'border-')}/50 text-slate-300 hover:text-white border`; 
                }
            }
            
            categoryButton.className = `${buttonClass} text-xs font-semibold px-3 py-1.5 rounded-lg transition-all duration-200`;
            categoryButton.textContent = category;
            
            if (currentRadarView === 'geral' && (currentCategorySearch === category || (!currentCategorySearch && category === 'Todas'))) {
                categoryButton.classList.add('category-active');
            }
            
            categoryButton.onclick = () => {
                if (currentRadarView === 'paraSi') {
                    const topicIndex = followedTopics.indexOf(category);
                    if (topicIndex > -1) {
                        followedTopics.splice(topicIndex, 1);
                        showToast(`Deixou de seguir "${category}"`);
                    } else {
                        followedTopics.push(category);
                        showToast(`Agora segue "${category}"`);
                    }
                    localStorage.setItem('followedTopics', JSON.stringify(followedTopics));
                    renderCategories();
                    if (currentRadarView === 'paraSi') { renderRadarResults(); }
                } else if (currentRadarView === 'geral') {
                    handleSearch(searchInput.value, category === 'Todas' ? null : category);
                    document.querySelectorAll('#categoriesContainer button').forEach(btn => btn.classList.remove('category-active'));
                    categoryButton.classList.add('category-active');
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            categoriesContainer.appendChild(categoryButton);
        });
        if (currentRadarView === 'paraSi' && followedTopics.length > 0) {
            clearFollowedBtn.classList.remove('hidden');
        }
    }

    function showToast(message) {
        toastMessage.textContent = message;
        toast.classList.remove('opacity-0', 'translate-y-20');
        toast.classList.add('opacity-100', 'translate-y-0');
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-20');
            toast.classList.remove('opacity-100', 'translate-y-0');
        }, 3000);
    }
    
    function setLoading(isLoading, isInitialLoad = true) {
        if(isLoading) {
            searchButton.disabled = true; 
            buttonText.textContent = "Buscando..."; 
            if (isInitialLoad) {
                messageState.classList.add('hidden'); 
                resultsContainer.innerHTML = '';
                for(let i = 0; i < 6; i++) { resultsContainer.innerHTML += `<div class="bg-slate-800 border-l-4 border-slate-700 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 animate-pulse"><div class="flex justify-between items-start"><div class="flex items-center gap-3 w-1/2"><div class="w-6 h-6 rounded-md bg-slate-700"></div><div class="h-4 bg-slate-700 rounded w-full"></div></div><div class="h-6 w-12 bg-slate-700 rounded-full"></div></div><div><div class="h-5 bg-slate-700 rounded w-full mb-2"></div><div class="h-5 bg-slate-700 rounded w-3/4"></div></div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50"><div class="h-5 w-20 bg-slate-700 rounded-full"></div><div class="h-4 w-24 bg-slate-700 rounded"></div></div></div>`; }
            }
        } else {
            searchButton.disabled = false; 
            buttonText.textContent = "Buscar";
        }
    }
    
    // --- LÓGICA DE APLICAÇÃO (LOAD E EVENTOS) ---
    
    async function loadInitialContent(isAutoRefresh = false) {
        if (!isAutoRefresh) { setLoading(true, true); }
        masterNewsCache = await fetchFromGoogleNewsAPI();
        if (!isAutoRefresh) { setLoading(false, true); }
        renderRadarResults();
        updateTimestamp();
    }
    
    async function handleSearch(queryValue, category = null) {
        setLoading(true);
        currentCategorySearch = category;
        const query = category !== null ? category : queryValue;
        masterNewsCache = await fetchFromGoogleNewsAPI(query.trim() === '' ? null : query);
        setLoading(false);
        renderRadarResults();
        renderCategories(); 
    }

    function handleMediaFilterChange(filterKey) {
        currentMediaFilter = filterKey;
        updateMediaDropdown(filterKey);
        mediaDropdownMenu.classList.add('hidden');
        mediaFilterButton.setAttribute('aria-expanded', 'false');
        mediaDropdownIcon.classList.remove('rotate-180');
        renderRadarResults();
    }
    
    function updateTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        lastUpdatedElement.innerHTML = `<span>Atualizado às ${timeString}</span> <span class="text-slate-500/70">(auto-refresh a cada 20 min)</span>`;
    }

    function handleSaveNews(newsItem, buttonElement) {
        const isAlreadySaved = savedNews.some(item => item.url === newsItem.url);
        if (isAlreadySaved) {
            savedNews = savedNews.filter(item => item.url !== newsItem.url);
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
            showToast('Notícia removida da lista!');
        } else {
            savedNews.push(newsItem);
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>`;
            showToast('Notícia salva!');
        }
        localStorage.setItem('savedNews', JSON.stringify(savedNews));
        renderSavedNews();
    }
    
    function updateClearSearchButton() {
        if (searchInput.value.trim().length > 0) {
            clearSearchBtn.classList.remove('hidden');
        } else {
            clearSearchBtn.classList.add('hidden');
        }
    }
    
    function handleScroll() {
        if (currentAppView === 'radar' && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isLoadingMore) {
            const totalItems = applyMediaFilter(applyDateFilter(masterNewsCache, currentDateFilter), currentMediaFilter).length;
            if (currentPage * itemsPerPage < totalItems) {
                isLoadingMore = true;
                currentPage++;
                renderRadarResults(true); 
            }
        }
        if (window.scrollY > 300) {
            backToTopBtn.classList.remove('hidden', 'opacity-0', 'translate-y-20');
            backToTopBtn.classList.add('opacity-100', 'translate-y-0');
        } else {
            backToTopBtn.classList.add('opacity-0', 'translate-y-20');
            setTimeout(() => backToTopBtn.classList.add('hidden'), 300);
        }
    }
    
    function setView(view) {
        currentAppView = view;
        const buttons = [viewFilterRadar, viewFilterForYou, viewFilterAggregate];
        buttons.forEach(btn => {
            btn.classList.remove('view-filter-active');
            btn.classList.add('text-slate-300', 'hover:bg-slate-600/50');
            btn.setAttribute('aria-pressed', 'false');
        });

        const secondaryFilters = document.getElementById('secondaryFilters');
        
        if (view === 'radar') {
            radarContainer.classList.remove('hidden');
            aggregateContainer.classList.add('hidden');
            searchBarWrapper.style.display = 'flex';
            secondaryFilters.style.display = 'flex';
            
            if (currentRadarView === 'geral') {
                viewFilterRadar.classList.add('view-filter-active');
                viewFilterRadar.classList.remove('text-slate-300', 'hover:bg-slate-600/50');
                viewFilterRadar.setAttribute('aria-pressed', 'true');
            } else {
                viewFilterForYou.classList.add('view-filter-active');
                viewFilterForYou.classList.remove('text-slate-300', 'hover:bg-slate-600/50');
                viewFilterForYou.setAttribute('aria-pressed', 'true');
            }
            renderCategories(); 
            renderRadarResults();
        } else if (view === 'aggregate') {
            radarContainer.classList.add('hidden');
            aggregateContainer.classList.remove('hidden');
            viewFilterAggregate.classList.add('view-filter-active');
            viewFilterAggregate.classList.remove('text-slate-300', 'hover:bg-slate-600/50');
            viewFilterAggregate.setAttribute('aria-pressed', 'true');
            searchBarWrapper.style.display = 'none';
            secondaryFilters.style.display = 'none';
        }
    }

    // #################### SCRIPT PARA CONTEÚDO AGREGADO E FILTRO ####################
    function setupAggregateView() {
        const portalColors = {
            "G1": "bg-red-800", "UOL": "bg-orange-600", "Folha": "bg-blue-800", "Estadão": "bg-sky-800",
            "CNN": "bg-red-600", "R7": "bg-blue-600", "Terra": "bg-orange-800", "GE": "bg-green-700",
            "Valor": "bg-emerald-800", "Metrópoles": "bg-yellow-700", "Poder360": "bg-indigo-800", "TecMundo": "bg-purple-800"
        };
        const gapData = [
            // DADOS ATUALIZADOS E CRONOLÓGICOS
            { time: "23:05", title: "Fim de jogo no Maracanã: Flamengo vence o Bahia por 2 a 1", portals: ["GE", "UOL", "Terra"] },
            { time: "22:40", title: "Governo adia mais uma vez anúncio sobre taxação de importados", portals: ["G1", "Poder360", "Folha"] },
            { time: "22:15", title: "Bolsa de NY fecha em leve alta após dados de emprego nos EUA", portals: ["Valor", "CNN", "G1"] },
            { time: "21:50", title: "Série de sucesso da HBO é renovada para 3ª temporada", portals: ["UOL", "Metrópoles", "R7"] },
            { time: "21:20", title: "STF forma maioria para manter demarcação de terras indígenas", portals: ["G1", "Folha", "Estadão", "Poder360"] },
            { time: "20:45", title: "Anvisa aprova novo medicamento para tratamento de Alzheimer no Brasil", portals: ["G1", "UOL", "R7", "Terra"] },
            { time: "20:10", title: "Exclusivo: Delator detalha esquema de corrupção em ministério", portals: ["Metrópoles"] },
            { time: "19:30", title: "Crise na Argentina: Dólar blue atinge novo recorde histórico", portals: ["Valor", "G1", "Folha", "CNN"] },
            { time: "19:05", title: "Relatório aponta aumento de 15% no desmatamento na Amazônia", portals: ["G1", "Estadão", "Terra"] },
            { time: "18:40", title: "Vazam especificações do novo Samsung Galaxy S26", portals: ["TecMundo", "UOL"] },
            { time: "18:15", title: "Petrobras anuncia redução no preço da gasolina", portals: ["G1", "UOL", "Valor", "Folha", "CNN", "R7", "Estadão", "Terra"] },
            { time: "17:50", title: "Técnico da Seleção convoca time para amistosos de outubro", portals: ["GE", "UOL", "Terra", "G1"] },
            { time: "17:20", title: "PF mira desvio de verbas em obras no Nordeste", portals: ["G1", "Poder360", "Folha"] },
            { time: "16:55", title: "INSS: Sai 2ª parcela do 13º salário para aposentados", portals: ["G1", "UOL", "R7", "Folha"] },
            { time: "16:30", title: "Análise: Como a IA pode impactar as eleições de 2026", portals: ["Poder360", "Estadão"] },
            { time: "16:00", title: "Rock in Rio confirma nova atração internacional", portals: ["G1", "UOL", "Metrópoles", "R7"] },
            { time: "15:40", title: "Câmara inicia discussão sobre regulamentação de apostas esportivas", portals: ["G1", "Poder360", "GE", "Folha"] },
            { time: "15:15", title: "Inflação oficial (IPCA) desacelera para 0,25% em agosto", portals: ["G1", "Valor", "UOL", "Folha", "Estadão"] },
            { time: "14:50", title: "Presidente da França faz duro discurso sobre clima na ONU", portals: ["G1", "Folha", "CNN", "UOL"] },
            { time: "14:20", title: "Polícia de SP prende suspeito de liderar quadrilha de roubo de cargas", portals: ["G1", "R7", "Metrópoles", "Terra"] },
            { time: "14:00", title: "Mercado Livre anuncia novo centro de distribuição em MG", portals: ["Valor", "G1", "Folha"] },
            { time: "13:45", title: "WhatsApp libera função de editar mensagens para todos", portals: ["TecMundo", "UOL", "G1", "R7", "Terra"] },
            { time: "13:20", title: "Ministro da Fazenda se reúne com presidentes de bancos", portals: ["G1", "Valor", "Poder360", "Folha"] },
            { time: "13:00", title: "Técnico do Palmeiras, Abel Ferreira, recebe proposta da Arábia Saudita", portals: ["GE", "UOL", "Terra"] },
            { time: "12:40", title: "Morre aos 88 anos o ator brasileiro Antônio Fagundes", portals: ["G1", "UOL", "Folha", "Estadão", "R7", "Metrópoles", "Terra"] },
            { time: "12:15", title: "Previsão: Frente fria derruba temperaturas no Sudeste", portals: ["G1", "UOL", "Terra", "CNN"] },
            { time: "11:50", title: "Tesla anuncia recall de 500 mil veículos por falha nos freios", portals: ["Valor", "G1", "TecMundo", "UOL"] },
            { time: "11:30", title: "Debate sobre reforma tributária avança no Senado", portals: ["Poder360", "G1", "Folha", "Estadão"] },
            { time: "11:10", title: "Cantora Anitta lança novo clipe gravado na Colômbia", portals: ["UOL", "Metrópoles", "G1", "R7"] },
            { time: "10:45", title: "Estudo da Fiocruz aponta queda nos casos de dengue no país", portals: ["G1", "UOL", "Folha", "Terra"] },
            { time: "10:20", title: "Exclusivo: Documentos revelam lobby de empresas de energia", portals: ["Estadão", "Poder360"] },
            { time: "10:00", title: "Dólar abre em queda, cotado a R$ 5,15", portals: ["Valor", "G1", "UOL", "CNN"] },
            { time: "09:40", title: "Mega-Sena acumula e prêmio vai a R$ 80 milhões", portals: ["G1", "UOL", "R7", "Terra"] },
            { time: "09:15", title: "Guerra na Ucrânia: Rússia intensifica ataques em Kharkiv", portals: ["G1", "CNN", "Folha", "Estadão"] },
            { time: "08:50", title: "Greve de metrô em São Paulo é suspensa após acordo", portals: ["G1", "R7", "Folha", "Metrópoles"] },
            { time: "08:20", title: "Opinião: A bolha das startups de IA está prestes a estourar?", portals: ["Folha", "TecMundo", "Estadão"] },
            { time: "07:55", title: "Receita libera consulta ao 4º lote de restituição do IR", portals: ["G1", "UOL", "Valor", "R7", "Terra"] },
            { time: "07:30", title: "Acidente entre caminhões interdita trecho da Rodovia Dutra", portals: ["G1", "R7", "CNN"] },
            { time: "07:00", title: "CPI do 8/1: Depoimento de ex-ministro é marcado por bate-boca", portals: ["Poder360", "G1", "UOL", "Folha"] },
            { time: "06:30", title: "Bolsas da Ásia fecham mistas com preocupações sobre China", portals: ["Valor", "G1", "CNN"] },
            { time: "06:00", title: "Novo filme da Marvel estreia com alta aprovação da crítica", portals: ["UOL", "Metrópoles", "G1", "Terra"] },
            { time: "05:30", title: "Japão emite alerta de tsunami após terremoto de 7.1", portals: ["G1", "CNN", "UOL", "Folha"] },
            { time: "05:00", title: "Análise: A fragmentação da base do governo no Congresso", portals: ["Poder360", "Estadão", "Folha"] },
            { time: "04:30", title: "Estudo brasileiro desenvolve método para diagnóstico precoce de câncer", portals: ["G1", "Folha", "UOL"] },
            { time: "04:00", title: "F1: Verstappen lidera treinos livres para o GP do Japão", portals: ["GE", "UOL", "Terra"] },
            { time: "03:30", title: "PF deporta hacker turco procurado pela Interpol", portals: ["G1", "Metrópoles", "Poder360"] },
            { time: "03:00", title: "China lança com sucesso nova missão tripulada à sua estação espacial", portals: ["G1", "TecMundo", "CNN"] },
            { time: "02:30", title: "Ex-CEO da Americanas presta depoimento à CVM", portals: ["Valor", "G1", "Estadão"] },
            { time: "02:00", title: "Festival de Veneza premia filme iraniano com o Leão de Ouro", portals: ["UOL", "Folha", "G1"] },
            { time: "01:30", title: "Incêndio de grandes proporções atinge parque na Califórnia", portals: ["G1", "CNN", "Terra"] },
        ];

        const gridContainer = document.getElementById('gap-grid-container');
        const filterContainer = document.getElementById('gap-source-filter-container');
        
        filterContainer.innerHTML = '';
        const allButton = document.createElement('button');
        allButton.className = 'text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700 hover:bg-slate-600 filter-active';
        allButton.textContent = 'Exibir Todos';
        allButton.dataset.portal = 'todos';
        filterContainer.appendChild(allButton);

        Object.keys(portalColors).forEach(portal => {
            const button = document.createElement('button');
            const colorClass = portalColors[portal] || 'bg-slate-700';
            const hoverClass = colorClass.replace(/(\d)00/g, (match) => {
                const shade = parseInt(match);
                return `${Math.max(100, shade - 100)}`;
            }).replace('bg-', 'hover:bg-');

            button.className = `text-sm text-white font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 ${colorClass} ${hoverClass}`;
            button.textContent = portal;
            button.dataset.portal = portal;
            filterContainer.appendChild(button);
        });

        gridContainer.innerHTML = ''; 
        gapData.forEach(item => {
            const portalsHTML = item.portals.map(portal => 
                `<span class="text-xs font-semibold text-white ${portalColors[portal] || 'bg-slate-600'} px-2 py-1 rounded-full">${portal}</span>`
            ).join('');

            const itemElement = document.createElement('div');
            itemElement.className = 'bg-slate-800/60 border border-slate-700 rounded-lg p-4 flex flex-col transition-opacity duration-300';
            itemElement.dataset.portals = item.portals.join(',');
            itemElement.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-slate-300">${item.title}</p>
                    <p class="text-sm text-cyan-400 font-mono mt-1 mb-3">${item.time}</p>
                </div>
                <div class="flex flex-wrap items-center gap-2 mt-auto pt-2 border-t border-slate-700/50">
                    ${portalsHTML}
                </div>
            `;
            gridContainer.appendChild(itemElement);
        });

        filterContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const portalFilter = button.dataset.portal;
            filterContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('filter-active'));
            button.classList.add('filter-active');
            gridContainer.querySelectorAll('[data-portals]').forEach(card => {
                if (portalFilter === 'todos' || card.dataset.portals.includes(portalFilter)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        });
    }


    document.addEventListener('DOMContentLoaded', () => {
        
        // ▼▼▼ LÓGICA DO BANNER DE DICAS ▼▼▼
        const infoBanner = document.getElementById('info-banner');
        const closeInfoBannerBtn = document.getElementById('close-info-banner');
        if (infoBanner && closeInfoBannerBtn) {
            infoBanner.classList.remove('hidden');
            const bannerTimeout = setTimeout(() => {
                infoBanner.classList.add('hidden');
            }, 15000); // 15 segundos
            closeInfoBannerBtn.addEventListener('click', () => {
                clearTimeout(bannerTimeout);
                infoBanner.classList.add('hidden');
            });
        }
        // ▲▲▲ FIM DA LÓGICA DO BANNER ▲▲▲

        const storedNews = localStorage.getItem('savedNews');
        if (storedNews) { savedNews = JSON.parse(storedNews); }
        const storedTopics = localStorage.getItem('followedTopics');
        if (storedTopics) { followedTopics = JSON.parse(storedTopics); }
        
        updateMediaDropdown(currentMediaFilter);
        renderSavedNews();
        renderCategories();
        
        loadInitialContent();
        setupAggregateView();
        
        setInterval(() => {
            loadInitialContent(true);
            showToast('Notícias atualizadas automaticamente!');
        }, 20 * 60 * 1000); 

        // --- EVENT LISTENERS GERAIS ---
        
        mediaFilterButton.addEventListener('click', (e) => {
            e.stopPropagation(); 
            const isExpanded = mediaFilterButton.getAttribute('aria-expanded') === 'true';
            mediaFilterButton.setAttribute('aria-expanded', !isExpanded);
            mediaDropdownMenu.classList.toggle('hidden', isExpanded);
            mediaDropdownIcon.classList.toggle('rotate-180', !isExpanded);
        });

        mediaDropdownMenu.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', (e) => {
                handleMediaFilterChange(e.currentTarget.getAttribute('data-media-key'));
            });
        });

        document.addEventListener('click', (e) => {
            if (mediaFilterDropdown && !mediaFilterDropdown.contains(e.target)) {
                mediaDropdownMenu.classList.add('hidden');
                mediaFilterButton.setAttribute('aria-expanded', 'false');
                mediaDropdownIcon.classList.remove('rotate-180');
            }
        });

        viewFilterRadar.addEventListener('click', () => { currentRadarView = 'geral'; setView('radar'); handleSearch(searchInput.value, null); });
        viewFilterForYou.addEventListener('click', () => { currentRadarView = 'paraSi'; setView('radar'); });
        viewFilterAggregate.addEventListener('click', () => { setView('aggregate'); }); 

        searchButton.addEventListener('click', () => handleSearch(searchInput.value, null));
        
        searchInput.addEventListener('input', () => { 
            updateClearSearchButton(); 
            const debounce = (func, delay = 500) => {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            };
            debounce(() => handleSearch(searchInput.value, null), 500)();
        });
        clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; updateClearSearchButton(); handleSearch('', null); });
        
        dateFilterToday.addEventListener('click', (e) => handleDateFilterChange('hoje', e.currentTarget));
        dateFilterLastWeek.addEventListener('click', (e) => handleDateFilterChange('ultima_semana', e.currentTarget));
        refreshButton.addEventListener('click', () => { searchInput.value = ''; loadInitialContent(); });
        readingListBtn.addEventListener('click', () => readingListModal.classList.remove('hidden'));
        closeReadingListBtn.addEventListener('click', () => readingListModal.classList.add('hidden'));
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        
        document.getElementById('clearFollowedBtn').addEventListener('click', () => { 
            followedTopics = []; 
            localStorage.removeItem('followedTopics'); 
            renderCategories(); 
            renderRadarResults(); 
            showToast('Tópicos seguidos limpos.'); 
        });

        document.getElementById('copyListBtn').addEventListener('click', () => {
            const listText = savedNews.map((n, i) => `${i + 1}. [${n.title}](${n.url}) - ${n.sourceName}`).join('\n');
            navigator.clipboard.writeText(listText).then(() => showToast('Lista copiada para a área de transferência!'));
        });
        
        window.addEventListener('scroll', handleScroll);
    });
    </script>
</body>
</html>
